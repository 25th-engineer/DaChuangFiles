在/p,我们/r,学习/v,的/u,这个/r,项目/n,中/f,，/w,模型/n,主要/b,分为/v,两种/mq,状态/n,，/w,即/v,进行/v,推断/vn,用/p,的/u,inference/en,模式/n,和/c,进行/v,训练/vn,用/p,的/u,training/en,模式/n,。/w,所谓/v,推断/vn,模式/n,就是/d,已经/d,训练/vn,好/a,的/u,的/u,模型/n,，/w,我们/r,传入/v,一张/mq,图片/n,，/w,网络/n,将/d,其/r,分析/vn,结果/n,计算/v,出来/v,的/u,模式/n,。/w,本节/t,我们/r,从/p,demo/en,./w,ipynb/en,入手/v,，/w,一/m,窥/vg,已经/d,训练/vn,好/a,的/u,mask/en,-/w,rcnn/en,模型/n,如何/r,根据/p,一张/mq,输入/v,图片/n,进行/v,推断/vn,，/w,得到/v,相关/v,信息/n,，/w,即/v,inference/en,模式/n,的/u,工作/vn,原理/n,。/w,一/m,、/w,调用/v,推断/vn,网络/n,网络/n,配置/vn,首先/d,进行/v,配置/vn,设定/v,，/w,设定/v,项/q,都/d,被/p,集成/vn,进/v,class/en, ,config/en,中/f,了/u,，/w,自/p,建/v,新/a,的/u,设定/v,只要/c,基础/n,改/v,class/en,并/c,更新/v,属性/n,即可/v,，/w,在/p,demo/en,中/f,我们/r,直接/ad,使用/v,coco/en,的/u,预训练/nw,模型/n,所以/c,使用/v,其/r,设置/v,即可/v,，/w,但/c,由于/c,我们/r,想/v,检测单/nw,张/q,图片/n,，/w,所以/c,需要/v,更新/v,几/m,个/q,相关/v,数目/n,设定/v,：/w,#, ,父类/nw,继承/v,了/u,config/en,类/q,，/w,目的/n,就/d,是/v,记录/v,配置/vn,，/w,并/c,在/p,其/r,基础/n,上/f,添加/vn,了/u,几/m,个/q,新/a,的/u,属性/n, ,class/en, ,inferenceconfig/en,(/w,coco/en,./w,cococonfig/en,)/w,:/w, ,#, ,set/en, ,batch/en, ,size/en, ,to/en, ,1/m, ,since/en, ,we/en,'/w,ll/en, ,be/en, ,running/en, ,inference/en, ,on/en, ,#, ,one/en, ,image/en, ,at/en, ,a/en, ,time/en,./w, ,batch/en, ,size/en, ,=/w, ,gpu/en,_,count/en, ,*/w, ,images/en,_,per/en,_,gpu/en, ,gpu/en,_,count/en, ,=/w, ,1/m, ,images/en,_,per/en,_,gpu/en, ,=/w, ,1/m, ,config/en, ,=/w, ,inferenceconfig/en,(/w,)/w, ,config/en,./w,display/en,(/w,)/w,打印/v,出/v,配置/vn,如下/v,：/w,configurations/en,:/w, ,backbone/en, ,resnet/en,101/m, ,backbone/en,_,strides/en, ,[/w,4/m,,/w, ,8/m,,/w, ,16/m,,/w, ,32/m,,/w, ,64/m,]/w, ,batch/en,_,size/en, ,1/m, ,bbox/en,_,std/en,_,dev/en, ,[/w, ,0.1/m, ,0.1/m, ,0.2/m, ,0.2/m,]/w, ,compute/en,_,backbone/en,_,shape/en, ,none/en, ,detection/en,_,max/en,_,instances/en, ,100/m, ,detection/en,_,min/en,_,confidence/en, ,0.7/m, ,detection/en,_,nms/en,_,threshold/en, ,0.3/m, ,fpn/en,_,classif/en,_,fc/en,_,layers/en,_,size/en, ,1024/m, ,gpu/en,_,count/en, ,1/m, ,gradient/en,_,clip/en,_,norm/en, ,5.0/m, ,images/en,_,per/en,_,gpu/en, ,1/m, ,image/en,_,channel/en,_,count/en, ,3/m, ,image/en,_,max/en,_,dim/en, ,1024/m, ,image/en,_,meta/en,_,size/en, ,93/m, ,image/en,_,min/en,_,dim/en, ,800/m, ,image/en,_,min/en,_,scale/en, ,0/m, ,image/en,_,resize/en,_,mode/en, ,square/en, ,image/en,_,shape/en, ,[/w,1024/m, ,1024/m, ,3/m,]/w, ,learning/en,_,momentum/en, ,0.9/m, ,learning/en,_,rate/en, ,0.001/m, ,loss/en,_,weights/en, ,{/w,'/w,rpn/en,_,class/en,_,loss/en,'/w,:/w, ,1.0/m,,/w, ,'/w,rpn/en,_,bbox/en,_,loss/en,'/w,:/w, ,1.0/m,,/w, ,'/w,mrcnn/en,_,class/en,_,loss/en,'/w,:/w, ,1.0/m,,/w, ,'/w,mrcnn/en,_,bbox/en,_,loss/en,'/w,:/w, ,1.0/m,,/w, ,'/w,mrcnn/en,_,mask/en,_,loss/en,'/w,:/w, ,1.0/m,}/w, ,mask/en,_,pool/en,_,size/en, ,14/m, ,mask/en,_,shape/en, ,[/w,28/m,,/w, ,28/m,]/w, ,max/en,_,gt/en,_,instances/en, ,100/m, ,mean/en,_,pixel/en, ,[/w, ,123.7/m, ,116.8/m, ,103.9/m,]/w, ,mini/en,_,mask/en,_,shape/en, ,(/w,56/m,,/w, ,56/m,)/w, ,name/en, ,coco/en, ,num/en,_,classes/en, ,81/m, ,pool/en,_,size/en, ,7/m, ,post/en,_,nms/en,_,rois/en,_,inference/en, ,1000/m, ,post/en,_,nms/en,_,rois/en,_,training/en, ,2000/m, ,pre/en,_,nms/en,_,limit/en, ,6000/m, ,roi/en,_,positive/en,_,ratio/en, ,0.33/m, ,rpn/en,_,anchor/en,_,ratios/en, ,[/w,0.5/m,,/w, ,1/m,,/w, ,2/m,]/w, ,rpn/en,_,anchor/en,_,scales/en, ,(/w,32/m,,/w, ,64/m,,/w, ,128/m,,/w, ,256/m,,/w, ,512/m,)/w, ,rpn/en,_,anchor/en,_,stride/en, ,1/m, ,rpn/en,_,bbox/en,_,std/en,_,dev/en, ,[/w, ,0.1/m, ,0.1/m, ,0.2/m, ,0.2/m,]/w, ,rpn/en,_,nms/en,_,threshold/en, ,0.7/m, ,rpn/en,_,train/en,_,anchors/en,_,per/en,_,image/en, ,256/m, ,steps/en,_,per/en,_,epoch/en, ,1000/m, ,top/en,_,down/en,_,pyramid/en,_,size/en, ,256/m, ,train/en,_,bn/en, ,false/en, ,train/en,_,rois/en,_,per/en,_,image/en, ,200/m, ,use/en,_,mini/en,_,mask/en, ,true/en, ,use/en,_,rpn/en,_,rois/en, ,true/en, ,validation/en,_,steps/en, ,50/m, ,weight/en,_,decay/en, ,0.0001/m,模型/n,初始化/v,首先/d,初始化/v,模型/n,，/w,然后/c,载入/v,预训练/nw,参数/n,文件/n,，/w,在/p,末尾/n,我/r,可视化/nz,了/u,模型/n,，/w,不过/c,真的/d,太/d,长/a,了/u,，/w,所以/c,注释/vn,掉/v,了/u,。/w,在/p,第一/m,步/q,初始化/v,时/ng,就/d,会/v,根据/p,mode/en,参数/n,的/u,具体/a,值/n,建立/v,计算图/nw,，/w,本节/t,介绍/v,的/u,推断/vn,网络/n,就/d,是/v,在/p,mode/en,参数/n,设定/v,为/p,"/w,inference/en,"/w,时/ng,建立/v,的/u,计算/v,网络/n,。/w,#, ,create/en, ,model/en, ,object/en, ,in/en, ,inference/en, ,mode/en,./w, ,model/en, ,=/w, ,modellib/en,./w,maskrcnn/en,(/w,mode/en,=/w,"/w,inference/en,"/w,,/w, ,model/en,_,dir/en,=/w,model/en,_,dir/en,,/w, ,config/en,=/w,config/en,)/w, ,#, ,load/en, ,weights/en, ,trained/en, ,on/en, ,ms/en,-/w,coco/en, ,model/en,./w,load/en,_,weights/en,(/w,coco/en,_,model/en,_,path/en,,/w, ,by/en,_,name/en,=/w,true/en,)/w, ,#, ,model/en,./w,keras/en,_,model/en,./w,summary/en,(/w,)/w,检测/vn,图片/n,#, ,load/en, ,a/en, ,random/en, ,image/en, ,from/en, ,the/en, ,images/en, ,folder/en, ,file/en,_,names/en, ,=/w, ,next/en,(/w,os/en,./w,walk/en,(/w,image/en,_,dir/en,)/w,)/w,[/w,2/m,]/w, ,#, ,只要/c,是/v,迭代器/nw,调用/v,next/en,方法/n,获取/v,值/n,，/w,学习/v,了/u, ,image/en, ,=/w, ,skimage/en,./w,io/en,./w,imread/en,(/w,os/en,./w,path/en,./w,join/en,(/w,image/en,_,dir/en,,/w, ,random/en,./w,choice/en,(/w,file/en,_,names/en,)/w,)/w,)/w, ,print/en,(/w,image/en,./w,shape/en,)/w, ,#, ,run/en, ,detection/en, ,results/en, ,=/w, ,model/en,./w,detect/en,(/w,[/w,image/en,]/w,,/w, ,verbose/en,=/w,1/m,)/w, ,#, ,visualize/en, ,results/en, ,r/en, ,=/w, ,results/en,[/w,0/m,]/w, ,visualize/en,./w,display/en,_,instances/en,(/w,image/en,,/w, ,r/en,[/w,'/w,rois/en,'/w,]/w,,/w, ,r/en,[/w,'/w,masks/en,'/w,]/w,,/w, ,r/en,[/w,'/w,class/en,_,ids/en,'/w,]/w,,/w, ,class/en,_,names/en,,/w, ,r/en,[/w,'/w,scores/en,'/w,]/w,)/w,读/v,取/v,一张/mq,图片/n,，/w,调用/v,model/en,的/u,detect/en,方法/n,，/w,即/v,可/v,输出/v,结果/n,，/w,最后/f,使用/v,辅助/vn,方法/n,可视化/nz,结果/n,：/w,二/m,、/w,推断/vn,逻辑/n,概览/n,inference/en,的/u,前/f,向/p,逻辑/n,如下/v,图/n,所/u,示/vg,，/w,我们/r,简单/a,的/u,看/v,一下/m,其/r,计算/v,流程/n,是/v,怎样/r,的/u,，/w,左上/f,模块/n,为/p,以/p,resnet/en,101/m,为/p,基础/n,的/u,fpn/en,特征/n,金字塔/n,网络/n,的/u,特征/n,提取/v,逻辑/n,，/w,可以/v,看到/v,，/w,作者/n,并/c,没有/v,直接/ad,将/d,up/en,-/w,down/en,特征/n,使用/v,，/w,而是/c,又/d,做/v,了/u,一次/mq,3/m,*/w,3卷/mq,积/v,进行/v,了/u,进一步/d,的/u,特征/n,融合/v,。/w,出来/v,的/u,各/r,层/q,fpn/en,特征/n,首先/d,（/w,各自/r,独立/v,地/u,）/w,进入/v,了/u,rpn/en,处理层/nw,：/w,根据/p,锚框/nw,数目/n,信息/n,确定/v,候选/b,区域/n,的/u,分类/vn,（/w,前景/n,背景/n,2/m,分类/vn,）/w,和/c,回归/v,结果/n,。/w,rpn/en,_,class/en,：/w,[/w,batch/en,,/w, ,num/en,_,rois/en,,/w, ,2/m,]/w,rpn/en,_,bbox/en,：/w,[/w,batch/en,,/w, ,num/en,_,rois/en,,/w, ,(/w,dy/en,,/w, ,dx/en,,/w, ,log/en,(/w,dh/en,)/w,,/w, ,log/en,(/w,dw/en,)/w,)/w,]/w,有/v,了/u,众多/m,的/u,候选/b,区域/n,，/w,我们/r,将/d,之/u,送入/v,proposal/en,筛选/v,部分/n,，/w,首先/d,根据/p,前景/n,得分/n,排序/vn,进行/v,初/f,筛/v,（/w,配置/vn,会/v,指定/v,这/r,一步/mq,保留/v,多少/r,候选框/nw,）/w,，/w,然后/c,为/p,非/h,极/d,大/a,值/n,抑制/v,做/v,准备/v,：/w,用/p,rpn/en,的/u,回归/v,结果/n,修正/v,anchors/en,，/w,值得/v,注意/v,的/u,是/v,anchors/en,都/d,是/v,归/v,一化/nw,的/u,这/r,意味/n,着/u,修值/nw,之后/f,还/d,需要/v,做/v,检查/vn,以防/v,越界/v,，/w,最后/f,非/h,极/d,大/a,值/n,一致/a,，/w,删减/v,的/u,太/d,多/a,了/u,的/u,话/n,就/d,补/v,上/f,[/w,0/m,,/w, ,0/m,,/w, ,0/m,,/w, ,0/m,]/w,达到/v,配置/vn,文件/n,要求/v,的/u,数目/n,(/w,非/h,极/d,大/a,值/n,部分/n,会/v,造成/v,同一/b,个/q,batch/en,中/f,不同/a,图片/n,的/u,候选框/nw,数目/n,不/d,一致/a,，/w,但是/c,tensor/en,的/u,维数/nr,不/d,能/v,参差不齐/i,，/w,所以/c,要/v,补/v,零/m,使得/v,各/r,张/q,图片/n,候选/b,区域/n,数目/n,一致/a,)/w,rpn/en,_,rois/en,：/w,[/w,images/en,_,per/en,_,gpu/en,,/w, ,num/en,_,rois/en,,/w, ,(/w,y/en,1/m,,/w, ,x/en,1/m,,/w, ,y/en,2/m,,/w, ,x/en,2/m,)/w,]/w,根据/p,候选区/ns,的/u,实际/n,大小/n,（/w,归/v,一/m,化候/nw,选区/n,需要/v,映射/v,回/v,原/b,图/n,大小/n,）/w,为/p,候选区/ns,选择/v,合适/a,的/u,rpn/en,特征/n,层/q,，/w,roi/en, ,align/en,处理/v,（/w,实际上/d,就/d,是/v,抠/v,出来/v,进行/v,双线性/nw,插值/nw,到/v,指定/v,大小/n,）/w,，/w,得到/v,我们/r,需要/v,的/u,众多/m,等/u,大子图/nw,对/p,这些/r,子图/nr,各自/r,独立/v,的/u,进行/v,分类/vn,//w,回归/v,mrcnn/en,_,class/en,_,logits/en,:/w, ,[/w,batch/en,,/w, ,num/en,_,rois/en,,/w, ,num/en,_,classes/en,]/w, ,classifier/en, ,logits/en, ,(/w,before/en, ,softmax/en,)/w,mrcnn/en,_,class/en,:/w, ,[/w,batch/en,,/w, ,num/en,_,rois/en,,/w, ,num/en,_,classes/en,]/w, ,classifier/en, ,probabilitiesmrcnn/en,_,bbox/en,(/w,deltas/en,)/w,:/w, ,[/w,batch/en,,/w, ,num/en,_,rois/en,,/w, ,num/en,_,classes/en,,/w, ,(/w,dy/en,,/w, ,dx/en,,/w, ,log/en,(/w,dh/en,)/w,,/w, ,log/en,(/w,dw/en,)/w,)/w,]/w,在/p,分类/vn,回归/v,之后/f,使用/v,回归/v,结果/n,对/p,候选框/nw,进行/v,修正/v,，/w,然后/