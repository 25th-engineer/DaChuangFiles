一/m,、/w,rpn/en,锚框/nw,信息/n,生成/vn,上文/n,的/u,最后/f,，/w,我们/r,生成/vn,了/u,用于/v,计算/v,锚框/nw,信息/n,的/u,特征/n,（/w,源代码/n,在/p,inference/en,模式/n,中/f,不/d,进行/v,锚框/nw,生成/vn,，/w,而是/c,外部/f,生成/vn,好/a,feed/en,进/v,网络/n,，/w,training/en,模式/n,下/f,在/p,向前/v,传播/vn,时/ng,直接/ad,生成/vn,锚框/nw,，/w,不过/c,实际上/d,没/d,什么/r,区别/n,，/w,锚框/nw,生成/vn,的/u,讲解/v,见/v,『/w,计算机/n,视觉/n,』/w,mask/en,-/w,rcnn/en,_,锚框/nw,生成/vn,）/w,：/w,rpn/en,_,feature/en,_,maps/en, ,=/w, ,[/w,p/en,2/m,,/w, ,p/en,3/m,,/w, ,p/en,4/m,,/w, ,p/en,5/m,,/w, ,p/en,6/m,]/w,接下来/l,，/w,我们/r,基于/p,上述/b,特征/n,首先/d,生成/vn,锚框/nw,的/u,信息/n,，/w,包含/v,每个/r,锚框/nw,的/u,前景/n,//w,背景/n,得分/n,信息/n,及/c,每个/r,锚框/nw,的/u,坐标/n,修正/v,信息/n,。/w,接前/nw,文主/nr,函数/n,，/w,我们/r,初始化/v,rpn/en, ,model/en, ,class/en,的/u,对象/n,，/w,并/c,应用/vn,于/p,各/r,层/q,特征/n,：/w,#, ,anchors/en, ,if/en, ,mode/en, ,=/w,=/w, ,"/w,training/en,"/w,:/w, ,……/w, ,else/en,:/w, ,anchors/en, ,=/w, ,input/en,_,anchors/en, ,#, ,rpn/en, ,model/en,,/w, ,返回/v,的/u,是/v,keras/en,的/u,module/en,对象/n,,/w, ,注意/v,keras/en,中/f,的/u,module/en,对象/n,是/v,可/v,call/en,的/u, ,rpn/en, ,=/w, ,build/en,_,rpn/en,_,model/en,(/w,config/en,./w,rpn/en,_,anchor/en,_,stride/en,,/w, ,#, ,1/m, ,3/m, ,256/m, ,len/en,(/w,config/en,./w,rpn/en,_,anchor/en,_,ratios/en,)/w,,/w, ,config/en,./w,top/en,_,down/en,_,pyramid/en,_,size/en,)/w, ,#, ,loop/en, ,through/en, ,pyramid/en, ,layers/en, ,layer/en,_,outputs/en, ,=/w, ,[/w,]/w, ,#, ,list/en, ,of/en, ,lists/en, ,for/en, ,p/en, ,in/en, ,rpn/en,_,feature/en,_,maps/en,:/w, ,layer/en,_,outputs/en,./w,append/en,(/w,rpn/en,(/w,[/w,p/en,]/w,)/w,)/w, ,#, ,保存/v,各/r,pyramid/en,特征/n,经过/p,rpn/en,之后/f,的/u,结果/n,具体/a,的/u,rpn/en,模块/n,调用/v,函数/n,栈/ng,如下/v,，/w,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#, ,#, ,region/en, ,proposal/en, ,network/en, ,(/w,rpn/en,)/w, ,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#, ,def/en, ,rpn/en,_,graph/en,(/w,feature/en,_,map/en,,/w, ,anchors/en,_,per/en,_,location/en,,/w, ,anchor/en,_,stride/en,)/w,:/w, ,"/w,"/w,"/w,builds/en, ,the/en, ,computation/en, ,graph/en, ,of/en, ,region/en, ,proposal/en, ,network/en,./w, ,feature/en,_,map/en,:/w, ,backbone/en, ,features/en, ,[/w,batch/en,,/w, ,height/en,,/w, ,width/en,,/w, ,depth/en,]/w, ,anchors/en,_,per/en,_,location/en,:/w, ,number/en, ,of/en, ,anchors/en, ,per/en, ,pixel/en, ,in/en, ,the/en, ,feature/en, ,map/en, ,anchor/en,_,stride/en,:/w, ,controls/en, ,the/en, ,density/en, ,of/en, ,anchors/en,./w, ,typically/en, ,1/m, ,(/w,anchors/en, ,for/en, ,every/en, ,pixel/en, ,in/en, ,the/en, ,feature/en, ,map/en,)/w,,/w, ,or/en, ,2/m, ,(/w,every/en, ,other/en, ,pixel/en,)/w,./w, ,returns/en,:/w, ,rpn/en,_,class/en,_,logits/en,:/w, ,[/w,batch/en,,/w, ,h/en, ,*/w, ,w/en, ,*/w, ,anchors/en,_,per/en,_,location/en,,/w, ,2/m,]/w, ,anchor/en, ,classifier/en, ,logits/en, ,(/w,before/en, ,softmax/en,)/w, ,rpn/en,_,probs/en,:/w, ,[/w,batch/en,,/w, ,h/en, ,*/w, ,w/en, ,*/w, ,anchors/en,_,per/en,_,location/en,,/w, ,2/m,]/w, ,anchor/en, ,classifier/en, ,probabilities/en,./w, ,rpn/en,_,bbox/en,:/w, ,[/w,batch/en,,/w, ,h/en, ,*/w, ,w/en, ,*/w, ,anchors/en,_,per/en,_,location/en,,/w, ,(/w,dy/en,,/w, ,dx/en,,/w, ,log/en,(/w,dh/en,)/w,,/w, ,log/en,(/w,dw/en,)/w,)/w,]/w, ,deltas/en, ,to/en, ,be/en, ,applied/en, ,to/en, ,anchors/en,./w, ,"/w,"/w,"/w, ,#, ,todo/en,:/w, ,check/en, ,if/en, ,stride/en, ,of/en, ,2/m, ,causes/en, ,alignment/en,(/w,校准/v,,/w,对齐/v,)/w, ,issues/en, ,if/en, ,the/en, ,feature/en, ,map/en, ,#, ,is/en, ,not/en, ,even/en,./w, ,#, ,shared/en, ,convolutional/en, ,base/en, ,of/en, ,the/en, ,rpn/en, ,shared/en, ,=/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,512/m,,/w, ,(/w,3/m,,/w, ,3/m,)/w,,/w, ,padding/en,=/w,'/w,same/en,'/w,,/w, ,activation/en,=/w,'/w,relu/en,'/w,,/w, ,strides/en,=/w,anchor/en,_,stride/en,,/w, ,name/en,=/w,'/w,rpn/en,_,conv/en,_,shared/en,'/w,)/w,(/w,feature/en,_,map/en,)/w, ,#, ,anchor/en, ,score/en,./w, ,[/w,batch/en,,/w, ,height/en,,/w, ,width/en,,/w, ,anchors/en, ,per/en, ,location/en, ,*/w, ,2/m,]/w,./w, ,x/en, ,=/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,2/m, ,*/w, ,anchors/en,_,per/en,_,location/en,,/w, ,(/w,1/m,,/w, ,1/m,)/w,,/w, ,padding/en,=/w,'/w,valid/en,'/w,,/w, ,activation/en,=/w,'/w,linear/en,'/w,,/w, ,name/en,=/w,'/w,rpn/en,_,class/en,_,raw/en,'/w,)/w,(/w,shared/en,)/w, ,#, ,reshape/en, ,to/en, ,[/w,batch/en,,/w, ,anchors/en,,/w, ,2/m,]/w, ,rpn/en,_,class/en,_,logits/en, ,=/w, ,kl/en,./w,lambda/en,(/w, ,lambda/en, ,t/en,:/w, ,tf/en,./w,reshape/en,(/w,t/en,,/w, ,[/w,tf/en,./w,shape/en,(/w,t/en,)/w,[/w,0/m,]/w,,/w, ,-/w,1/m,,/w, ,2/m,]/w,)/w,)/w,(/w,x/en,)/w, ,#, ,output/en, ,tensors/en, ,to/en, ,a/en, ,model/en, ,must/en, ,be/en, ,keras/en, ,tensors/en,,/w, ,所以/c,下面/f,不行/a, ,#, ,rpn/en,_,class/en,_,logits/en, ,=/w, ,tf/en,./w,reshape/en,(/w,x/en,,/w, ,[/w,tf/en,./w,shape/en,(/w,x/en,)/w,[/w,0/m,]/w,,/w, ,-/w,1/m,,/w, ,2/m,]/w,)/w, ,#, ,softmax/en, ,on/en, ,last/en, ,dimension/en, ,of/en, ,bg/en,//w,fg/en,./w, ,rpn/en,_,probs/en, ,=/w, ,kl/en,./w,activation/en,(/w, ,"/w,softmax/en,"/w,,/w, ,name/en,=/w,"/w,rpn/en,_,class/en,_,xxx/en,"/w,)/w,(/w,rpn/en,_,class/en,_,logits/en,)/w, ,#, ,bounding/en, ,box/en, ,refinement/en,./w, ,[/w,batch/en,,/w, ,h/en,,/w, ,w/en,,/w, ,anchors/en, ,per/en, ,location/en, ,*/w, ,depth/en,]/w, ,#, ,where/en, ,depth/en, ,is/en, ,[/w,x/en,,/w, ,y/en,,/w, ,log/en,(/w,w/en,)/w,,/w, ,log/en,(/w,h/en,)/w,]/w, ,x/en, ,=/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,anchors/en,_,per/en,_,location/en, ,*/w, ,4/m,,/w, ,(/w,1/m,,/w, ,1/m,)/w,,/w, ,padding/en,=/w,"/w,valid/en,"/w,,/w, ,activation/en,=/w,'/w,linear/en,'/w,,/w, ,name/en,=/w,'/w,rpn/en,_,bbox/en,_,pred/en,'/w,)/w,(/w,shared/en,)/w, ,#, ,reshape/en, ,to/en, ,[/w,batch/en,,/w, ,anchors/en,,/w, ,4/m,]/w, ,rpn/en,_,bbox/en, ,=/w, ,kl/en,./w,lambda/en,(/w,lambda/en, ,t/en,:/w, ,tf/en,./w,reshape/en,(/w,t/en,,/w, ,[/w,tf/en,./w,shape/en,(/w,t/en,)/w,[/w,0/m,]/w,,/w, ,-/w,1/m,,/w, ,4/m,]/w,)/w,)/w,(/w,x/en,)/w, ,return/en, ,[/w,rpn/en,_,class/en,_,logits/en,,/w, ,rpn/en,_,probs/en,,/w, ,rpn/en,_,bbox/en,]/w, ,def/en, ,build/en,_,rpn/en,_,model/en,(/w,anchor/en,_,stride/en,,/w, ,anchors/en,_,per/en,_,location/en,,/w, ,depth/en,)/w,:/w, ,"/w,"/w,"/w,builds/en, ,a/en, ,keras/en, ,model/en, ,of/en, ,the/en, ,region/en, ,proposal/en, ,network/en,./w, ,it/en, ,wraps/en, ,the/en, ,rpn/en, ,graph/en, ,so/en, ,it/en, ,can/en, ,be/en, ,used/en, ,multiple/en, ,times/en, ,with/en, ,shared/en, ,weights/en,./w, ,anchors/en,_,per/en,_,location/en,:/w, ,number/en, ,of/en, ,anchors/en, ,per/en, ,pixel/en, ,in/en, ,the/en, ,feature/en, ,map/en, ,anchor/en,_,stride/en,:/w, ,controls/en, ,the/en, ,density/en, ,of/en, ,anchors/en,./w, ,typically/en, ,1/m, ,(/w,anchors/en, ,for/en, ,every/en, ,pixel/en, ,in/en, ,the/en, ,feature/en, ,map/en,)/w,,/w, ,or/en, ,2/m, ,(/w,every/en, ,other/en, ,pixel/en,)/w,./w, ,depth/en,:/w, ,depth/en, ,of/en, ,the/en, ,backbone/en, ,feature/en, ,map/en,./w, ,returns/en, ,a/en, ,keras/en, ,model/en, ,object/en,./w, ,the/en, ,model/en, ,outputs/en,,/w, ,when/en, ,called/en,,/w, ,are/en,:/w, ,rpn/en,_,class/en,_,logits/en,:/w, ,[/w,batch/en,,/w, ,h/en, ,*/w, ,w/en, ,*/w, ,anchors/en,_,per/en,_,location/en,,/w, ,2/m,]/w, ,anchor/en, ,classifier/en, ,logits/en, ,(/w,before/en, ,softmax/en,)/w, ,rpn/en,_,probs/en,:/w, ,[/w,batch/en,,/w, ,h/en, ,*/w, ,w/en, ,*/w, ,anchors/en,_,per/en,_,location/en,,/w, ,2/m,]/w, ,anchor/en, ,classifier/en, ,probabilities/en,./w, ,rpn/en,_,bbox/en,:/w, ,[/w,batch/en,,/w, ,h/en, ,*/w, ,w/en, ,*/w, ,anchors/en,_,per/en,_,location/en,,/w, ,(/w,dy/en,,/w, ,dx/en,,/w, ,log/en,(/w,dh/en,)/w,,/w, ,log/en,(/w,dw/en,)/w,)/w,]/w, ,deltas/en, ,to/en, ,be/en, ,applied/en, ,to/en, ,anchors/en,./w, ,"/w,"/w,"/w, ,input/en,_,feature/en,_,map/en, ,=/w, ,kl/en,./w,input/en,(/w,shape/en,=/w,[/w,none/en,,/w, ,none/en,,/w, ,depth/en,]/w,,/w, ,name/en,=/w,"/w,input/en,_,rpn/en,_,feature/en,_,map/en,"/w,)/w, ,#, ,[/w,rpn/en,_,class/en,_,logits/en,,/w, ,rpn/en,_,probs/en,,/w, ,rpn/en,_,bbox/en,]/w, ,input/en,_,feature/en,_,map/en, ,3/m, ,1/m, ,outputs/en, ,=/w, ,rpn/en,_,graph/en,(/w,input/en,_,feature/en,_,map/en,,/w, ,anchors/en,_,per/en,_,location/en,,/w, ,anchor/en,_,stride/en,)/w, ,return/en, ,km/en,./w,model/en,(/w,[/w,input/en,_,feature/en,_,map/en,]/w,,/w, ,outputs/en,,/w, ,name/en,=/w,"/w,rpn/en,_,model/en,"/w,)/w,接前/nw,文主/nr,函数/n,，/w,我们/r,将/d,获取/v,的/u,list/en,形式/n,的/u,各/r,层/q,锚框/nw,信息/n,进行/v,拼接/vn,重组/vn,：/w,#, ,loop/en, ,through/en, ,pyramid/en, ,layers/en, ,layer/en,_,outputs/en, ,=/w, ,[/w,]/w, ,#, ,list/en, ,of/en, ,lists/en, ,for/en, ,p/en, ,in/en, ,rpn/en,_,feature/en,_,maps/en,:/w, ,layer/en,_,outputs/en,./w,append/en,(/w,rpn/en,(/w,[/w,p/en,]/w,)/w,)/w, ,#, ,保存/v,各/r,pyramid/en,特征/n,经过/p,rpn/en,之后/f,的/u,结果/n, ,#, ,concatenate/en, ,layer/en, ,outputs/en, ,#, ,convert/en, ,from/en, ,list/en, ,of/en, ,lists/en, ,of/en, ,level/en, ,outputs/en, ,to/en, ,list/en, ,of/en, ,lists/en, ,#, ,of/en, ,outputs/en, ,across/en, ,levels/en,./w, ,#, ,e/en,./w,g/en,./w, ,[/w,[/w,a/en,1/m,,/w, ,b/en,1/m,,/w, ,c/en,1/m,]/w,,/w, ,[/w,a/en,2/m,,/w, ,b/en,2/m,,/w, ,c/en,2/m,]/w,]/w, ,=/w,>, ,[/w,[/w,a/en,1/m,,/w, ,a/en,2/m,]/w,,/w, ,[/w,b/en,1/m,,/w, ,b/en,2/m,]/w,,/w, ,[/w,c/en,1/m,,/w, ,c/en,2/m,]/w,]/w, ,output/en,_,names/en, ,=/w, ,[/w,"/w,rpn/en,_,class/en,_,logits/en,"/w,,/w, ,"/w,rpn/en,_,class/en,"/w,,/w, ,"/w,rpn/en,_,bbox/en,"/w,]/w, ,outputs/en, ,=/w, ,list/en,(/w,zip/en,(/w,*/w,layer/en,_,outputs/en,)/w,)/w, ,#, ,[/w,[/w,logits/en,2/m,,/w,……/w,6/m,]/w,,/w, ,[/w,class/en,2/m,,/w,……/w,6/m,]/w,,/w, ,[/w,bbox/en,2/m,,/w,……/w,6/m,]/w,]/w, ,outputs/en, ,=/w, ,[/w,kl/en,./w,concatenate/en,(/w,axis/en,=/w,1/m,,/w, ,name/en,=/w,n/en,)/w,(/w,list/en,(/w,o/en,)/w,)/w, ,for/en, ,o/en,,/w, ,n/en, ,in/en, ,zip/en,(/w,outputs/en,,/w, ,output/en,_,names/en,)/w,]/w, ,#, ,[/w,batch/en,,/w, ,num/en,_,anchors/en,,/w, ,2/m,//w,4/m,]/w, ,#, ,其中/r,num/en,_,anchors/en,指/v,的/u,是/v,全部/m,特征/n,层/q,上/f,的/u,anchors/en,总数/n, ,rpn/en,_,class/en,_,logits/en,,/w, ,rpn/en,_,class/en,,/w, ,rpn/en,_,bbox/en, ,=/w, ,outputs/en,目的/n,很/d,简单/a,，/w,原来/d,的/u,返回/v,值/n,为/p,[/w,(/w,logits/en,2/m,,/w, ,class/en,2/m,,/w, ,bbox/en,2/m,)/w,,/w, ,(/w,logits/en,3/m,,/w, ,class/en,3/m,,/w, ,bbox/en,3/m,)/w,,/w, ,……/w,]/w,，/w,首先/d,将/d,之/u,转换/v,为/p,[/w,[/w,logits/en,2/m,,/w,……/w,6/m,]/w,,/w, ,[/w,class/en,2/m,,/w,……/w,6/m,]/w,,/w, ,[/w,bbox/en,2/m,,/w,……/w,6/m,]/w,]/w,，/w,然后/c,将/d,每个/r,小/a,list/en,中/f,的/u,tensor/en,按照/p,第一/m,维度/n,（/w,即/v,anchors/en,维度/n,）/w,拼接/vn,，/w,得到/v,三个/m,tensor/en,，/w,每个/r,tensor/en,表明/v,batch/en,中/f,图片/n,对应/v,5个/m,特征/n,层/q,的/u,全部/m,anchors/en,的/u,分类/vn,回归/v,信息/n,，/w,即/v,：/w,[/w,batch/en,,/w, ,anchors/en,,/w, ,2/m,分类/vn,结果/n, ,or/en, ,(/w,dy/en,,/w, ,dx/en,,/w, ,log/en,(/w,dh/en,)/w,,/w, ,log/en,(/w,dw/en,)/w,)/w,]/w,。/w,二/m,、/w,proposal/en,建议/n,区/n,生成/vn,上/f,一步/mq,我们/r,获取/v,了/u,全部/m,锚框/nw,的/u,信息/n,，/w,这里/r,我们/r,的/u,目的/n,是/v,从中/d,挑选/v,指定/v,个/q,数/m,的/u,更/d,可能/v,包含/v,obj/en,的/u,锚框/nw,作为/v,建议/n,区域/n,，/w,即/v,我们/r,希望/v,获取/v,在/p,上/f,一步/mq,的/u,二/m,分类/vn,中/f,前景/n,得分/n,更/d,高/a,的/u,框/q,，/w,同时/c,，/w,由于/c,锚框/nw,生成/vn,算法/n,的/u,设计/vn,，/w,其/r,数量/n,巨大/a,且/c,重叠/v,严重/a,，/w,我们/r,在/p,得分/n,高低/n,的/u,基础/n,上/f,，/w,进一步/d,的/u,希望/v,能够/v,去/v,重/a,（/w,非/h,极/d,大/a,值/n,抑制/v,）/w,，/w,这/r,就/d,是/v,proposal/en,生成/vn,的/u,目的/n,。/w,接前/nw,文主/nr,函数/n,，/w,我们/r,用/p,下面/f,的/u,代码/n,进入/v,候选区/ns,生成/vn,过程/n,，/w,#, ,generate/en, ,proposals/en, ,#, ,proposals/en, ,are/en, ,[/w,batch/en,,/w, ,n/en,,/w, ,(/w,y/en,1/m,,/w, ,x/en,1/m,,/w, ,y/en,2/m,,/w, ,x/en,2/m,)/w,]/w, ,in/en, ,normalized/en, ,coordinates/en, ,#, ,and/en, ,zero/en, ,padded/en,./w, ,#, ,post/en,_,nms/en,_,rois/en,_,inference/en, ,=/w, ,1000/m, ,#, ,post/en,_,nms/en,_,rois/en,_,training/en, ,=/w, ,2000/m, ,proposal/en,_,count/en, ,=/w, ,config/en,./w,post/en,_,nms/en,_,rois/en,_,training/en, ,if/en, ,mode/en, ,=/w,=/w, ,"/w,training/en,"/w,\/w, ,else/en, ,config/en,./w,post/en,_,nms/en,_,rois/en,_,inference/en, ,#, ,[/w,images/en,_,per/en,_,gpu/en,,/w, ,num/en,_,rois/en,,/w, ,(/w,y/en,1/m,,/w, ,x/en,1/m,,/w, ,y/en,2/m,,/w, ,x/en,2/m,)/w,]/w, ,#, ,images/en,_,per/en,_,gpu/en,取代/v,了/u,batch/en,，/w,之后/f,说/v,的/u,batch/en,都/d,是/v,images/en,_,per/en,_,gpu/en, ,rpn/en,_,rois/en, ,=/w, ,proposallayer/en,(/w, ,proposal/en,_,count/en,=/w,proposal/en,_,count/en,,/w, ,nms/en,_,threshold/en,=/w,config/en,./w,rpn/en,_,nms/en,_,threshold/en,,/w, ,#, ,0.7/m, ,name/en,=/w,"/w,roi/en,"/w,,/w, ,config/en,=/w,config/en,)/w,(/w,[/w,rpn/en,_,class/en,,/w, ,rpn/en,_,bbox/en,,/w, ,anchors/en,]/w,)/w,proposal/en,_,count/en,是/v,一个/m,整数/n,，/w,用于/v,指定/v,生成/vn,proposal/en,数目/n,，/w,不足/a,时/ng,会/v,生成/vn,坐标/n,为/p,[/w,0/m,,/w,0/m,,/w,0/m,,/w,0/m,]/w,的/u,空值/nw,进行/v,补全/nw,。/w,1/m,、/w,初始化/v,proposallayer/en, ,class/en,下面/f,我们/r,来/v,看看/v,proposallayer/en,的/u,过程/n,，/w,在/p,初始/b,部分/n,我们/r,获取/v,[/w,rpn/en,_,class/en,,/w, ,rpn/en,_,bbox/en,,/w, ,anchors/en,]/w,三个/m,张量/nr,作为/v,参数/n,，/w,class/en, ,proposallayer/en,(/w,ke/en,./w,layer/en,)/w,:/w, ,"/w,"/w,"/w,receives/en, ,anchor/en, ,scores/en, ,and/en, ,selects/en, ,a/en, ,subset/en, ,to/en, ,pass/en, ,as/en, ,proposals/en, ,to/en, ,the/en, ,second/en, ,stage/en,./w, ,filtering/en, ,is/en, ,done/en, ,based/en, ,on/en, ,anchor/en, ,scores/en, ,and/en, ,non/en,-/w,max/en, ,suppression/en, ,to/en, ,remove/en, ,overlaps/en,./w, ,it/en, ,also/en, ,applies/en, ,bounding/en, ,box/en, ,refinement/en, ,deltas/en, ,to/en, ,anchors/en,./w, ,inputs/en,:/w, ,rpn/en,_,probs/en,:/w, ,[/w,batch/en,,/w, ,num/en,_,anchors/en,,/w, ,(/w,bg/en, ,prob/en,,/w, ,fg/en, ,prob/en,)/w,]/w, ,rpn/en,_,bbox/en,:/w, ,[/w,batch/en,,/w, ,num/en,_,anchors/en,,/w, ,(/w,dy/en,,/w, ,dx/en,,/w, ,log/en,(/w,dh/en,)/w,,/w, ,log/en,(/w,dw/en,)/w,)/w,]/w, ,anchors/en,:/w, ,[/w,batch/en,,/w, ,num/en,_,anchors/en,,/w, ,(/w,y/en,1/m,,/w, ,x/en,1/m,,/w, ,y/en,2/m,,/w, ,x/en,2/m,)/w,]/w, ,anchors/en, ,in/en, ,normalized/en, ,coordinates/en, ,returns/en,:/w, ,proposals/en, ,in/en, ,normalized/en, ,coordinates/en, ,[/w,batch/en,,/w, ,rois/en,,/w, ,(/w,y/en,1/m,,/w, ,x/en,1/m,,/w, ,y/en,2/m,,/w, ,x/en,2/m,)/w,]/w, ,"/w,"/w,"/w, ,def/en, ,_,_,init/en,_,_,(/w,self/en,,/w, ,proposal/en,_,count/en,,/w, ,nms/en,_,threshold/en,,/w, ,config/en,=/w,none/en,,/w, ,*/w,*/w,kwargs/en,)/w,:/w, ,super/en,(/w,proposallayer/en,,/w, ,self/en,)/w,./w,_,_,init/en,_,_,(/w,*/w,*/w,kwargs/en,)/w, ,self/en,./w,config/en, ,=/w, ,config/en, ,self/en,./w,proposal/en,_,count/en, ,=/w, ,proposal/en,_,count/en, ,self/en,./w,nms/en,_,threshold/en, ,=/w, ,nms/en,_,threshold/en, ,def/en, ,call/en,(/w,self/en,,/w, ,inputs/en,)/w,:/w, ,#, ,[/w,rpn/en,_,class/en,,/w, ,rpn/en,_,bbox/en,,/w, ,anchors/en,]/w, ,#, ,box/en, ,scores/en,./w, ,use/en, ,the/en, ,foreground/en, ,class/en, ,confidence/en,./w, ,[/w,batch/en,,/w, ,num/en,_,rois/en,,/w, ,2/m,]/w,-/w,>,[/w,batch/en,,/w, ,num/en,_,rois/en,]/w, ,scores/en, ,=/w, ,inputs/en,[/w,0/m,]/w,[/w,:/w,,/w, ,:/w,,/w, ,1/m,]/w, ,#, ,box/en, ,deltas/en,./w, ,记录/v,坐标/n,修正/v,信息/n,：/w,(/w,dy/en,,/w, ,dx/en,,/w, ,log/en,(/w,dh/en,)/w,,/w, ,log/en,(/w,dw/en,)/w,)/w,./w, ,[/w,batch/en,,/w, ,num/en,_,rois/en,,/w, ,4/m,]/w, ,deltas/en, ,=/w, ,inputs/en,[/w,1/m,]/w, ,deltas/en, ,=/w, ,deltas/en, ,*/w, ,np/en,./w,reshape/en,(/w,self/en,./w,config/en,./w,rpn/en,_,bbox/en,_,std/en,_,dev/en,,/w, ,[/w,1/m,,/w, ,1/m,,/w, ,4/m,]/w,)/w, ,#, ,[/w, ,0.1/m, ,0.1/m, ,0.2/m, ,0.2/m,]/w, ,#, ,anchors/en,./w, ,记录/v,坐标/n,信息/n,：/w,(/w,y/en,1/m,,/w, ,x/en,1/m,,/w, ,y/en,2/m,,/w, ,x/en,2/m,)/w,./w, ,[/w,batch/en,,/w, ,num/en,_,rois/en,,/w, ,4/m,]/w, ,anchors/en, ,=/w, ,inputs/en,[/w,2/m,]/w,这里/r,的/u,变量/n,scores/en, ,=/w, ,inputs/en,[/w,0/m,]/w,[/w,:/w,,/w, ,:/w,,/w, ,1/m,]/w,，/w,即/v,我们/r,只/d,需要/v,全部/m,候选框/nw,的/u,前景/n,得分/n,。/w,2/m,、/w,top/en, ,k/en,锚框/nw,筛选/v,然后/c,我们/r,获取/v,前景/n,得分/n,最/d,大/a,的/u,n/en,个/q,候选框/nw,，/w,#, ,improve/en, ,performance/en, ,by/en, ,trimming/en, ,to/en, ,top/en, ,anchors/en, ,by/en, ,score/en, ,#, ,and/en, ,doing/en, ,the/en, ,rest/en, ,on/en, ,the/en, ,smaller/en, ,subset/en,./w, ,pre/en,_,nms/en,_,limit/en, ,=/w, ,tf/en,./w,minimum/en,(/w,self/en,./w,config/en,./w,pre/en,_,nms/en,_,limit/en,,/w, ,tf/en,./w,shape/en,(/w,anchors/en,)/w,[/w,1/m,]/w,)/w, ,#, ,输入/v,矩阵/n,时/ng,输出/v,每/r,一行/n,的/u,top/en, ,k/en,./w, ,[/w,batch/en,,/w, ,top/en,_,k/en,]/w, ,ix/en, ,=/w, ,tf/en,./w,nn/en,./w,top/en,_,k/en,(/w,scores/en,,/w, ,pre/en,_,nms/en,_,limit/en,,/w, ,sorted/en,=/w,true/en,,/w, ,name/en,=/w,"/w,top/en,_,anchors/en,"/w,)/w,./w,indices/en,提取/v,top/en, ,k/en,锚框/nw,，/w,我们/r,同时/c,对/p,三个/m,输入/v,进行/v,了/u,提取/v,#, ,batch/en,_,slice/en,函数/n,：/w, ,#, ,#, ,将/d,batch/en,特征/n,拆分/v,为/p,单/d,张/q, ,#, ,#, ,然后/c,提取/v,指定/v,的/u,张数/nr, ,#, ,#, ,使用/v,单/d,张/q,特征/n,处理/v,函数/n,处理/v,，/w,并/c,合并/v,（/w,此时/r,返回/v,的/u,第一/m,维/q,不/d,是/v,输入/v,时/ng,的/u,batch/en,，/w,而是/c,上步/nw,指定/v,的/u,张数/nr,）/w, ,scores/en, ,=/w, ,utils/en,./w,batch/en,_,slice/en,(/w,[/w,scores/en,,/w, ,ix/en,]/w,,/w, ,lambda/en, ,x/en,,/w, ,y/en,:/w, ,tf/en,./w,gather/en,(/w,x/en,,/w, ,y/en,)/w,,/w, ,self/en,./w,config/en,./w,images/en,_,per/en,_,gpu/en,)/w, ,deltas/en, ,=/w, ,utils/en,./w,batch/en,_,slice/en,(/w,[/w,deltas/en,,/w, ,ix/en,]/w,,/w, ,lambda/en, ,x/en,,/w, ,y/en,:/w, ,tf/en,./w,gather/en,(/w,x/en,,/w, ,y/en,)/w,,/w, ,self/en,./w,config/en,./w,images/en,_,per/en,_,gpu/en,)/w, ,pre/en,_,nms/en,_,anchors/en, ,=/w, ,utils/en,./w,batch/en,_,slice/en,(/w,[/w,anchors/en,,/w, ,ix/en,]/w,,/w, ,lambda/en, ,a/en,,/w, ,x/en,:/w, ,tf/en,./w,gather/en,(/w,a/en,,/w, ,x/en,)/w,,/w, ,self/en,./w,config/en,./w,images/en,_,per/en,_,gpu/en,,/w, ,names/en,=/w,[/w,"/w,pre/en,_,nms/en,_,anchors/en,"/w,]/w,)/w,附录/n,./w,辅助/vn,函数/n,batch/en,_,slice/en,其中/r,使用/v,了/u,一个/m,后面/f,也/d,会/v,大量/m,使用/v,的/u,函数/n,：/w,batch/en,_,slice/en,，/w,我/r,尝试/vn,使用/v,tf/en,的/u,while/en,_,loop/en,进行/v,了/u,改写/v,。/w,这个/r,函数/n,将/d,只/d,支持/v,batch/en,为/p,1/m,的/u,函数/n,进行/v,了/u,扩展/v,（/w,实际/n,就/d,是/v,不能/v,有/v,batch/en,维度/n,的/u,函数/n,）/w,，/w,tf/en,./w,gather/en,函数/n,只能/v,进行/v,一/m,维数/nr,组/q,的/u,切片/v,，/w,而/c,scares/en,为/p,2维/mq,[/w,batch/en,,/w, ,num/en,_,rois/en,]/w,，/w,相对/d,的/u,ix/en,也/d,是/v,二维/nr,[/w,batch/en,,/w, ,top/en,_,k/en,]/w,，/w,所以/c,我们/r,需要/v,将/d,两者/r,切片/v,应用/vn,函数/n,后/f,将/d,结果/n,拼接/vn,。/w,【注/nw,】本/nw,函数/n,位于/v,util/en,./w,py/en,而非/c,model/en,./w,py/en,#, ,#,#, ,batch/en, ,slicing/en, ,#, ,some/en, ,custom/en, ,layers/en, ,support/en, ,a/en, ,batch/en, ,size/en, ,of/en, ,1/m, ,only/en,,/w, ,and/en, ,require/en, ,a/en, ,lot/en, ,of/en, ,work/en, ,#, ,to/en, ,support/en, ,batches/en, ,greater/en, ,than/en, ,1/m,./w, ,this/en, ,function/en, ,slices/en, ,an/en, ,input/en, ,tensor/en, ,#, ,across/en, ,the/en, ,batch/en, ,dimension/en, ,and/en, ,feeds/en, ,batches/en, ,of/en, ,size/en, ,1/m,./w, ,effectively/en,,/w, ,#, ,an/en, ,easy/en, ,way/en, ,to/en, ,support/en, ,batches/en, ,>, ,1/m, ,quickly/en, ,with/en, ,little/en, ,code/en, ,modification/en,./w, ,#, ,in/en, ,the/en, ,long/en, ,run/en,,/w, ,it/en,'/w,s/en, ,more/en, ,efficient/en, ,to/en, ,modify/en, ,the/en, ,code/en, ,to/en, ,support/en, ,large/en, ,#, ,batches/en, ,and/en, ,getting/en, ,rid/en, ,of/en, ,this/en, ,function/en,./w, ,consider/en, ,this/en, ,a/en, ,temporary/en, ,solution/en, ,def/en, ,batch/en,_,slice/en,(/w,inputs/en,,/w, ,graph/en,_,fn/en,,/w, ,batch/en,_,size/en,,/w, ,names/en,=/w,none/en,)/w,:/w, ,"/w,"/w,"/w,splits/en, ,inputs/en, ,into/en, ,slices/en, ,and/en, ,feeds/en, ,each/en, ,slice/en, ,to/en, ,a/en, ,copy/en, ,of/en, ,the/en, ,given/en, ,computation/en, ,graph/en, ,and/en, ,then/en, ,combines/en, ,the/en, ,results/en,./w, ,it/en, ,allows/en, ,you/en, ,to/en, ,run/en, ,a/en, ,graph/en, ,on/en, ,a/en, ,batch/en, ,of/en, ,inputs/en, ,even/en, ,if/en, ,the/en, ,graph/en, ,is/en, ,written/en, ,to/en, ,support/en, ,one/en, ,instance/en, ,only/en,./w, ,inputs/en,:/w, ,list/en, ,of/en, ,tensors/en,./w, ,all/en, ,must/en, ,have/en, ,the/en, ,same/en, ,first/en, ,dimension/en, ,length/en, ,graph/en,_,fn/en,:/w, ,a/en, ,function/en, ,that/en, ,returns/en, ,a/en, ,tf/en, ,tensor/en, ,that/en,'/w,s/en, ,part/en, ,of/en, ,a/en, ,graph/en,./w, ,batch/en,_,size/en,:/w, ,number/en, ,of/en, ,slices/en, ,to/en, ,divide/en, ,the/en, ,data/en, ,into/en,./w, ,names/en,:/w, ,if/en, ,provided/en,,/w, ,assigns/en, ,names/en, ,to/en, ,the/en, ,resulting/en, ,tensors/en,./w, ,"/w,"/w,"/w, ,if/en, ,not/en, ,isinstance/en,(/w,inputs/en,,/w, ,list/en,)/w,:/w, ,inputs/en, ,=/w, ,[/w,inputs/en,]/w, ,outputs/en, ,=/w, ,[/w,]/w, ,for/en, ,i/en, ,in/en, ,range/en,(/w,batch/en,_,size/en,)/w,:/w, ,inputs/en,_,slice/en, ,=/w, ,[/w,x/en,[/w,i/en,]/w, ,for/en, ,x/en, ,in/en, ,inputs/en,]/w, ,output/en,_,slice/en, ,=/w, ,graph/en,_,fn/en,(/w,*/w,inputs/en,_,slice/en,)/w, ,if/en, ,not/en, ,isinstance/en,(/w,output/en,_,slice/en,,/w, ,(/w,tuple/en,,/w, ,list/en,)/w,)/w,:/w, ,output/en,_,slice/en, ,=/w, ,[/w,output/en,_,slice/en,]/w, ,outputs/en,./w,append/en,(/w,output/en,_,slice/en,)/w, ,#, ,使用/v,tf/en,./w,while/en,_,loop/en,实现/v,循环体/n,代码/n,如下/v,：/w, ,#, ,import/en, ,tensorflow/en, ,as/en, ,tf/en, ,#, ,i/en, ,=/w, ,0/m, ,#, ,outputs/en, ,=/w, ,[/w,]/w, ,#, ,#, ,def/en, ,cond/en,(/w,index/en,)/w,:/w, ,#, ,return/en, ,index/en, ,</w, ,batch/en,_,size/en, ,#, ,返回/v,bool/en,值/n, ,#, ,#, ,def/en, ,body/en,(/w,index/en,)/w,:/w, ,#, ,index/en, ,+/w,=/w, ,1/m, ,#, ,inputs/en,_,slice/en, ,=/w, ,[/w,x/en,[/w,i/en,]/w, ,for/en, ,x/en, ,in/en, ,inputs/en,]/w, ,#, ,output/en,_,slice/en, ,=/w, ,graph/en,_,fn/en,(/w,*/w,inputs/en,_,slice/en,)/w, ,#, ,if/en, ,not/en, ,isinstance/en,(/w,output/en,_,slice/en,,/w, ,(/w,tuple/en,,/w, ,list/en,)/w,)/w,:/w, ,#, ,output/en,_,slice/en, ,=/w, ,[/w,output/en,_,slice/en,]/w, ,#, ,outputs/en,./w,append/en,(/w,output/en,_,slice/en,)/w, ,#, ,return/en, ,index/en, ,#, ,返回/v,cond/en,需要/v,的/u,判断/v,参数/n,进行/v,下/f,一次/mq,判断/v, ,#, ,#, ,tf/en,./w,while/en,_,loop/en,(/w,cond/en,,/w, ,body/en,,/w, ,[/w,i/en,]/w,)/w, ,#, ,change/en, ,outputs/en, ,from/en, ,a/en, ,list/en, ,of/en, ,slices/en, ,where/en, ,each/en, ,is/en, ,#, ,a/en, ,list/en, ,of/en, ,outputs/en, ,to/en, ,a/en, ,list/en, ,of/en, ,outputs/en, ,and/en, ,each/en, ,has/en, ,#, ,a/en, ,list/en, ,of/en, ,slices/en, ,#, ,下面/f,示意/v,中/f,假设/v,每次/r,graph/en,_,fn/en,返回/v,两个/m,tensor/en, ,#, ,[/w,[/w,tensor/en,11/m,,/w, ,tensor/en,12/m,]/w,,/w, ,[/w,tensor/en,21/m,,/w, ,tensor/en,22/m,]/w,,/w, ,……/w,]/w, ,#, ,——/w,>, ,[/w,(/w,tensor/en,11/m,,/w, ,tensor/en,21/m,,/w, ,……/w,)/w,,/w, ,(/w,tensor/en,12/m,,/w, ,tensor/en,22/m,,/w, ,……/w,)/w,]/w, ,zip/en,返回/v,的/u,是/v,多/a,个/q,tuple/en, ,outputs/en, ,=/w, ,list/en,(/w,zip/en,(/w,*/w,outputs/en,)/w,)/w, ,if/en, ,names/en, ,is/en, ,none/en,:/w, ,names/en, ,=/w, ,[/w,none/en,]/w, ,*/w, ,len/en,(/w,outputs/en,)/w, ,#, ,一般/a,来讲/u,就/d,是/v,batch/en,维度/n,合并/v,回去/v,（/w,上面/f,的/u,for/en,循环/vn,实际/n,是/v,将/d,batch/en,拆分/v,了/u,）/w, ,result/en, ,=/w, ,[/w,tf/en,./w,stack/en,(/w,o/en,,/w, ,axis/en,=/w,0/m,,/w, ,name/en,=/w,n/en,)/w, ,for/en, ,o/en,,/w, ,n/en, ,in/en, ,zip/en,(/w,outputs/en,,/w, ,names/en,)/w,]/w, ,if/en, ,len/en,(/w,result/en,)/w, ,=/w,=/w, ,1/m,:/w, ,result/en, ,=/w, ,result/en,[/w,0/m,]/w, ,return/en, ,result/en,3/m,、/w,锚框/nw,坐标/n,初调/nw,我们/r,在/p,rpn/en,中/f,获取/v,了/u,全部/m,锚框/nw,的/u,坐标/n,回归/v,结果/n,，/w,rpn/en,_,bbox/en,：/w,[/w,batch/en,,/w, ,anchors/en,,/w, ,(/w,dy/en,,/w, ,dx/en,,/w, ,log/en,(/w,dh/en,)/w,,/w, ,log/en,(/w,dw/en,)/w,)/w,]/w,，/w,2/m,小节/n,中/f,我们/r,将/d,top/en, ,k/en,锚框/nw,的/u,坐标/n,信息/n,以及/c,top/en, ,k/en,的/u,回归/v,信息/n,提取/v,了/u,出来/v,，/w,现在/t,我们/r,将/d,之/u,合并/v,（/w,使用/v,rpn/en,回归/v,的/u,结果/n,取/v,修正/v,top/en, ,k/en,锚框/nw,的/u,坐标/n,）/w,，/w,#, ,apply/en, ,deltas/en, ,to/en, ,anchors/en, ,to/en, ,get/en, ,refined/en, ,anchors/en,./w, ,#, ,[/w,images/en,_,per/en,_,gpu/en,,/w, ,top/en,_,k/en,,/w, ,(/w,y/en,1/m,,/w, ,x/en,1/m,,/w, ,y/en,2/m,,/w, ,x/en,2/m,)/w,]/w, ,boxes/en, ,=/w, ,utils/en,./w,batch/en,_,slice/en,(/w,[/w,pre/en,_,nms/en,_,anchors/en,,/w, ,deltas/en,]/w,,/w, ,lambda/en, ,x/en,,/w, ,y/en,:/w, ,apply/en,_,box/en,_,deltas/en,_,graph/en,(/w,x/en,,/w, ,y/en,)/w,,/w, ,self/en,./w,config/en,./w,images/en,_,per/en,_,gpu/en,,/w, ,names/en,=/w,[/w,"/w,refined/en,_,anchors/en,"/w,]/w,)/w,函数/n,如下/v,，/w,def/en, ,apply/en,_,box/en,_,deltas/en,_,graph/en,(/w,boxes/en,,/w, ,deltas/en,)/w,:/w, ,"/w,"/w,"/w,applies/en, ,the/en, ,given/en, ,deltas/en, ,to/en, ,the/en, ,given/en, ,boxes/en,./w, ,boxes/en,:/w, ,[/w,n/en,,/w, ,(/w,y/en,1/m,,/w, ,x/en,1/m,,/w, ,y/en,2/m,,/w, ,x/en,2/m,)/w,]/w, ,boxes/en, ,to/en, ,update/en, ,deltas/en,:/w, ,[/w,n/en,,/w, ,(/w,dy/en,,/w, ,dx/en,,/w, ,log/en,(/w,dh/en,)/w,,/w, ,log/en,(/w,dw/en,)/w,)/w,]/w, ,refinements/en, ,to/en, ,apply/en, ,"/w,"/w,"/w, ,#, ,dy/en, ,=/w, ,(/w,y/en,_,n/en, ,-/w, ,y/en,_,o/en,)/w,//w,h/en,_,o/en, ,#, ,dx/en, ,=/w, ,(/w,x/en,_,n/en, ,-/w, ,x/en,_,o/en,)/w,//w,w/en,_,o/en, ,#, ,dh/en, ,=/w, ,h/en,_,n/en,//w,h/en,_,o/en, ,#, ,dw/e