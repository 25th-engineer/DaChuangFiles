或许 很多 朋友 会 好奇 其中 的 神秘 比如说 为 
什么 不同 角度 拍摄 的 图片 拼接 的 时候 可以 
自动 对齐 略 准确 来讲 也 就是 如何 处理 图片 
之间 的 仿射 畸变 和 透视 失 真 如何 能 
自动 找到 图片 之间 可以 粘连 的 部分 并且 准确无误 
地 拼接 在 一起 如何 平衡 图片 之间 光线 色调 
的 差异 等等 其实/d 每/zg 一步/m 的/uj 背后/f 或多或少/d 都有/nr 
比较/d 复杂/a 却又/i 相当 精妙 的 技术 和 算法 所以 
这次 尝试 用 比较 直观 的 方式 给 大家 介绍 
一下 每一步 的 工作 原理 逆转 对 前沿 科技 虽 
不明 但 觉 厉 的 看法 那么 先 描述 一下 
整个 流程 图片 之间 1 . 特征点 匹配 找到 素材 
图片 中 共有 的 图像 部分 2 . 图片 匹配 
连接 匹配 的 特征点 估算 图像 间 几何 方面 的 
变换 全局 优化 和 无缝 衔接 3 . 全景图 矫直 
矫正 拍摄 图片 时 相机 的 相对 3D 旋转 主要 
原因 是 拍摄 图片 时 相机 很 可能 并不 在 
同一 水平线 上 并且 存在 不同 程度 的 倾斜 略过 
这一步 可能 导致 全景图 变成 波浪 形状 4 . 图像 
均衡 补偿 全局 平衡 所有 图片 的 光照 和 色调 
5 . 图像 频段 融合 步骤 4 之后 仍然 会 
存在 图像 之间 衔接 边缘 晕 影 效果 图像 的 
外围 部分 的 亮度 或 饱和度 比 中心 区域 低 
视差 效果 因为 相机 透镜 移动 导致 一 特征点 匹配 
合成 全景图 的 第一步 是 提取 并且 匹配 所有 素材 
图片 的 局部 特征点 1 . 什么 是 特征点 普遍 
来讲 一张 图片 所 包含 的 特征点 通常 就 是 
周围 含有 较大 信息量 的 点 而 仅 通过 这些 
富有 特征 的 局部 基本 就 可以 推测 出 整张 
图片 比如说 物体 的 棱角 夜景 闪耀 的 星星 或是 
图片 里 的 图案 和 花纹 图中 框内 即为 判断 
富有 特征 的 部分 实 际 上人 在 识别 某个 
东西 或是 图案 的 时候 也 是 通过 观察 这个 
物体 具有 哪种 特征 然后 与 自己 的 经历 和 
记忆 所 匹配 举例来说 去 超市 看到 一个 水果 假设 
我们 观察 到这 个 水果 是 绿色 颜色 特征 球形 
形状 特征 有 黑色 纹路 图案 特征 于是 我们 可以 
通过 经验 判断 出 这 是个 西瓜 当然 人 还会 
通过 各种 其他 特征 来 增强 对 物体 的 判断力 
只是 整个 从 收到 信息 到 做出 判断 的 过程 
行云流水 甚至 自己 都 察觉 不到 这 就是 生物 视觉 
的 精妙 之处 只可惜 距离 破解 生物 视觉 系统 目前 
看来 似乎 仍是 遥 不可 及 所以在 神经网络 破解 并 
模拟 生物 大脑 的 运作 之前 就 先由 计算机 视觉 
来 承担 这个 重担 了 稍稍 有些 跑题 那么 继续 
之前 的 问题 提取 何种 特征 并且 如何 提取 特征 
如 前面 所说 一幅 图片 具有 形形色色 各种 特征 简单 
的 可以 是 颜色 形状 或 图案 复杂 的 比如 
说 可以 是 图案 的 自 相似性 是否 存在 类似 
重复性 图案 或是 整个 场景 里 其 他 的 物体 
好比 说 在 超市 的 水果 架上 我们 可以 更能 
确信 西瓜 就是 西瓜 而 水果 架 这个 背景 即 
为特征 实际上 提取 这些 特征 在 计算机 视觉 领域 里 
也 占有 相当 重要 的 位 置 毕竟 好 的 
特征 选择 是 整个 识别 系统 可以 成功 运转 的 
大前提 理论 部分 在 合成 全景图 的 流程 里 运用 
的 是 点 匹配 也 就是 匹配 局部 图片 信息 
因为 局部 图片 能 提取 的 特征 有限 比如说 形状 
特征 在 这种 情况 就 不适宜 所以 一般 采用 通过 
整个 局部 的 图案 来 判断 是否 符合 作为 特征 
的 条件 其中 运用 最 普遍 的 为 SIFT 特征 
Scale invariant feature transform 即 尺度 不变 特征 转换 其 
应用 范围 包含 物体 辨识 机器人 地图 感知 与 导航 
影像 缝合 3D 模型 建立 手势 辨识 影像 追踪 和 
动作 比对 此 算法 由 David Lowe 在 1999年 所 
发表 在 急速 发展 的 计算机 视觉 领域内 至今 仍然 
被 普遍 认为 是 最好 的 即 State of the 
art 特征 侦测 与 描述 算法 提取 SIFT 特征 分为 
两步 侦测 与 描述 形成 特征向量 简 单 来讲 侦测 
就是 扫描 图片 所有 的 尺度 下 的 所有 位置 
尺度 可以 理解 为 局部 缩放 而 判断 一个 点 
作为 特征点 合 不合格 需要 计算 在 这个 尺度 下 
的 高斯 差 DoG Difference of Gaussians 的 局部 极值 
Local Extrema 如 第一张 图 所示 每一个 尺度 Scale 下 
对 局部 影像 进行 不同 尺度 的 高斯 模糊 局部 
影像 与 高斯 滤波器 的 卷积 取 差值 局部 极值 
计 算方 式 如 第二 张图/nr 所示 将 测试 像素 
的 DoG 的 数值 与其 26个 邻接 像素 比较 取其 
最大 最小 极值 也 就是 测试 像素 的 特征 度 
即便 找到 了 特征点 单纯 匹配 特征点 周围 的 局部 
影像 是 行不通 的 首先 SIFT 特征 本身 最大 的 
优点 就是 位置 尺度 旋转 不变量 也 就是说 在 一定 
范围 内旋转 或是 拉 远 拉近 相机 可以 检测 出 
相同 的 特征 点 位置 Repeatability 以及 提取 出 相同 
的 特征向量 Scale & Rotation Invariant 所以 不同 角度 条件 
拍摄 的 图片 才 可以 通过 SIFT 特征 匹配 而 
像素 数值 是 不具备 这些 特点 的 再者 局部 影像 
的 像素 信息量 大 导致 匹配 效率 低下 假设 这个 
局部 大小 设为 16 * 16 像素 大小 每一个 像素 
值 对应 RGB 3个 数值 那么 每个 特征点 就 对应 
一个 786 维 的 向量 也 就是 每个 点 要用 
786 个数 表示 考虑到 尺度 与 旋转 不变量 这个 向量 
又 需要 乘上 十几 倍 甚至 几十 倍 以 覆 
盖 所有 的 变化 假设 一个 图片 如果 包含 上千 
个 特征点 而 数据库 包含 上 千张 图片 那么 在 
匹配 时 庞大 的 计算 量 无疑 是 对 CPU 
的 一场 灾难 为了 保证 提取 出来 的 特征向量 具有 
旋转 不变量 的 特性 首先 要 做 的 是 在 
每个 特征点 找到 一个 方向 而 这个 方向 和 局部 
图像 的 特性 应当 是 一致 的 也 就是说 理想 
状态 下 如果 旋转 这个 局部 图片 那么 重新 提取 
这 个 方向 也和 之前 相比 旋转 相同 角度 SIFT 
里 选择 这个 角度 的 方式 是 在 高斯 模糊 
之后 的 局部 图片 里 计算 每 一个 像素点 的 
角度 与 大小 之后 进行 投票 选 出 所有 像素 
最多 的 那个 角度 作 为主 方向 下图 为 计算 
这个 角度 和 大小 的 公式 看似 很长 实际上 只是 
计算 横竖 相邻 像素 之间 的 差值 和 m 和 
角度 θ 于是 局部 图像 产生 的 差值 和 角度 
可以 通过 这种 方式 形成 特征向量 或 称为 关键点 描述 
子 Keypoint Descriptor 形 成 这个 向量 的 方式 是 
量化 这些 角度 比如说 把 360度 平均 分成 8 等分 
然后 根据 位置 累计 起来 上图 表示 的 是 一个 
8x8 的 局部 采样 计算出 的 2x2 的 特征 矩阵 
实际上 一般 使用 的 是 16x16 局部 采样 形成 4x4 
特征 矩阵 所以 如果 把 这个 矩阵 拉成 向量 也 
就是 包含 8 * 4 * 4 = 128个 元素 
形成 特征向量 之后 下 一个 问题 就是 如何 匹配 了 
最 基本 的 方式 可以 称作 最 邻近 搜索 Nearest 
Neighbour 实际上 也 就是 找 在 128 维空间 上 直线 
距离 最近 的 的 特征向量 这个 求 直线 距离 的 
方式 和2维/nr 无异 最近 的 特征 向量 也就 被 认为 
是 互相 匹 配 原作者 使用 的 方式 是 增加 
了 k d tree 算法 来 高效率 地 完成 高维 
度上 的 最 邻近 搜索 理论 部分 结束 二 图片 
匹配 接 下来 的 目标 就是 找到 所有 匹配 也 
就是 重叠 的 图片 部分 接连 所有 图片 之后 就 
可以 形成 一个 基本 的 全景图 了 因为/c 每/zg 张/q 
图片/n 有/v 可能/v 和/c 其他/r 每张/r 图片/n 有/v 重叠/v 部分/n 
所 以 匹配 全部 图片 需要 差不多 匹配 图片 个数 
的 平方 次 不过 实际上 每 两张 图片 之间 只 
需要 那么 几个 相对 精准 匹配 的 点 就 可以 
估算 出 这 两张 图像 里 的 几何 关系 最 
普遍 的 方式 是 用 RANSAC RANdom SAmple Consensus 随机抽样 
一致 在 这里 的 用途 就是 排除 掉 不 符合 
大部分 几何变换 的 匹配 之后 利用 这些 匹配 的 点来 
估算/v 单应/nr 矩阵/n Homography Estimation 也/d 就是/d 把/p 其中/r 一张/m 
通过/p 个/q 关联性/n 和/c 另一/i 张/q 匹配/v 的/uj 方法/n 在 
之后 会 详细 介绍 上图 即为 用 RANSAC 找出 符合 
几何 约束 的 特征 点 之后 通过/p 单/n 应/v 矩阵/n 
来/v 对齐/d 两张/m 图片/n 的/uj 内容/n RANSAC 理论 部分 首先 
介绍 一下 RANSAC 的 原理 RANSAC 是 一种 迭代 算法 
Iteration Method 用来 从 观测 数据 中 估算 出 数学 
模型 的 参数 此 基础 上 便 可以 分离 内 
群 Inliers 与 离群 Outliers 数据 简单 来说 就是 一般 
来 讲 观测 的 数据 里 经常 会 出现 很多 
噪音 比如说 像 SIFT 匹配 有时 就 会 因为 不同 
地方 有 类似 的 图案 导致 匹配 错误 而 RANSAC 
就是 通过 反复 取样 也 就是 从 整个 观测/vn 数据/n 
中/f 随机/d 抽/v 一些/m 数据/n 估算/v 模型/n 参数/n 之后/f 看/v 
和/c 所有/b 数据误差/n 有/v 多大/i 然后 取 误差 最小 视为 
最好 以及 分离 内 群 与 离群 数据 下 图 
這 裡 用 一 個 簡 單 的 例子 來 
說 明 在 一 組 數 據 點 中 找到 
一 條 最 適 合 的 線 假 設 此 
有一組/nr 集合 包含 了 內 群 以及 離 群 其中 
內 群 為 可以 被 擬 合到 線 段上的/nr 點 
而 離 群 則 是 無 法被擬/nr 合 的 點 
如果 我們 用 簡 單 的 最 小平 方法 來 
找 此 線 我們 將 無 法 得到 一 條 
適 合 於內群/nr 的 線 因 為 最 小平 方法 
會 受 離 群 影 響 而 影 響 其 
結 果 而 RANSAC 可以 只由 內 群 來 計 
算出 模型 而且 概率 還 夠 高 然而 RANSAC 無 
法保證/nr 結 果 一定 最好 所以 必 須 小心 選 
擇 參 數 使其 能有 足 夠 的 概率 下图 
是 一个 简单 的 例子 用 RANSAC 来找 出 符合 
内 群 的 直线 的 参数 可以 看做 是 找 
y = ax + b 里 的 a 和b/nr 以及 
内 群 数据 本身 之所以 RANSAC 能在 有 大量 噪音 
情况 仍然 准确 主要 原因 是 随机取样 时 只取 一 
部分 可以 避免 估算 结果 被 离群 数据 影响 流程 
为 以下 摘自 维基 需要 补充 这个 流程 的 是 
判断 数据 是否 符合 模型 的 阈值 以及 重复 多少次 
步骤 是 要 自行 定义 的 并且 决定 了 整个 
流程 相对 的 准确度 与 运算 时间 总结 一下 的话 
RANSAC 算法 的 输入 为 1 . 观测 数据 包括 
内 群 与外 群 的 数据 2 . 符合 部分 
观测 数据 的 模型 与 内 群 相符 的 模型 
3 . 最少 符合 模型 的 内 群 数量 4 
. 判断 数据 是否 符合 模型 的 阈值 数据 与 
模型 之间 的 误差 容忍度 5 . 迭代 运算 次数 
抽取 多少次 随 机内 群 输出 为 1 . 最 
符合 数据 的 模型 参数 如果 内 群 数量 小于 
输入 第三 条则 判断 为 数据 不 存在 此 模型 
2 . 内 群集 符合 模型 的 数据 优点 能在 
包含 大量 外 群 的 数据 中 准确 地 找到 
模型 参数 并且 参数 不 受到 外 群 影响 缺 
点 计算 参数 时 没有 一个 最大 运算 时间 的 
顶 限 也 就是说 在 迭代 次数 被 限制 的 
情况 下 得 出来 的 参数 结果 有 可能 并 
不是 最优 的 甚至 可能 不 符合 真实 内 群 
所以 设定 RANSAC 参数 的 时候 要 根据 应用 考虑 
准确度 与 效率 哪 一个 更 重要 以此 决定 做 
多少 次 迭代 运算 设定 与 模型 的 最大 误差 
阈值 也是 要 自己 调 因 应用 而异 还 有 
一点 就是 RANSAC 只能 估算 一个 模型 理论 部分 结束 
RANSAC 应用于 点 匹配 的 效果 基于 前 图 匹配 
时 不符合 绝大多数 几何变换 的 判断 为 匹配 错误 并 
排除 Homography Estimation 找到 两张 图里 正确 的 匹配 之后 
就 可以 利用 这些 点来 估算 两张 图 之间 的 
几何变换 关系 简单 来说 就是 假设 固定 其中 一张 图 
在 桌子 上 如何 摆放 旋转 拉伸 另 一张 图 
使其 与 第一 张 重合 待 补充 假设有 一对 匹配 
点 和 他们/r 之间/f 的/uj 单应/nr 矩阵/n 便是/v 下图/v 公式/n 
中的/i H/w 待 补充 或许 很多 朋友 会 好奇 其中 的 神秘 比如说 为 
什么 不同 角度 拍摄 的 图片 拼接 的 时候 可以 
自动 对齐 略 准确 来讲 也 就是 如何 处理 图片 
之间 的 仿射 畸变 和 透视 失 真 如何 能 
自动 找到 图片 之间 可以 粘连 的 部分 并且 准确无误 
地 拼接 在 一起 如何 平衡 图片 之间 光线 色调 
的 差异 等等 其实/d 每/zg 一步/m 的/uj 背后/f 或多或少/d 都有/nr 
比较/d 复杂/a 却又/i 相当 精妙 的 技术 和 算法 所以 
这次 尝试 用 比较 直观 的 方式 给 大家 介绍 
一下 每一步 的 工作 原理 逆转 对 前沿 科技 虽 
不明 但 觉 厉 的 看法 那么 先 描述 一下 
整个 流程 图片 之间 1 . 特征点 匹配 找到 素材 
图片 中 共有 的 图像 部分 2 . 图片 匹配 
连接 匹配 的 特征点 估算 图像 间 几何 方面 的 
变换 全局 优化 和 无缝 衔接 3 . 全景图 矫直 
矫正 拍摄 图片 时 相机 的 相对 3D 旋转 主要 
原因 是 拍摄 图片 时 相机 很 可能 并不 在 
同一 水平线 上 并且 存在 不同 程度 的 倾斜 略过 
这一步 可能 导致 全景图 变成 波浪 形状 4 . 图像 
均衡 补偿 全局 平衡 所有 图片 的 光照 和 色调 
5 . 图像 频段 融合 步骤 4 之后 仍然 会 
存在 图像 之间 衔接 边缘 晕 影 效果 图像 的 
外围 部分 的 亮度 或 饱和度 比 中心 区域 低 
视差 效果 因为 相机 透镜 移动 导致 一 特征点 匹配 
合成 全景图 的 第一步 是 提取 并且 匹配 所有 素材 
图片 的 局部 特征点 1 . 什么 是 特征点 普遍 
来讲 一张 图片 所 包含 的 特征点 通常 就 是 
周围 含有 较大 信息量 的 点 而 仅 通过 这些 
富有 特征 的 局部 基本 就 可以 推测 出 整张 
图片 比如说 物体 的 棱角 夜景 闪耀 的 星星 或是 
图片 里 的 图案 和 花纹 图中 框内 即为 判断 
富有 特征 的 部分 实 际 上人 在 识别 某个 
东西 或是 图案 的 时候 也 是 通过 观察 这个 
物体 具有 哪种 特征 然后 与 自己 的 经历 和 
记忆 所 匹配 举例来说 去 超市 看到 一个 水果 假设 
我们 观察 到这 个 水果 是 绿色 颜色 特征 球形 
形状 特征 有 黑色 纹路 图案 特征 于是 我们 可以 
通过 经验 判断 出 这 是个 西瓜 当然 人 还会 
通过 各种 其他 特征 来 增强 对 物体 的 判断力 
只是 整个 从 收到 信息 到 做出 判断 的 过程 
行云流水 甚至 自己 都 察觉 不到 这 就是 生物 视觉 
的 精妙 之处 只可惜 距离 破解 生物 视觉 系统 目前 
看来 似乎 仍是 遥 不可 及 所以在 神经网络 破解 并 
模拟 生物 大脑 的 运作 之前 就 先由 计算机 视觉 
来 承担 这个 重担 了 稍稍 有些 跑题 那么 继续 
之前 的 问题 提取 何种 特征 并且 如何 提取 特征 
如 前面 所说 一幅 图片 具有 形形色色 各种 特征 简单 
的 可以 是 颜色 形状 或 图案 复杂 的 比如 
说 可以 是 图案 的 自 相似性 是否 存在 类似 
重复性 图案 或是 整个 场景 里 其 他 的 物体 
好比 说 在 超市 的 水果 架上 我们 可以 更能 
确信 西瓜 就是 西瓜 而 水果 架 这个 背景 即 
为特征 实际上 提取 这些 特征 在 计算机 视觉 领域 里 
也 占有 相当 重要 的 位 置 毕竟 好 的 
特征 选择 是 整个 识别 系统 可以 成功 运转 的 
大前提 理论 部分 在 合成 全景图 的 流程 里 运用 
的 是 点 匹配 也 就是 匹配 局部 图片 信息 
因为 局部 图片 能 提取 的 特征 有限 比如说 形状 
特征 在 这种 情况 就 不适宜 所以 一般 采用 通过 
整个 局部 的 图案 来 判断 是否 符合 作为 特征 
的 条件 其中 运用 最 普遍 的 为 SIFT 特征 
Scale invariant feature transform 即 尺度 不变 特征 转换 其 
应用 范围 包含 物体 辨识 机器人 地图 感知 与 导航 
影像 缝合 3D 模型 建立 手势 辨识 影像 追踪 和 
动作 比对 此 算法 由 David Lowe 在 1999年 所 
发表 在 急速 发展 的 计算机 视觉 领域内 至今 仍然 
被 普遍 认为 是 最好 的 即 State of the 
art 特征 侦测 与 描述 算法 提取 SIFT 特征 分为 
两步 侦测 与 描述 形成 特征向量 简 单 来讲 侦测 
就是 扫描 图片 所有 的 尺度 下 的 所有 位置 
尺度 可以 理解 为 局部 缩放 而 判断 一个 点 
作为 特征点 合 不合格 需要 计算 在 这个 尺度 下 
的 高斯 差 DoG Difference of Gaussians 的 局部 极值 
Local Extrema 如 第一张 图 所示 每一个 尺度 Scale 下 
对 局部 影像 进行 不同 尺度 的 高斯 模糊 局部 
影像 与 高斯 滤波器 的 卷积 取 差值 局部 极值 
计 算方 式 如 第二 张图/nr 所示 将 测试 像素 
的 DoG 的 数值 与其 26个 邻接 像素 比较 取其 
最大 最小 极值 也 就是 测试 像素 的 特征 度 
即便 找到 了 特征点 单纯 匹配 特征点 周围 的 局部 
影像 是 行不通 的 首先 SIFT 特征 本身 最大 的 
优点 就是 位置 尺度 旋转 不变量 也 就是说 在 一定 
范围 内旋转 或是 拉 远 拉近 相机 可以 检测 出 
相同 的 特征 点 位置 Repeatability 以及 提取 出 相同 
的 特征向量 Scale & Rotation Invariant 所以 不同 角度 条件 
拍摄 的 图片 才 可以 通过 SIFT 特征 匹配 而 
像素 数值 是 不具备 这些 特点 的 再者 局部 影像 
的 像素 信息量 大 导致 匹配 效率 低下 假设 这个 
局部 大小 设为 16 * 16 像素 大小 每一个 像素 
值 对应 RGB 3个 数值 那么 每个 特征点 就 对应 
一个 786 维 的 向量 也 就是 每个 点 要用 
786 个数 表示 考虑到 尺度 与 旋转 不变量 这个 向量 
又 需要 乘上 十几 倍 甚至 几十 倍 以 覆 
盖 所有 的 变化 假设 一个 图片 如果 包含 上千 
个 特征点 而 数据库 包含 上 千张 图片 那么 在 
匹配 时 庞大 的 计算 量 无疑 是 对 CPU 
的 一场 灾难 为了 保证 提取 出来 的 特征向量 具有 
旋转 不变量 的 特性 首先 要 做 的 是 在 
每个 特征点 找到 一个 方向 而 这个 方向 和 局部 
图像 的 特性 应当 是 一致 的 也 就是说 理想 
状态 下 如果 旋转 这个 局部 图片 那么 重新 提取 
这 个 方向 也和 之前 相比 旋转 相同 角度 SIFT 
里 选择 这个 角度 的 方式 是 在 高斯 模糊 
之后 的 局部 图片 里 计算 每 一个 像素点 的 
角度 与 大小 之后 进行 投票 选 出 所有 像素 
最多 的 那个 角度 作 为主 方向 下图 为 计算 
这个 角度 和 大小 的 公式 看似 很长 实际上 只是 
计算 横竖 相邻 像素 之间 的 差值 和 m 和 
角度 θ 于是 局部 图像 产生 的 差值 和 角度 
可以 通过 这种 方式 形成 特征向量 或 称为 关键点 描述 
子 Keypoint Descriptor 形 成 这个 向量 的 方式 是 
量化 这些 角度 比如说 把 360度 平均 分成 8 等分 
然后 根据 位置 累计 起来 上图 表示 的 是 一个 
8x8 的 局部 采样 计算出 的 2x2 的 特征 矩阵 
实际上 一般 使用 的 是 16x16 局部 采样 形成 4x4 
特征 矩阵 所以 如果 把 这个 矩阵 拉成 向量 也 
就是 包含 8 * 4 * 4 = 128个 元素 
形成 特征向量 之后 下 一个 问题 就是 如何 匹配 了 
最 基本 的 方式 可以 称作 最 邻近 搜索 Nearest 
Neighbour 实际上 也 就是 找 在 128 维空间 上 直线 
距离 最近 的 的 特征向量 这个 求 直线 距离 的 
方式 和2维/nr 无异 最近 的 特征 向量 也就 被 认为 
是 互相 匹 配 原作者 使用 的 方式 是 增加 
了 k d tree 算法 来 高效率 地 完成 高维 
度上 的 最 邻近 搜索 理论 部分 结束 二 图片 
匹配 接 下来 的 目标 就是 找到 所有 匹配 也 
就是 重叠 的 图片 部分 接连 所有 图片 之后 就 
可以 形成 一个 基本 的 全景图 了 因为/c 每/zg 张/q 
图片/n 有/v 可能/v 和/c 其他/r 每张/r 图片/n 有/v 重叠/v 部分/n 
所 以 匹配 全部 图片 需要 差不多 匹配 图片 个数 
的 平方 次 不过 实际上 每 两张 图片 之间 只 
需要 那么 几个 相对 精准 匹配 的 点 就 可以 
估算 出 这 两张 图像 里 的 几何 关系 最 
普遍 的 方式 是 用 RANSAC RANdom SAmple Consensus 随机抽样 
一致 在 这里 的 用途 就是 排除 掉 不 符合 
大部分 几何变换 的 匹配 之后 利用 这些 匹配 的 点来 
估算/v 单应/nr 矩阵/n Homography Estimation 也/d 就是/d 把/p 其中/r 一张/m 
通过/p 个/q 关联性/n 和/c 另一/i 张/q 匹配/v 的/uj 方法/n 在 
之后 会 详细 介绍 上图 即为 用 RANSAC 找出 符合 
几何 约束 的 特征 点 之后 通过/p 单/n 应/v 矩阵/n 
来/v 对齐/d 两张/m 图片/n 的/uj 内容/n RANSAC 理论 部分 首先 
介绍 一下 RANSAC 的 原理 RANSAC 是 一种 迭代 算法 
Iteration Method 用来 从 观测 数据 中 估算 出 数学 
模型 的 参数 此 基础 上 便 可以 分离 内 
群 Inliers 与 离群 Outliers 数据 简单 来说 就是 一般 
来 讲 观测 的 数据 里 经常 会 出现 很多 
噪音 比如说 像 SIFT 匹配 有时 就 会 因为 不同 
地方 有 类似 的 图案 导致 匹配 错误 而 RANSAC 
就是 通过 反复 取样 也 就是 从 整个 观测/vn 数据/n 
中/f 随机/d 抽/v 一些/m 数据/n 估算/v 模型/n 参数/n 之后/f 看/v 
和/c 所有/b 数据误差/n 有/v 多大/i 然后 取 误差 最小 视为 
最好 以及 分离 内 群 与 离群 数据 下 图 
這 裡 用 一 個 簡 單 的 例子 來 
說 明 在 一 組 數 據 點 中 找到 
一 條 最 適 合 的 線 假 設 此 
有一組/nr 集合 包含 了 內 群 以及 離 群 其中 
內 群 為 可以 被 擬 合到 線 段上的/nr 點 
而 離 群 則 是 無 法被擬/nr 合 的 點 
如果 我們 用 簡 單 的 最 小平 方法 來 
找 此 線 我們 將 無 法 得到 一 條 
適 合 於內群/nr 的 線 因 為 最 小平 方法 
會 受 離 群 影 響 而 影 響 其 
結 果 而 RANSAC 可以 只由 內 群 來 計 
算出 模型 而且 概率 還 夠 高 然而 RANSAC 無 
法保證/nr 結 果 一定 最好 所以 必 須 小心 選 
擇 參 數 使其 能有 足 夠 的 概率 下图 
是 一个 简单 的 例子 用 RANSAC 来找 出 符合 
内 群 的 直线 的 参数 可以 看做 是 找 
y = ax + b 里 的 a 和b/nr 以及 
内 群 数据 本身 之所以 RANSAC 能在 有 大量 噪音 
情况 仍然 准确 主要 原因 是 随机取样 时 只取 一 
部分 可以 避免 估算 结果 被 离群 数据 影响 流程 
为 以下 摘自 维基 需要 补充 这个 流程 的 是 
判断 数据 是否 符合 模型 的 阈值 以及 重复 多少次 
步骤 是 要 自行 定义 的 并且 决定 了 整个 
流程 相对 的 准确度 与 运算 时间 总结 一下 的话 
RANSAC 算法 的 输入 为 1 . 观测 数据 包括 
内 群 与外 群 的 数据 2 . 符合 部分 
观测 数据 的 模型 与 内 群 相符 的 模型 
3 . 最少 符合 模型 的 内 群 数量 4 
. 判断 数据 是否 符合 模型 的 阈值 数据 与 
模型 之间 的 误差 容忍度 5 . 迭代 运算 次数 
抽取 多少次 随 机内 群 输出 为 1 . 最 
符合 数据 的 模型 参数 如果 内 群 数量 小于 
输入 第三 条则 判断 为 数据 不 存在 此 模型 
2 . 内 群集 符合 模型 的 数据 优点 能在 
包含 大量 外 群 的 数据 中 准确 地 找到 
模型 参数 并且 参数 不 受到 外 群 影响 缺 
点 计算 参数 时 没有 一个 最大 运算 时间 的 
顶 限 也 就是说 在 迭代 次数 被 限制 的 
情况 下 得 出来 的 参数 结果 有 可能 并 
不是 最优 的 甚至 可能 不 符合 真实 内 群 
所以 设定 RANSAC 参数 的 时候 要 根据 应用 考虑 
准确度 与 效率 哪 一个 更 重要 以此 决定 做 
多少 次 迭代 运算 设定 与 模型 的 最大 误差 
阈值 也是 要 自己 调 因 应用 而异 还 有 
一点 就是 RANSAC 只能 估算 一个 模型 理论 部分 结束 
RANSAC 应用于 点 匹配 的 效果 基于 前 图 匹配 
时 不符合 绝大多数 几何变换 的 判断 为 匹配 错误 并 
排除 Homography Estimation 找到 两张 图里 正确 的 匹配 之后 
就 可以 利用 这些 点来 估算 两张 图 之间 的 
几何变换 关系 简单 来说 就是 假设 固定 其中 一张 图 
在 桌子 上 如何 摆放 旋转 拉伸 另 一张 图 
使其 与 第一 张 重合 待 补充 假设有 一对 匹配 
点 和 他们/r 之间/f 的/uj 单应/nr 矩阵/n 便是/v 下图/v 公式/n 
中的/i H/w 待 补充 或许 很多 朋友 会 好奇 其中 的 神秘 比如说 为 
什么 不同 角度 拍摄 的 图片 拼接 的 时候 可以 
自动 对齐 略 准确 来讲 也 就是 如何 处理 图片 
之间 的 仿射 畸变 和 透视 失 真 如何 能 
自动 找到 图片 之间 可以 粘连 的 部分 并且 准确无误 
地 拼接 在 一起 如何 平衡 图片 之间 光线 色调 
的 差异 等等 其实/d 每/zg 一步/m 的/uj 背后/f 或多或少/d 都有/nr 
比较/d 复杂/a 却又/i 相当 精妙 的 技术 和 算法 所以 
这次 尝试 用 比较 直观 的 方式 给 大家 介绍 
一下 每一步 的 工作 原理 逆转 对 前沿 科技 虽 
不明 但 觉 厉 的 看法 那么 先 描述 一下 
整个 流程 图片 之间 1 . 特征点 匹配 找到 素材 
图片 中 共有 的 图像 部分 2 . 图片 匹配 
连接 匹配 的 特征点 估算 图像 间 几何 方面 的 
变换 全局 优化 和 无缝 衔接 3 . 全景图 矫直 
矫正 拍摄 图片 时 相机 的 相对 3D 旋转 主要 
原因 是 拍摄 图片 时 相机 很 可能 并不 在 
同一 水平线 上 并且 存在 不同 程度 的 倾斜 略过 
这一步 可能 导致 全景图 变成 波浪 形状 4 . 图像 
均衡 补偿 全局 平衡 所有 图片 的 光照 和 色调 
5 . 图像 频段 融合 步骤 4 之后 仍然 会 
存在 图像 之间 衔接 边缘 晕 影 效果 图像 的 
外围 部分 的 亮度 或 饱和度 比 中心 区域 低 
视差 效果 因为 相机 透镜 移动 导致 一 特征点 匹配 
合成 全景图 的 第一步 是 提取 并且 匹配 所有 素材 
图片 的 局部 特征点 1 . 什么 是 特征点 普遍 
来讲 一张 图片 所 包含 的 特征点 通常 就 是 
周围 含有 较大 信息量 的 点 而 仅 通过 这些 
富有 特征 的 局部 基本 就 可以 推测 出 整张 
图片 比如说 物体 的 棱角 夜景 闪耀 的 星星 或是 
图片 里 的 图案 和 花纹 图中 框内 即为 判断 
富有 特征 的 部分 实 际 上人 在 识别 某个 
东西 或是 图案 的 时候 也 是 通过 观察 这个 
物体 具有 哪种 特征 然后 与 自己 的 经历 和 
记忆 所 匹配 举例来说 去 超市 看到 一个 水果 假设 
我们 观察 到这 个 水果 是 绿色 颜色 特征 球形 
形状 特征 有 黑色 纹路 图案 特征 于是 我们 可以 
通过 经验 判断 出 这 是个 西瓜 当然 人 还会 
通过 各种 其他 特征 来 增强 对 物体 的 判断力 
只是 整个 从 收到 信息 到 做出 判断 的 过程 
行云流水 甚至 自己 都 察觉 不到 这 就是 生物 视觉 
的 精妙 之处 只可惜 距离 破解 生物 视觉 系统 目前 
看来 似乎 仍是 遥 不可 及 所以在 神经网络 破解 并 
模拟 生物 大脑 的 运作 之前 就 先由 计算机 视觉 
来 承担 这个 重担 了 稍稍 有些 跑题 那么 继续 
之前 的 问题 提取 何种 特征 并且 如何 提取 特征 
如 前面 所说 一幅 图片 具有 形形色色 各种 特征 简单 
的 可以 是 颜色 形状 或 图案 复杂 的 比如 
说 可以 是 图案 的 自 相似性 是否 存在 类似 
重复性 图案 或是 整个 场景 里 其 他 的 物体 
好比 说 在 超市 的 水果 架上 我们 可以 更能 
确信 西瓜 就是 西瓜 而 水果 架 这个 背景 即 
为特征 实际上 提取 这些 特征 在 计算机 视觉 领域 里 
也 占有 相当 重要 的 位 置 毕竟 好 的 
特征 选择 是 整个 识别 系统 可以 成功 运转 的 
大前提 理论 部分 在 合成 全景图 的 流程 里 运用 
的 是 点 匹配 也 就是 匹配 局部 图片 信息 
因为 局部 图片 能 提取 的 特征 有限 比如说 形状 
特征 在 这种 情况 就 不适宜 所以 一般 采用 通过 
整个 局部 的 图案 来 判断 是否 符合 作为 特征 
的 条件 其中 运用 最 普遍 的 为 SIFT 特征 
Scale invariant feature transform 即 尺度 不变 特征 转换 其 
应用 范围 包含 物体 辨识 机器人 地图 感知 与 导航 
影像 缝合 3D 模型 建立 手势 辨识 影像 追踪 和 
动作 比对 此 算法 由 David Lowe 在 1999年 所 
发表 在 急速 发展 的 计算机 视觉 领域内 至今 仍然 
被 普遍 认为 是 最好 的 即 State of the 
art 特征 侦测 与 描述 算法 提取 SIFT 特征 分为 
两步 侦测 与 描述 形成 特征向量 简 单 来讲 侦测 
就是 扫描 图片 所有 的 尺度 下 的 所有 位置 
尺度 可以 理解 为 局部 缩放 而 判断 一个 点 
作为 特征点 合 不合格 需要 计算 在 这个 尺度 下 
的 高斯 差 DoG Difference of Gaussians 的 局部 极值 
Local Extrema 如 第一张 图 所示 每一个 尺度 Scale 下 
对 局部 影像 进行 不同 尺度 的 高斯 模糊 局部 
影像 与 高斯 滤波器 的 卷积 取 差值 局部 极值 
计 算方 式 如 第二 张图/nr 所示 将 测试 像素 
的 DoG 的 数值 与其 26个 邻接 像素 比较 取其 
最大 最小 极值 也 就是 测试 像素 的 特征 度 
即便 找到 了 特征点 单纯 匹配 特征点 周围 的 局部 
影像 是 行不通 的 首先 SIFT 特征 本身 最大 的 
优点 就是 位置 尺度 旋转 不变量 也 就是说 在 一定 
范围 内旋转 或是 拉 远 拉近 相机 可以 检测 出 
相同 的 特征 点 位置 Repeatability 以及 提取 出 相同 
的 特征向量 Scale & Rotation Invariant 所以 不同 角度 条件 
拍摄 的 图片 才 可以 通过 SIFT 特征 匹配 而 
像素 数值 是 不具备 这些 特点 的 再者 局部 影像 
的 像素 信息量 大 导致 匹配 效率 低下 假设 这个 
局部 大小 设为 16 * 16 像素 大小 每一个 像素 
值 对应 RGB 3个 数值 那么 每个 特征点 就 对应 
一个 786 维 的 向量 也 就是 每个 点 要用 
786 个数 表示 考虑到 尺度 与 旋转 不变量 这个 向量 
又 需要 乘上 十几 倍 甚至 几十 倍 以 覆 
盖 所有 的 变化 假设 一个 图片 如果 包含 上千 
个 特征点 而 数据库 包含 上 千张 图片 那么 在 
匹配 时 庞大 的 计算 量 无疑 是 对 CPU 
的 一场 灾难 为了 保证 提取 出来 的 特征向量 具有 
旋转 不变量 的 特性 首先 要 做 的 是 在 
每个 特征点 找到 一个 方向 而 这个 方向 和 局部 
图像 的 特性 应当 是 一致 的 也 就是说 理想 
状态 下 如果 旋转 这个 局部 图片 那么 重新 提取 
这 个 方向 也和 之前 相比 旋转 相同 角度 SIFT 
里 选择 这个 角度 的 方式 是 在 高斯 模糊 
之后 的 局部 图片 里 计算 每 一个 像素点 的 
角度 与 大小 之后 进行 投票 选 出 所有 像素 
最多 的 那个 角度 作 为主 方向 下图 为 计算 
这个 角度 和 大小 的 公式 看似 很长 实际上 只是 
计算 横竖 相邻 像素 之间 的 差值 和 m 和 
角度 θ 于是 局部 图像 产生 的 差值 和 角度 
可以 通过 这种 方式 形成 特征向量 或 称为 关键点 描述 
子 Keypoint Descriptor 形 成 这个 向量 的 方式 是 
量化 这些 角度 比如说 把 360度 平均 分成 8 等分 
然后 根据 位置 累计 起来 上图 表示 的 是 一个 
8x8 的 局部 采样 计算出 的 2x2 的 特征 矩阵 
实际上 一般 使用 的 是 16x16 局部 采样 形成 4x4 
特征 矩阵 所以 如果 把 这个 矩阵 拉成 向量 也 
就是 包含 8 * 4 * 4 = 128个 元素 
形成 特征向量 之后 下 一个 问题 就是 如何 匹配 了 
最 基本 的 方式 可以 称作 最 邻近 搜索 Nearest 
Neighbour 实际上 也 就是 找 在 128 维空间 上 直线 
距离 最近 的 的 特征向量 这个 求 直线 距离 的 
方式 和2维/nr 无异 最近 的 特征 向量 也就 被 认为 
是 互相 匹 配 原作者 使用 的 方式 是 增加 
了 k d tree 算法 来 高效率 地 完成 高维 
度上 的 最 邻近 搜索 理论 部分 结束 二 图片 
匹配 接 下来 的 目标 就是 找到 所有 匹配 也 
就是 重叠 的 图片 部分 接连 所有 图片 之后 就 
可以 形成 一个 基本 的 全景图 了 因为/c 每/zg 张/q 
图片/n 有/v 可能/v 和/c 其他/r 每张/r 图片/n 有/v 重叠/v 部分/n 
所 以 匹配 全部 图片 需要 差不多 匹配 图片 个数 
的 平方 次 不过 实际上 每 两张 图片 之间 只 
需要 那么 几个 相对 精准 匹配 的 点 就 可以 
估算 出 这 两张 图像 里 的 几何 关系 最 
普遍 的 方式 是 用 RANSAC RANdom SAmple Consensus 随机抽样 
一致 在 这里 的 用途 就是 排除 掉 不 符合 
大部分 几何变换 的 匹配 之后 利用 这些 匹配 的 点来 
估算/v 单应/nr 矩阵/n Homography Estimation 也/d 就是/d 把/p 其中/r 一张/m 
通过/p 个/q 关联性/n 和/c 另一/i 张/q 匹配/v 的/uj 方法/n 在 
之后 会 详细 介绍 上图 即为 用 RANSAC 找出 符合 
几何 约束 的 特征 点 之后 通过/p 单/n 应/v 矩阵/n 
来/v 对齐/d 两张/m 图片/n 的/uj 内容/n RANSAC 理论 部分 首先 
介绍 一下 RANSAC 的 原理 RANSAC 是 一种 迭代 算法 
Iteration Method 用来 从 观测 数据 中 估算 出 数学 
模型 的 参数 此 基础 上 便 可以 分离 内 
群 Inliers 与 离群 Outliers 数据 简单 来说 就是 一般 
来 讲 观测 的 数据 里 经常 会 出现 很多 
噪音 比如说 像 SIFT 匹配 有时 就 会 因为 不同 
地方 有 类似 的 图案 导致 匹配 错误 而 RANSAC 
就是 通过 反复 取样 也 就是 从 整个 观测/vn 数据/n 
中/f 随机/d 抽/v 一些/m 数据/n 估算/v 模型/n 参数/n 之后/f 看/v 
和/c 所有/b 数据误差/n 有/v 多大/i 然后 取 误差 最小 视为 
最好 以及 分离 内 群 与 离群 数据 下 图 
這 裡 用 一 個 簡 單 的 例子 來 
說 明 在 一 組 數 據 點 中 找到 
一 條 最 適 合 的 線 假 設 此 
有一組/nr 集合 包含 了 內 群 以及 離 群 其中 
內 群 為 可以 被 擬 合到 線 段上的/nr 點 
而 離 群 則 是 無 法被擬/nr 合 的 點 
如果 我們 用 簡 單 的 最 小平 方法 來 
找 此 線 我們 將 無 法 得到 一 條 
適 合 於內群/nr 的 線 因 為 最 小平 方法 
會 受 離 群 影 響 而 影 響 其 
結 果 而 RANSAC 可以 只由 內 群 來 計 
算出 模型 而且 概率 還 夠 高 然而 RANSAC 無 
法保證/nr 結 果 一定 最好 所以 必 須 小心 選 
擇 參 數 使其 能有 足 夠 的 概率 下图 
是 一个 简单 的 例子 用 RANSAC 来找 出 符合 
内 群 的 直线 的 参数 可以 看做 是 找 
y = ax + b 里 的 a 和b/nr 以及 
内 群 数据 本身 之所以 RANSAC 能在 有 大量 噪音 
情况 仍然 准确 主要 原因 是 随机取样 时 只取 一 
部分 可以 避免 估算 结果 被 离群 数据 影响 流程 
为 以下 摘自 维基 需要 补充 这个 流程 的 是 
判断 数据 是否 符合 模型 的 阈值 以及 重复 多少次 
步骤 是 要 自行 定义 的 并且 决定 了 整个 
流程 相对 的 准确度 与 运算 时间 总结 一下 的话 
RANSAC 算法 的 输入 为 1 . 观测 数据 包括 
内 群 与外 群 的 数据 2 . 符合 部分 
观测 数据 的 模型 与 内 群 相符 的 模型 
3 . 最少 符合 模型 的 内 群 数量 4 
. 判断 数据 是否 符合 模型 的 阈值 数据 与 
模型 之间 的 误差 容忍度 5 . 迭代 运算 次数 
抽取 多少次 随 机内 群 输出 为 1 . 最 
符合 数据 的 模型 参数 如果 内 群 数量 小于 
输入 第三 条则 判断 为 数据 不 存在 此 模型 
2 . 内 群集 符合 模型 的 数据 优点 能在 
包含 大量 外 群 的 数据 中 准确 地 找到 
模型 参数 并且 参数 不 受到 外 群 影响 缺 
点 计算 参数 时 没有 一个 最大 运算 时间 的 
顶 限 也 就是说 在 迭代 次数 被 限制 的 
情况 下 得 出来 的 参数 结果 有 可能 并 
不是 最优 的 甚至 可能 不 符合 真实 内 群 
所以 设定 RANSAC 参数 的 时候 要 根据 应用 考虑 
准确度 与 效率 哪 一个 更 重要 以此 决定 做 
多少 次 迭代 运算 设定 与 模型 的 最大 误差 
阈值 也是 要 自己 调 因 应用 而异 还 有 
一点 就是 RANSAC 只能 估算 一个 模型 理论 部分 结束 
RANSAC 应用于 点 匹配 的 效果 基于 前 图 匹配 
时 不符合 绝大多数 几何变换 的 判断 为 匹配 错误 并 
排除 Homography Estimation 找到 两张 图里 正确 的 匹配 之后 
就 可以 利用 这些 点来 估算 两张 图 之间 的 
几何变换 关系 简单 来说 就是 假设 固定 其中 一张 图 
在 桌子 上 如何 摆放 旋转 拉伸 另 一张 图 
使其 与 第一 张 重合 待 补充 假设有 一对 匹配 
点 和 他们/r 之间/f 的/uj 单应/nr 矩阵/n 便是/v 下图/v 公式/n 
中的/i H/w 待 补充 