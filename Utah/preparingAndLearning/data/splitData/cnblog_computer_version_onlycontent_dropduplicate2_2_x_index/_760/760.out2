零/m,、/w,参考/v,资料/n,有关/vn,fpn/en,的/u,介绍/v,见/v,『/w,计算机/n,视觉/n,』/w,fpn/en,特征/n,金字塔/n,网络/n,。/w,网络/n,构架/n,部分/n,代码/n,见/v,mask/en,_,rcnn/en,//w,mrcnn/en,//w,model/en,./w,py/en,中/f,class/en, ,maskrcnn/en,的/u,build/en,方法/n,的/u,"/w,inference/en,"/w,分支/n,。/w,1/m,、/w,keras/en,调用/v,gpu/en,设置/v,【/w,*/w,】/w,指定/v,gpuimport/en, ,os/en, ,os/en,./w,environ/en,[/w,"/w,cuda/en,_,visible/en,_,devices/en,"/w,]/w, ,=/w, ,"/w,2/m,"/w,【/w,*/w,*/w,】/w,按需分配/l,import/en, ,tensorflow/en, ,as/en, ,tf/en, ,import/en, ,keras/en,./w,backend/en,./w,tensorflow/en,_,backend/en, ,as/en, ,ktf/en, ,config/en, ,=/w, ,tf/en,./w,configproto/en,(/w,)/w, ,config/en,./w,gpu/en,_,options/en,./w,allow/en,_,growth/en,=/w,true/en, ,#,不/d,全部/m,占/v,满/a,显/v,存/v,,/w, ,按需分配/l, ,#, ,config/en,./w,gpu/en,_,options/en,./w,per/en,_,process/en,_,gpu/en,_,memory/en,_,fraction/en, ,=/w, ,0.3/m, ,#,指定/v,分配/vn,30%/mq,空间/n, ,sess/en, ,=/w, ,tf/en,./w,session/en,(/w,config/en,=/w,config/en,)/w,#, ,设置/v,session/en, ,ktf/en,./w,set/en,_,session/en,(/w,sess/en,)/w,2/m,、/w,tensorflow/en,和/c,keras/en,交互/v,说明/v,下面/f,的/u,交互/v,方法/n,几乎/d,都/d,是/v,对/p,keras/en,的/u,函数/n,式/k,api/en,操作/v,的/u,，/w,不过/c,keras/en,的/u,函数/n,模型/n,转换/v,为/p,model/en,对象/n,也/d,极为/d,方便/a,，/w,km/en,./w,model/en,(/w,input/en,_,tensors/en,,/w, ,output/en,_,tensors/en,)/w,操作/v,一下/m,即可/v,。/w,【/w,*/w,】/w,使用/v,tensorflow/en,建立/v,keras/en,新/a,的/u,层/q,对象/n,在/p,网络/n,中/f,我们/r,可以/v,看到/v,大量/m,的/u,继承/v,了/u,keras/en,./w,engine/en,./w,layer/en,类/q,的/u,新/a,类/q,，/w,这/r,是/v,因为/c,如果/c,tensorflow/en,函数/n,可以/v,操作/v,keras/en,的/u,tensor/en,，/w,但是/c,其/r,返回/v,的/u,tensorflow/en,的/u,tensor/en,不能/v,被/p,keras/en,继续/v,处理/v,，/w,所以/c,我们/r,需要/v,建立/v,新/a,的/u,keras/en,层/q,进行/v,转换/v,，/w,将/d,tf/en,的/u,tensor/en,可/v,作为/v,keras/en,层/q,的/u,_,_,init/en,_,_,参数/n,参与/v,层/q,构建/v,，/w,在/p,_,_,call/en,_,_,方法/n,内部/f,使用/v,tf/en,的/u,函数/n,进行/v,细粒度/nz,数据/n,处理/v,，/w,最后/f,返回/v,的/u,是/v,keras/en,层/q,对象/n,。/w,如果/c,不/d,想/v,使用/v,model/en,类/q,的/u,各种/r,方便/a,方法/n,而/c,执意/d,手动/b,使用/v,tf/en,./w,session/en,(/w,)/w,训练/vn,的/u,话/n,就/d,没有/v,封装/vn,它们/r,的/u,必要/a,了/u,。/w,keras/en,的/u,tensor/en,可以/v,直接/ad,送入/v,tensorflow/en,中/f,：/w,import/en, ,tensorflow/en, ,as/en, ,tf/en, ,import/en, ,keras/en,./w,backend/en, ,as/en, ,k/en, ,rpn/en,_,match/en, ,=/w, ,tf/en,./w,placeholder/en,(/w,tf/en,./w,int/en,8/m,,/w, ,[/w,10/m,,/w, ,2/m,]/w,)/w, ,tf/en,./w,where/en,(/w,k/en,./w,equal/en,(/w,rpn/en,_,match/en,,/w, ,1/m,)/w,)/w,一个/m,class/en,实现/v,例子/n,如下/v,，/w,注意/v,需要/v,推断/vn,输出/v,的/u,shape/en,：/w,class/en, ,pyramidroialign/en,(/w,ke/en,./w,layer/en,)/w,:/w, ,"/w,"/w,"/w,implements/en, ,roi/en, ,pooling/en, ,on/en, ,multiple/en, ,levels/en, ,of/en, ,the/en, ,feature/en, ,pyramid/en,./w, ,params/en,:/w, ,-/w, ,pool/en,_,shape/en,:/w, ,[/w,pool/en,_,height/en,,/w, ,pool/en,_,width/en,]/w, ,of/en, ,the/en, ,output/en, ,pooled/en, ,regions/en,./w, ,usually/en, ,[/w,7/m,,/w, ,7/m,]/w, ,inputs/en,:/w, ,-/w, ,boxes/en,:/w, ,[/w,batch/en,,/w, ,num/en,_,boxes/en,,/w, ,(/w,y/en,1/m,,/w, ,x/en,1/m,,/w, ,y/en,2/m,,/w, ,x/en,2/m,)/w,]/w, ,in/en, ,normalized/en, ,coordinates/en,./w, ,possibly/en, ,padded/en, ,with/en, ,zeros/en, ,if/en, ,not/en, ,enough/en, ,boxes/en, ,to/en, ,fill/en, ,the/en, ,array/en,./w, ,-/w, ,image/en,_,meta/en,:/w, ,[/w,batch/en,,/w, ,(/w,meta/en, ,data/en,)/w,]/w, ,image/en, ,details/en,./w, ,see/en, ,compose/en,_,image/en,_,meta/en,(/w,)/w, ,-/w, ,feature/en,_,maps/en,:/w, ,list/en, ,of/en, ,feature/en, ,maps/en, ,from/en, ,different/en, ,levels/en, ,of/en, ,the/en, ,pyramid/en,./w, ,each/en, ,is/en, ,[/w,batch/en,,/w, ,height/en,,/w, ,width/en,,/w, ,channels/en,]/w, ,output/en,:/w, ,pooled/en, ,regions/en, ,in/en, ,the/en, ,shape/en,:/w, ,[/w,batch/en,,/w, ,num/en,_,boxes/en,,/w, ,pool/en,_,height/en,,/w, ,pool/en,_,width/en,,/w, ,channels/en,]/w,./w, ,the/en, ,width/en, ,and/en, ,height/en, ,are/en, ,those/en, ,specific/en, ,in/en, ,the/en, ,pool/en,_,shape/en, ,in/en, ,the/en, ,layer/en, ,constructor/en,./w, ,"/w,"/w,"/w, ,def/en, ,_,_,init/en,_,_,(/w,self/en,,/w, ,pool/en,_,shape/en,,/w, ,*/w,*/w,kwargs/en,)/w,:/w, ,super/en,(/w,pyramidroialign/en,,/w, ,self/en,)/w,./w,_,_,init/en,_,_,(/w,*/w,*/w,kwargs/en,)/w, ,self/en,./w,pool/en,_,shape/en, ,=/w, ,tuple/en,(/w,pool/en,_,shape/en,)/w, ,def/en, ,call/en,(/w,self/en,,/w, ,inputs/en,)/w,:/w, ,#, ,num/en,_,boxes/en,指/v,的/u,是/v,proposal/en,数目/n,，/w,它们/r,均/d,会/v,作用/n,于/p,每张/r,图片/n,上/f,，/w,只是/d,不同/a,的/u,proposal/en,作用/n,于/p,图片/n, ,#, ,的/u,特征/n,级别/n,不同/a,，/w,我/r,通过/p,循环/vn,特征/n,层/q,寻找/v,符合/v,的/u,proposal/en,，/w,应用/vn,roialign/en, ,#, ,crop/en, ,boxes/en, ,[/w,batch/en,,/w, ,num/en,_,boxes/en,,/w, ,(/w,y/en,1/m,,/w, ,x/en,1/m,,/w, ,y/en,2/m,,/w, ,x/en,2/m,)/w,]/w, ,in/en, ,normalized/en, ,coords/en, ,boxes/en, ,=/w, ,inputs/en,[/w,0/m,]/w, ,#, ,image/en, ,meta/en, ,#, ,holds/en, ,details/en, ,about/en, ,the/en, ,image/en,./w, ,see/en, ,compose/en,_,image/en,_,meta/en,(/w,)/w, ,image/en,_,meta/en, ,=/w, ,inputs/en,[/w,1/m,]/w, ,#, ,feature/en, ,maps/en,./w, ,list/en, ,of/en, ,feature/en, ,maps/en, ,from/en, ,different/en, ,level/en, ,of/en, ,the/en, ,#, ,feature/en, ,pyramid/en,./w, ,each/en, ,is/en, ,[/w,batch/en,,/w, ,height/en,,/w, ,width/en,,/w, ,channels/en,]/w, ,feature/en,_,maps/en, ,=/w, ,inputs/en,[/w,2/m,:/w,]/w, ,#, ,assign/en, ,each/en, ,roi/en, ,to/en, ,a/en, ,level/en, ,in/en, ,the/en, ,pyramid/en, ,based/en, ,on/en, ,the/en, ,roi/en, ,area/en,./w, ,y/en,1/m,,/w, ,x/en,1/m,,/w, ,y/en,2/m,,/w, ,x/en,2/m, ,=/w, ,tf/en,./w,split/en,(/w,boxes/en,,/w, ,4/m,,/w, ,axis/en,=/w,2/m,)/w, ,h/en, ,=/w, ,y/en,2/m, ,-/w, ,y/en,1/m, ,w/en, ,=/w, ,x/en,2/m, ,-/w, ,x/en,1/m, ,#, ,use/en, ,shape/en, ,of/en, ,first/en, ,image/en,./w, ,images/en, ,in/en, ,a/en, ,batch/en, ,must/en, ,have/en, ,the/en, ,same/en, ,size/en,./w, ,image/en,_,shape/en, ,=/w, ,parse/en,_,image/en,_,meta/en,_,graph/en,(/w,image/en,_,meta/en,)/w,[/w,'/w,image/en,_,shape/en,'/w,]/w,[/w,0/m,]/w, ,#, ,h/en,,/w, ,w/en,,/w, ,c/en, ,#, ,equation/en, ,1/m, ,in/en, ,the/en, ,feature/en, ,pyramid/en, ,networks/en, ,paper/en,./w, ,account/en, ,for/en, ,#, ,the/en, ,fact/en, ,that/en, ,our/en, ,coordinates/en, ,are/en, ,normalized/en, ,here/en,./w, ,#, ,e/en,./w,g/en,./w, ,a/en, ,224/m,x/en,224/m, ,roi/en, ,(/w,in/en, ,pixels/en,)/w, ,maps/en, ,to/en, ,p/en,4/m, ,image/en,_,area/en, ,=/w, ,tf/en,./w,cast/en,(/w,image/en,_,shape/en,[/w,0/m,]/w, ,*/w, ,image/en,_,shape/en,[/w,1/m,]/w,,/w, ,tf/en,./w,float/en,32/m,)/w, ,roi/en,_,level/en, ,=/w, ,log/en,2/m,_,graph/en,(/w,tf/en,./w,sqrt/en,(/w,h/en, ,*/w, ,w/en,)/w, ,//w, ,(/w,224.0/m, ,//w, ,tf/en,./w,sqrt/en,(/w,image/en,_,area/en,)/w,)/w,)/w, ,#, ,h/en,、/w,w/en,已经/d,归/v,一/m,化/v, ,roi/en,_,level/en, ,=/w, ,tf/en,./w,minimum/en,(/w,5/m,,/w, ,tf/en,./w,maximum/en,(/w, ,2/m,,/w, ,4/m, ,+/w, ,tf/en,./w,cast/en,(/w,tf/en,./w,round/en,(/w,roi/en,_,level/en,)/w,,/w, ,tf/en,./w,int/en,32/m,)/w,)/w,)/w, ,#, ,确保/v,值位/nw,于/p,2/m,到/v,5/m,之间/f, ,roi/en,_,level/en, ,=/w, ,tf/en,./w,squeeze/en,(/w,roi/en,_,level/en,,/w, ,2/m,)/w, ,#, ,[/w,batch/en,,/w, ,num/en,_,boxes/en,]/w, ,#, ,loop/en, ,through/en, ,levels/en, ,and/en, ,apply/en, ,roi/en, ,pooling/en, ,to/en, ,each/en,./w, ,p/en,2/m, ,to/en, ,p/en,5/m,./w, ,pooled/en, ,=/w, ,[/w,]/w, ,box/en,_,to/en,_,level/en, ,=/w, ,[/w,]/w, ,for/en, ,i/en,,/w, ,level/en, ,in/en, ,enumerate/en,(/w,range/en,(/w,2/m,,/w, ,6/m,)/w,)/w,:/w, ,#, ,tf/en,./w,where/en, ,返回/v,值/n,格式/n, ,[/w,坐标/n,1/m,,/w, ,坐标/n,2/m,……/w,]/w, ,#, ,np/en,./w,where/en, ,返回/v,值/n,格式/n, ,[/w,[/w,坐标/n,1/m,./w,x/en,,/w, ,坐标/n,2/m,./w,x/en,……/w,]/w,,/w, ,[/w,坐标/n,1/m,./w,y/en,,/w, ,坐标/n,2/m,./w,y/en,……/w,]/w,]/w, ,ix/en, ,=/w, ,tf/en,./w,where/en,(/w,tf/en,./w,equal/en,(/w,roi/en,_,level/en,,/w, ,level/en,)/w,)/w, ,#, ,返回/v,坐标/n,表示/v,：/w,第/m,n/en,张/q,图片/n,的/u,第/m,i/en,个/q,proposal/en, ,level/en,_,boxes/en, ,=/w, ,tf/en,./w,gather/en,_,nd/en,(/w,boxes/en,,/w, ,ix/en,)/w, ,#, ,[/w,本/r,level/en,的/u,proposal/en,数目/n,,/w, ,4/m,]/w, ,#, ,box/en, ,indices/en, ,for/en, ,crop/en,_,and/en,_,resize/en,./w, ,box/en,_,indices/en, ,=/w, ,tf/en,./w,cast/en,(/w,ix/en,[/w,:/w,,/w, ,0/m,]/w,,/w, ,tf/en,./w,int/en,32/m,)/w, ,#, ,记录/v,每个/r,propose/en,对应/v,图片/n,序号/n, ,#, ,keep/en, ,track/en, ,of/en, ,which/en, ,box/en, ,is/en, ,mapped/en, ,to/en, ,which/en, ,level/en, ,box/en,_,to/en,_,level/en,./w,append/en,(/w,ix/en,)/w, ,#, ,stop/en, ,gradient/en, ,propogation/en, ,to/en, ,roi/en, ,proposals/en, ,level/en,_,boxes/en, ,=/w, ,tf/en,./w,stop/en,_,gradient/en,(/w,level/en,_,boxes/en,)/w, ,box/en,_,indices/en, ,=/w, ,tf/en,./w,stop/en,_,gradient/en,(/w,box/en,_,indices/en,)/w, ,#, ,crop/en, ,and/en, ,resize/en, ,#, ,from/en, ,mask/en, ,r/en,-/w,cnn/en, ,paper/en,:/w, ,"/w,we/en, ,sample/en, ,four/en, ,regular/en, ,locations/en,,/w, ,so/en, ,#, ,that/en, ,we/en, ,can/en, ,evaluate/en, ,either/en, ,max/en, ,or/en, ,average/en, ,pooling/en,./w, ,in/en, ,fact/en,,/w, ,#, ,interpolating/en, ,only/en, ,a/en, ,single/en, ,value/en, ,at/en, ,each/en, ,bin/en, ,center/en, ,(/w,without/en, ,#, ,pooling/en,)/w, ,is/en, ,nearly/en, ,as/en, ,effective/en,./w,"/w, ,#, ,#, ,here/en, ,we/en, ,use/en, ,the/en, ,simplified/en, ,approach/en, ,of/en, ,a/en, ,single/en, ,value/en, ,per/en, ,bin/en,,/w, ,#, ,which/en, ,is/en, ,how/en, ,it/en,'/w,s/en, ,done/en, ,in/en, ,tf/en,./w,crop/en,_,and/en,_,resize/en,(/w,)/w, ,#, ,result/en,:/w, ,[/w,this/en,_,level/en,_,num/en,_,boxes/en,,/w, ,pool/en,_,height/en,,/w, ,pool/en,_,width/en,,/w, ,channels/en,]/w, ,pooled/en,./w,append/en,(/w,tf/en,./w,image/en,./w,crop/en,_,and/en,_,resize/en,(/w, ,feature/en,_,maps/en,[/w,i/en,]/w,,/w, ,level/en,_,boxes/en,,/w, ,box/en,_,indices/en,,/w, ,self/en,./w,pool/en,_,shape/en,,/w, ,method/en,=/w,"/w,bilinear/en,"/w,)/w,)/w, ,#, ,输入/v,参数/n,shape/en,:/w, ,#, ,[/w,batch/en,,/w, ,image/en,_,height/en,,/w, ,image/en,_,width/en,,/w, ,channels/en,]/w, ,#, ,[/w,this/en,_,level/en,_,num/en,_,boxes/en,,/w, ,4/m,]/w, ,#, ,[/w,this/en,_,level/en,_,num/en,_,boxes/en,]/w, ,#, ,[/w,height/en,,/w, ,pool/en,_,width/en,]/w, ,#, ,pack/en, ,pooled/en, ,features/en, ,into/en, ,one/en, ,tensor/en, ,pooled/en, ,=/w, ,tf/en,./w,concat/en,(/w,pooled/en,,/w, ,axis/en,=/w,0/m,)/w, ,#, ,[/w,batch/en,*/w,num/en,_,boxes/en,,/w, ,pool/en,_,height/en,,/w, ,pool/en,_,width/en,,/w, ,channels/en,]/w, ,#, ,pack/en, ,box/en,_,to/en,_,level/en, ,mapping/en, ,into/en, ,one/en, ,array/en, ,and/en, ,add/en, ,another/en, ,#, ,column/en, ,representing/en, ,the/en, ,order/en, ,of/en, ,pooled/en, ,boxes/en, ,box/en,_,to/en,_,level/en, ,=/w, ,tf/en,./w,concat/en,(/w,box/en,_,to/en,_,level/en,,/w, ,axis/en,=/w,0/m,)/w, ,#, ,[/w,batch/en,*/w,num/en,_,boxes/en,,/w, ,2/m,]/w, ,box/en,_,range/en, ,=/w, ,tf/en,./w,expand/en,_,dims/en,(/w,tf/en,./w,range/en,(/w,tf/en,./w,shape/en,(/w,box/en,_,to/en,_,level/en,)/w,[/w,0/m,]/w,)/w,,/w, ,1/m,)/w, ,#, ,[/w,batch/en,*/w,num/en,_,boxes/en,,/w, ,1/m,]/w, ,box/en,_,to/en,_,level/en, ,=/w, ,tf/en,./w,concat/en,(/w,[/w,tf/en,./w,cast/en,(/w,box/en,_,to/en,_,level/en,,/w, ,tf/en,./w,int/en,32/m,)/w,,/w, ,box/en,_,range/en,]/w,,/w, ,axis/en,=/w,1/m,)/w, ,#, ,[/w,batch/en,*/w,num/en,_,boxes/en,,/w, ,3/m,]/w, ,#, ,截止/vn,到/v,目前/t,，/w,我们/r,获取/v,了/u,记录/v,全部/m,roialign/en,结果/n,feat/en,集合/v,的/u,张量/nr,pooled/en,，/w,和/c,记录/v,这些/r,feat/en,相关/v,信息/n,的/u,张量/nr,box/en,_,to/en,_,level/en,，/w, ,#, ,由于/c,提取/v,方法/n,的/u,原因/n,，/w,此时/r,的/u,feat/en,并/c,不/d,是/v,按照/p,原始/a,顺序/n,排序/vn,（/w,先/d,按/p,batch/en,然后/c,按/p,box/en, ,index/en,排序/vn,）/w,，/w,下面/f,我们/r,设法/v,将/d,之/u,恢复/v,顺/a, ,#, ,序/n,（/w,roialign/en,作用/n,于/p,对应/v,图片/n,的/u,对应/v,proposal/en,生成/vn,feat/en,）/w, ,#, ,rearrange/en, ,pooled/en, ,features/en, ,to/en, ,match/en, ,the/en, ,order/en, ,of/en, ,the/en, ,original/en, ,boxes/en, ,#, ,sort/en, ,box/en,_,to/en,_,level/en, ,by/en, ,batch/en, ,then/en, ,box/en, ,index/en, ,#, ,tf/en, ,doesn/en,'/w,t/en, ,have/en, ,a/en, ,way/en, ,to/en, ,sort/en, ,by/en, ,two/en, ,columns/en,,/w, ,so/en, ,merge/en, ,them/en, ,and/en, ,sort/en,./w, ,#, ,box/en,_,to/en,_,level/en,[/w,i/en,,/w, ,0/m,]/w,表示/v,的/u,是/v,当前/t,feat/en,隶属/v,的/u,图片/n,索引/n,，/w,box/en,_,to/en,_,level/en,[/w,i/en,,/w, ,1/m,]/w,表示/v,的/u,是/v,其/r,box/en,序号/n, ,sorting/en,_,tensor/en, ,=/w, ,box/en,_,to/en,_,level/en,[/w,:/w,,/w, ,0/m,]/w, ,*/w, ,100000/m, ,+/w, ,box/en,_,to/en,_,level/en,[/w,:/w,,/w, ,1/m,]/w, ,#, ,[/w,batch/en,*/w,num/en,_,boxes/en,]/w, ,ix/en, ,=/w, ,tf/en,./w,nn/en,./w,top/en,_,k/en,(/w,sorting/en,_,tensor/en,,/w, ,k/en,=/w,tf/en,./w,shape/en,(/w, ,box/en,_,to/en,_,level/en,)/w,[/w,0/m,]/w,)/w,./w,indices/en,[/w,:/w,:/w,-/w,1/m,]/w, ,ix/en, ,=/w, ,tf/en,./w,gather/en,(/w,box/en,_,to/en,_,level/en,[/w,:/w,,/w, ,2/m,]/w,,/w, ,ix/en,)/w, ,pooled/en, ,=/w, ,tf/en,./w,gather/en,(/w,pooled/en,,/w, ,ix/en,)/w, ,#, ,re/en,-/w,add/en, ,the/en, ,batch/en, ,dimension/en, ,#, ,[/w,batch/en,,/w, ,num/en,_,boxes/en,,/w, ,(/w,y/en,1/m,,/w, ,x/en,1/m,,/w, ,y/en,2/m,,/w, ,x/en,2/m,)/w,]/w,,/w, ,[/w,batch/en,*/w,num/en,_,boxes/en,,/w, ,pool/en,_,height/en,,/w, ,pool/en,_,width/en,,/w, ,channels/en,]/w, ,shape/en, ,=/w, ,tf/en,./w,concat/en,(/w,[/w,tf/en,./w,shape/en,(/w,boxes/en,)/w,[/w,:/w,2/m,]/w,,/w, ,tf/en,./w,shape/en,(/w,pooled/en,)/w,[/w,1/m,:/w,]/w,]/w,,/w, ,axis/en,=/w,0/m,)/w, ,pooled/en, ,=/w, ,tf/en,./w,reshape/en,(/w,pooled/en,,/w, ,shape/en,)/w, ,return/en, ,pooled/en, ,#, ,[/w,batch/en,,/w, ,num/en,_,boxes/en,,/w, ,pool/en,_,height/en,,/w, ,pool/en,_,width/en,,/w, ,channels/en,]/w, ,def/en, ,compute/en,_,output/en,_,shape/en,(/w,self/en,,/w, ,input/en,_,shape/en,)/w,:/w, ,return/en, ,input/en,_,shape/en,[/w,0/m,]/w,[/w,:/w,2/m,]/w, ,+/w, ,self/en,./w,pool/en,_,shape/en, ,+/w, ,(/w,input/en,_,shape/en,[/w,2/m,]/w,[/w,-/w,1/m,]/w,,/w, ,)/w,【/w,*/w,*/w,】/w,keras/en,的/u,lambda/en,函数/n,可以/v,直接/ad,将/d,tensorflow/en,操作/v,引入/v,keraskeras/en,的/u,module/en,不能/v,接收/v,tf/en,的/u,tensor/en,作为/v,数据流/n,，/w,所有/b,需要/v,使用/v,kl/en,./w,lambda/en,将/d,之/u,转化/v,为/p,keras/en,的/u,数据流/n,，/w,如下/v,这样/r,将/d,tf/en,写/v,好/a,的/u,函数/n,输出/v,直接/ad,转换/v,为/p,keras/en,的/u,module/en,可以/v,接收/v,的/u,类型/n,，/w,和/c,上面/f,的/u,方法/n,1/m,相比/v,，/w,这里/r,的/u,lambda/en,接受/v,外部/f,参数/n,（/w,一般/a,位于/v,类/q,的/u,_,_,inti/en,_,_,中/f,）/w,调整/vn,函数/n,行为/n,并/c,不/d,方便/a,：/w,rpn/en,_,bbox/en, ,=/w, ,kl/en,./w,lambda/en,(/w,lambda/en, ,t/en,:/w, ,tf/en,./w,reshape/en,(/w,t/en,,/w, ,[/w,tf/en,./w,shape/en,(/w,t/en,)/w,[/w,0/m,]/w,,/w, ,-/w,1/m,,/w, ,4/m,]/w,)/w,)/w,(/w,x/en,)/w,【/w,*/w,*/w,*/w,】/w,继承/v,keras/en,./w,layer/en,的/u,层/q,对象/n,和/c,方法/n,1/m,相比/v,，/w,这种/r,方法/n,同样/d,需要/v,实现/v,_,_,call/en,_,_,方法/n,，/w,不过/c,一般/a,会/v,super/en,父/ng,类/q,，/w,用于/v,改写/v,keras/en,已经/d,实现/v,的/u,层/q,方法/n,。/w,class/en, ,batchnorm/en,(/w,kl/en,./w,batchnormalization/en,)/w,:/w, ,"/w,"/w,"/w,extends/en, ,the/en, ,keras/en, ,batchnormalization/en, ,class/en, ,to/en, ,allow/en, ,a/en, ,central/en, ,place/en, ,to/en, ,make/en, ,changes/en, ,if/en, ,needed/en,./w, ,batch/en, ,normalization/en, ,has/en, ,a/en, ,negative/en, ,effect/en, ,on/en, ,training/en, ,if/en, ,batches/en, ,are/en, ,small/en, ,so/en, ,this/en, ,layer/en, ,is/en, ,often/en, ,frozen/en, ,(/w,via/en, ,setting/en, ,in/en, ,config/en, ,class/en,)/w, ,and/en, ,functions/en, ,as/en, ,linear/en, ,layer/en,./w, ,"/w,"/w,"/w, ,def/en, ,call/en,(/w,self/en,,/w, ,inputs/en,,/w, ,training/en,=/w,none/en,)/w,:/w, ,"/w,"/w,"/w, ,note/en, ,about/en, ,training/en, ,values/en,:/w, ,none/en,:/w, ,train/en, ,bn/en, ,layers/en,./w, ,this/en, ,is/en, ,the/en, ,normal/en, ,mode/en, ,false/en,:/w, ,freeze/en, ,bn/en, ,layers/en,./w, ,good/en, ,when/en, ,batch/en, ,size/en, ,is/en, ,small/en, ,true/en,:/w, ,(/w,don/en,'/w,t/en, ,use/en,)/w,./w, ,set/en, ,layer/en, ,in/en, ,training/en, ,mode/en, ,even/en, ,when/en, ,making/en, ,inferences/en, ,"/w,"/w,"/w, ,return/en, ,super/en,(/w,self/en,./w,_,_,class/en,_,_,,/w, ,self/en,)/w,./w,call/en,(/w,inputs/en,,/w, ,training/en,=/w,training/en,)/w,一/m,、/w,共享/v,网络/n,概览/n,按照/p,逻辑/n,顺序/n,，/w,我们/r,首先/d,来/v,看/v,处于/v,流程/n,图/n,左上角/nw,的/u,整/m,张/q,图/n,最/d,大/a,的/u,组成/v,分支/n,：/w,特征/n,提取/v,网络/n,。/w,可以/v,看到/v,本/r,部分/n,大致/d,分为/v,以下/f,几/m,个/q,部分/n,（/w,即/v,原/b,图/n,的/u,三列/mq,）/w,：/w,resnet/en,101/m,部分/n,（/w,fpn/en,的/u,bottom/en,-/w,up/en,部分/n,）/w,fpn/en,的/u,up/en,-/w,bottom/en,部分/n,和/c,横向/n,连接/v,部分/n,最终/d,特征/n,重构/v,部分/n,二/m,、/w,源码/nw,浏览/vn,整个/b,maskrcnn/en,类/q,初始化/v,之后/f,的/u,第一/m,个/q,方法/n,就/d,是/v,build/en,网络/n,用/p,的/u,，/w,在/p,mode/en,参数/n,为/p,inference/en,情况/n,下/f,，/w,下面/f,给/p,出/v,了/u,正式/ad,建立/v,特征/n,提取/v,网络/n,之前/f,的/u,class/en,内部/f,前置/n,代码/n,，/w,class/en, ,maskrcnn/en,(/w,)/w,:/w, ,"/w,"/w,"/w,encapsulates/en, ,the/en, ,mask/en, ,rcnn/en, ,model/en, ,functionality/en,./w, ,the/en, ,actual/en, ,keras/en, ,model/en, ,is/en, ,in/en, ,the/en, ,keras/en,_,model/en, ,property/en,./w, ,"/w,"/w,"/w, ,def/en, ,_,_,init/en,_,_,(/w,self/en,,/w, ,mode/en,,/w, ,config/en,,/w, ,model/en,_,dir/en,)/w,:/w, ,"/w,"/w,"/w, ,mode/en,:/w, ,either/en, ,"/w,training/en,"/w, ,or/en, ,"/w,inference/en,"/w, ,config/en,:/w, ,a/en, ,sub/en,-/w,class/en, ,of/en, ,the/en, ,config/en, ,class/en, ,model/en,_,dir/en,:/w, ,directory/en, ,to/en, ,save/en, ,training/en, ,logs/en, ,and/en, ,trained/en, ,weights/en, ,"/w,"/w,"/w, ,assert/en, ,mode/en, ,in/en, ,[/w,'/w,training/en,'/w,,/w, ,'/w,inference/en,'/w,]/w, ,self/en,./w,mode/en, ,=/w, ,mode/en, ,self/en,./w,config/en, ,=/w, ,config/en, ,self/en,./w,model/en,_,dir/en, ,=/w, ,model/en,_,dir/en, ,self/en,./w,set/en,_,log/en,_,dir/en,(/w,)/w, ,self/en,./w,keras/en,_,model/en, ,=/w, ,self/en,./w,build/en,(/w,mode/en,=/w,mode/en,,/w, ,config/en,=/w,config/en,)/w, ,def/en, ,build/en,(/w,self/en,,/w, ,mode/en,,/w, ,config/en,)/w,:/w, ,"/w,"/w,"/w,build/en, ,mask/en, ,r/en,-/w,cnn/en, ,architecture/en,./w, ,input/en,_,shape/en,:/w, ,the/en, ,shape/en, ,of/en, ,the/en, ,input/en, ,image/en,./w, ,mode/en,:/w, ,either/en, ,"/w,training/en,"/w, ,or/en, ,"/w,inference/en,"/w,./w, ,the/en, ,inputs/en, ,and/en, ,outputs/en, ,of/en, ,the/en, ,model/en, ,differ/en, ,accordingly/en,./w, ,"/w,"/w,"/w, ,assert/en, ,mode/en, ,in/en, ,[/w,'/w,training/en,'/w,,/w, ,'/w,inference/en,'/w,]/w, ,　,　,　,　, ,#, ,image/en, ,size/en, ,must/en, ,be/en, ,dividable/en, ,by/en, ,2/m, ,multiple/en, ,times/en, ,h/en,,/w, ,w/en, ,=/w, ,config/en,./w,image/en,_,shape/en,[/w,:/w,2/m,]/w, ,#, ,[/w,1024/m, ,1024/m, ,3/m,]/w, ,if/en, ,h/en, ,//w, ,2/m,*/w,*/w,6/m, ,!/w,=/w, ,int/en,(/w,h/en, ,//w, ,2/m,*/w,*/w,6/m,)/w, ,or/en, ,w/en, ,//w, ,2/m,*/w,*/w,6/m, ,!/w,=/w, ,int/en,(/w,w/en, ,//w, ,2/m,*/w,*/w,6/m,)/w,:/w, ,raise/en, ,exception/en,(/w,"/w,image/en, ,size/en, ,must/en, ,be/en, ,dividable/en, ,by/en, ,2/m, ,at/en, ,least/en, ,6/m, ,times/en, ,"/w, ,"/w,to/en, ,avoid/en, ,fractions/en, ,when/en, ,downscaling/en, ,and/en, ,upscaling/en,./w,"/w, ,#, ,</w,-----/nrf, ,"/w,for/en, ,example/en,,/w, ,use/en, ,256/m,,/w, ,320/m,,/w, ,384/m,,/w, ,448/m,,/w, ,512/m,,/w, ,./w,./w,./w, ,etc/en,./w, ,"/w,)/w, ,#, ,inputs/en, ,input/en,_,image/en, ,=/w, ,kl/en,./w,input/en,(/w, ,shape/en,=/w,[/w,none/en,,/w, ,none/en,,/w, ,config/en,./w,image/en,_,shape/en,[/w,2/m,]/w,]/w,,/w, ,name/en,=/w,"/w,input/en,_,image/en,"/w,)/w, ,input/en,_,image/en,_,meta/en, ,=/w, ,kl/en,./w,input/en,(/w,shape/en,=/w,[/w,config/en,./w,image/en,_,meta/en,_,size/en,]/w,,/w, ,name/en,=/w,"/w,input/en,_,image/en,_,meta/en,"/w,)/w, ,if/en, ,mode/en, ,=/w,=/w, ,"/w,training/en,"/w,:/w, ,……/w, ,elif/en, ,mode/en, ,=/w,=/w, ,"/w,inference/en,"/w,:/w, ,#, ,anchors/en, ,in/en, ,normalized/en, ,coordinates/en, ,input/en,_,anchors/en, ,=/w, ,kl/en,./w,input/en,(/w,shape/en,=/w,[/w,none/en,,/w, ,4/m,]/w,,/w, ,name/en,=/w,"/w,input/en,_,anchors/en,"/w,)/w,这里/r,强制/vn,要求/v,了/u,图片/n,裁剪/v,后/f,尺度/n,为/p,2/m,^,n/en,，/w,且/c,n/en,>,=/w,6/m,，/w,保证/v,下/f,采样/v,后/f,不/d,产生/v,小数/n,整个/b,程序/n,需要/v,外部/f,输入/v,的/u,变量/n,（/w,inference/en,模式/n,）/w,仅/d,有/v,三个/m,，/w,注意/v,keras/en,的/u,习惯/n,不同/a,于/p,placeholder/en,，/w,上面/f,代码/n,的/u,shape/en,没有/v,包含/v,batch/en,，/w,实际/n,shape/en,是/v,下面/f,的/u,样式/n,：/w,input/en,_,image/en,：/w,输入/v,图片/n,，/w,[/w,batch/en,,/w, ,none/en,,/w, ,none/en,,/w, ,config/en,./w,image/en,_,shape/en,[/w,2/m,]/w,]/w,input/en,_,image/en,_,meta/en,：/w,图片/n,的/u,信息/n,（/w,包含/v,形状/n,、/w,预/d,处理/v,信息/n,等/u,，/w,后面/f,会/v,介绍/v,）/w,，/w,[/w,batch/en,,/w, ,config/en,./w,image/en,_,meta/en,_,size/en,]/w,input/en,_,anchors/en,：/w,锚框/nw,，/w,[/w,batch/en,,/w, ,none/en,,/w, ,4/m,]/w,resnet/en,101/m,部分/n,接/v,上面/f,build/en,函数/n,代码/n,，/w,经由/p,如下/v,判断/v,（/w,inference/en,中/f,该/r,参数/n,是/v,字符/n,串/v,"/w,resnet/en,101/m,"/w,，/w,所以/c,进入/v,else/en,分支/n,）/w,，/w,建立/v,resnet/en,网络/n,图/n,，/w,#, ,build/en, ,the/en, ,shared/en, ,convolutional/en, ,layers/en,./w, ,#, ,bottom/en,-/w,up/en, ,layers/en, ,#, ,returns/en, ,a/en, ,list/en, ,of/en, ,the/en, ,last/en, ,layers/en, ,of/en, ,each/en, ,stage/en,,/w, ,5/m, ,in/en, ,total/en,./w, ,#, ,don/en,'/w,t/en, ,create/en, ,the/en, ,thead/en, ,(/w,stage/en, ,5/m,)/w,,/w, ,so/en, ,we/en, ,pick/en, ,the/en, ,4/m,th/en, ,item/en, ,in/en, ,the/en, ,list/en,./w, ,if/en, ,callable/en,(/w,config/en,./w,backbone/en,)/w,:/w, ,_,,/w, ,c/en,2/m,,/w, ,c/en,3/m,,/w, ,c/en,4/m,,/w, ,c/en,5/m, ,=/w, ,config/en,./w,backbone/en,(/w,input/en,_,image/en,,/w, ,stage/en,5/m,=/w,true/en,,/w, ,train/en,_,bn/en,=/w,config/en,./w,train/en,_,bn/en,)/w, ,else/en,:/w, ,_,,/w, ,c/en,2/m,,/w, ,c/en,3/m,,/w, ,c/en,4/m,,/w, ,c/en,5/m, ,=/w, ,resnet/en,_,graph/en,(/w,input/en,_,image/en,,/w, ,config/en,./w,backbone/en,,/w, ,stage/en,5/m,=/w,true/en,,/w, ,train/en,_,bn/en,=/w,config/en,./w,train/en,_,bn/en,)/w,上述/b,主/n,函数/n,调用/v,resnet/en,图/n,构建/v,代码/n,如下/v,，/w,其/r,包含/v,应用/vn,shortcut/en,和/c,没有/v,应用/vn,shortcut/en,两/m,种子/n,结构/n,：/w,(/w,图/n,摘自/v,网上/s,)/w,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#, ,#, ,resnet/en, ,graph/en, ,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#,#, ,#, ,code/en, ,adopted/en, ,from/en,:/w, ,#, ,https/en,:/w,//w,//w,github/en,./w,com/en,//w,fchollet/en,//w,deep/en,-/w,learning/en,-/w,models/en,//w,blob/en,//w,master/en,//w,resnet/en,50/m,./w,py/en, ,def/en, ,identity/en,_,block/en,(/w,input/en,_,tensor/en,,/w, ,kernel/en,_,size/en,,/w, ,filters/en,,/w, ,stage/en,,/w, ,block/en,,/w, ,use/en,_,bias/en,=/w,true/en,,/w, ,train/en,_,bn/en,=/w,true/en,)/w,:/w, ,"/w,"/w,"/w,the/en, ,identity/en,_,block/en, ,is/en, ,the/en, ,block/en, ,that/en, ,has/en, ,no/en, ,conv/en, ,layer/en, ,at/en, ,shortcut/en, ,#, ,arguments/en, ,input/en,_,tensor/en,:/w, ,input/en, ,tensor/en, ,kernel/en,_,size/en,:/w, ,default/en, ,3/m,,/w, ,the/en, ,kernel/en, ,size/en, ,of/en, ,middle/en, ,conv/en, ,layer/en, ,at/en, ,main/en, ,path/en, ,filters/en,:/w, ,list/en, ,of/en, ,integers/en,,/w, ,the/en, ,nb/en,_,filters/en, ,of/en, ,3/m, ,conv/en, ,layer/en, ,at/en, ,main/en, ,path/en, ,stage/en,:/w, ,integer/en,,/w, ,current/en, ,stage/en, ,label/en,,/w, ,used/en, ,for/en, ,generating/en, ,layer/en, ,names/en, ,block/en,:/w, ,'/w,a/en,'/w,,/w,'/w,b/en,'/w,./w,./w,./w,,/w, ,current/en, ,block/en, ,label/en,,/w, ,used/en, ,for/en, ,generating/en, ,layer/en, ,names/en, ,use/en,_,bias/en,:/w, ,boolean/en,./w, ,to/en, ,use/en, ,or/en, ,not/en, ,use/en, ,a/en, ,bias/en, ,in/en, ,conv/en, ,layers/en,./w, ,train/en,_,bn/en,:/w, ,boolean/en,./w, ,train/en, ,or/en, ,freeze/en, ,batch/en, ,norm/en, ,layers/en, ,"/w,"/w,"/w, ,nb/en,_,filter/en,1/m,,/w, ,nb/en,_,filter/en,2/m,,/w, ,nb/en,_,filter/en,3/m, ,=/w, ,filters/en, ,conv/en,_,name/en,_,base/en, ,=/w, ,'/w,res/en,'/w, ,+/w, ,str/en,(/w,stage/en,)/w, ,+/w, ,block/en, ,+/w, ,'/w,_,branch/en,'/w, ,bn/en,_,name/en,_,base/en, ,=/w, ,'/w,bn/en,'/w, ,+/w, ,str/en,(/w,stage/en,)/w, ,+/w, ,block/en, ,+/w, ,'/w,_,branch/en,'/w, ,x/en, ,=/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,nb/en,_,filter/en,1/m,,/w, ,(/w,1/m,,/w, ,1/m,)/w,,/w, ,name/en,=/w,conv/en,_,name/en,_,base/en, ,+/w, ,'/w,2/m,a/en,'/w,,/w, ,use/en,_,bias/en,=/w,use/en,_,bias/en,)/w,(/w,input/en,_,tensor/en,)/w, ,x/en, ,=/w, ,batchnorm/en,(/w,name/en,=/w,bn/en,_,name/en,_,base/en, ,+/w, ,'/w,2/m,a/en,'/w,)/w,(/w,x/en,,/w, ,training/en,=/w,train/en,_,bn/en,)/w, ,x/en, ,=/w, ,kl/en,./w,activation/en,(/w,'/w,relu/en,'/w,)/w,(/w,x/en,)/w, ,x/en, ,=/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,nb/en,_,filter/en,2/m,,/w, ,(/w,kernel/en,_,size/en,,/w, ,kernel/en,_,size/en,)/w,,/w, ,padding/en,=/w,'/w,same/en,'/w,,/w, ,name/en,=/w,conv/en,_,name/en,_,base/en, ,+/w, ,'/w,2/m,b/en,'/w,,/w, ,use/en,_,bias/en,=/w,use/en,_,bias/en,)/w,(/w,x/en,)/w, ,x/en, ,=/w, ,batchnorm/en,(/w,name/en,=/w,bn/en,_,name/en,_,base/en, ,+/w, ,'/w,2/m,b/en,'/w,)/w,(/w,x/en,,/w, ,training/en,=/w,train/en,_,bn/en,)/w, ,x/en, ,=/w, ,kl/en,./w,activation/en,(/w,'/w,relu/en,'/w,)/w,(/w,x/en,)/w, ,x/en, ,=/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,nb/en,_,filter/en,3/m,,/w, ,(/w,1/m,,/w, ,1/m,)/w,,/w, ,name/en,=/w,conv/en,_,name/en,_,base/en, ,+/w, ,'/w,2/m,c/en,'/w,,/w, ,use/en,_,bias/en,=/w,use/en,_,bias/en,)/w,(/w,x/en,)/w, ,x/en, ,=/w, ,batchnorm/en,(/w,name/en,=/w,bn/en,_,name/en,_,base/en, ,+/w, ,'/w,2/m,c/en,'/w,)/w,(/w,x/en,,/w, ,training/en,=/w,train/en,_,bn/en,)/w, ,x/en, ,=/w, ,kl/en,./w,add/en,(/w,)/w,(/w,[/w,x/en,,/w, ,input/en,_,tensor/en,]/w,)/w, ,x/en, ,=/w, ,kl/en,./w,activation/en,(/w,'/w,relu/en,'/w,,/w, ,name/en,=/w,'/w,res/en,'/w, ,+/w, ,str/en,(/w,stage/en,)/w, ,+/w, ,block/en, ,+/w, ,'/w,_,out/en,'/w,)/w,(/w,x/en,)/w, ,return/en, ,x/en, ,def/en, ,conv/en,_,block/en,(/w,input/en,_,tensor/en,,/w, ,kernel/en,_,size/en,,/w, ,filters/en,,/w, ,stage/en,,/w, ,block/en,,/w, ,strides/en,=/w,(/w,2/m,,/w, ,2/m,)/w,,/w, ,use/en,_,bias/en,=/w,true/en,,/w, ,train/en,_,bn/en,=/w,true/en,)/w,:/w, ,"/w,"/w,"/w,conv/en,_,block/en, ,is/en, ,the/en, ,block/en, ,that/en, ,has/en, ,a/en, ,conv/en, ,layer/en, ,at/en, ,shortcut/en, ,#, ,arguments/en, ,input/en,_,tensor/en,:/w, ,input/en, ,tensor/en, ,kernel/en,_,size/en,:/w, ,default/en, ,3/m,,/w, ,the/en, ,kernel/en, ,size/en, ,of/en, ,middle/en, ,conv/en, ,layer/en, ,at/en, ,main/en, ,path/en, ,filters/en,:/w, ,list/en, ,of/en, ,integers/en,,/w, ,the/en, ,nb/en,_,filters/en, ,of/en, ,3/m, ,conv/en, ,layer/en, ,at/en, ,main/en, ,path/en, ,stage/en,:/w, ,integer/en,,/w, ,current/en, ,stage/en, ,label/en,,/w, ,used/en, ,for/en, ,generating/en, ,layer/en, ,names/en, ,block/en,:/w, ,'/w,a/en,'/w,,/w,'/w,b/en,'/w,./w,./w,./w,,/w, ,current/en, ,block/en, ,label/en,,/w, ,used/en, ,for/en, ,generating/en, ,layer/en, ,names/en, ,use/en,_,bias/en,:/w, ,boolean/en,./w, ,to/en, ,use/en, ,or/en, ,not/en, ,use/en, ,a/en, ,bias/en, ,in/en, ,conv/en, ,layers/en,./w, ,train/en,_,bn/en,:/w, ,boolean/en,./w, ,train/en, ,or/en, ,freeze/en, ,batch/en, ,norm/en, ,layers/en, ,note/en, ,that/en, ,from/en, ,stage/en, ,3/m,,/w, ,the/en, ,first/en, ,conv/en, ,layer/en, ,at/en, ,main/en, ,path/en, ,is/en, ,with/en, ,subsample/en,=/w,(/w,2/m,,/w,2/m,)/w, ,and/en, ,the/en, ,shortcut/en, ,should/en, ,have/en, ,subsample/en,=/w,(/w,2/m,,/w,2/m,)/w, ,as/en, ,well/en, ,"/w,"/w,"/w, ,nb/en,_,filter/en,1/m,,/w, ,nb/en,_,filter/en,2/m,,/w, ,nb/en,_,filter/en,3/m, ,=/w, ,filters/en, ,conv/en,_,name/en,_,base/en, ,=/w, ,'/w,res/en,'/w, ,+/w, ,str/en,(/w,stage/en,)/w, ,+/w, ,block/en, ,+/w, ,'/w,_,branch/en,'/w, ,bn/en,_,name/en,_,base/en, ,=/w, ,'/w,bn/en,'/w, ,+/w, ,str/en,(/w,stage/en,)/w, ,+/w, ,block/en, ,+/w, ,'/w,_,branch/en,'/w, ,x/en, ,=/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,nb/en,_,filter/en,1/m,,/w, ,(/w,1/m,,/w, ,1/m,)/w,,/w, ,strides/en,=/w,strides/en,,/w, ,name/en,=/w,conv/en,_,name/en,_,base/en, ,+/w, ,'/w,2/m,a/en,'/w,,/w, ,use/en,_,bias/en,=/w,use/en,_,bias/en,)/w,(/w,input/en,_,tensor/en,)/w, ,x/en, ,=/w, ,batchnorm/en,(/w,name/en,=/w,bn/en,_,name/en,_,base/en, ,+/w, ,'/w,2/m,a/en,'/w,)/w,(/w,x/en,,/w, ,training/en,=/w,train/en,_,bn/en,)/w, ,x/en, ,=/w, ,kl/en,./w,activation/en,(/w,'/w,relu/en,'/w,)/w,(/w,x/en,)/w, ,x/en, ,=/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,nb/en,_,filter/en,2/m,,/w, ,(/w,kernel/en,_,size/en,,/w, ,kernel/en,_,size/en,)/w,,/w, ,padding/en,=/w,'/w,same/en,'/w,,/w, ,name/en,=/w,conv/en,_,name/en,_,base/en, ,+/w, ,'/w,2/m,b/en,'/w,,/w, ,use/en,_,bias/en,=/w,use/en,_,bias/en,)/w,(/w,x/en,)/w, ,x/en, ,=/w, ,batchnorm/en,(/w,name/en,=/w,bn/en,_,name/en,_,base/en, ,+/w, ,'/w,2/m,b/en,'/w,)/w,(/w,x/en,,/w, ,training/en,=/w,train/en,_,bn/en,)/w, ,x/en, ,=/w, ,kl/en,./w,activation/en,(/w,'/w,relu/en,'/w,)/w,(/w,x/en,)/w, ,x/en, ,=/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,nb/en,_,filter/en,3/m,,/w, ,(/w,1/m,,/w, ,1/m,)/w,,/w, ,name/en,=/w,conv/en,_,name/en,_,base/en, ,+/w, ,'/w,2/m,c/en,'/w,,/w, ,use/en,_,bias/en,=/w,use/en,_,bias/en,)/w,(/w,x/en,)/w, ,x/en, ,=/w, ,batchnorm/en,(/w,name/en,=/w,bn/en,_,name/en,_,base/en, ,+/w, ,'/w,2/m,c/en,'/w,)/w,(/w,x/en,,/w, ,training/en,=/w,train/en,_,bn/en,)/w, ,shortcut/en, ,=/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,nb/en,_,filter/en,3/m,,/w, ,(/w,1/m,,/w, ,1/m,)/w,,/w, ,strides/en,=/w,strides/en,,/w, ,name/en,=/w,conv/en,_,name/en,_,base/en, ,+/w, ,'/w,1/m,'/w,,/w, ,use/en,_,bias/en,=/w,use/en,_,bias/en,)/w,(/w,input/en,_,tensor/en,)/w, ,shortcut/en, ,=/w, ,batchnorm/en,(/w,name/en,=/w,bn/en,_,name/en,_,base/en, ,+/w, ,'/w,1/m,'/w,)/w,(/w,shortcut/en,,/w, ,training/en,=/w,train/en,_,bn/en,)/w, ,x/en, ,=/w, ,kl/en,./w,add/en,(/w,)/w,(/w,[/w,x/en,,/w, ,shortcut/en,]/w,)/w, ,x/en, ,=/w, ,kl/en,./w,activation/en,(/w,'/w,relu/en,'/w,,/w, ,name/en,=/w,'/w,res/en,'/w, ,+/w, ,str/en,(/w,stage/en,)/w, ,+/w, ,block/en, ,+/w, ,'/w,_,out/en,'/w,)/w,(/w,x/en,)/w, ,return/en, ,x/en, ,def/en, ,resnet/en,_,graph/en,(/w,input/en,_,image/en,,/w, ,architecture/en,,/w, ,stage/en,5/m,=/w,false/en,,/w, ,train/en,_,bn/en,=/w,true/en,)/w,:/w, ,"/w,"/w,"/w,build/en, ,a/en, ,resnet/en, ,graph/en,./w, ,architecture/en,:/w, ,can/en, ,be/en, ,resnet/en,50/m, ,or/en, ,resnet/en,101/m, ,stage/en,5/m,:/w, ,boolean/en,./w, ,if/en, ,false/en,,/w, ,stage/en,5/m, ,of/en, ,the/en, ,network/en, ,is/en, ,not/en, ,created/en, ,train/en,_,bn/en,:/w, ,boolean/en,./w, ,train/en, ,or/en, ,freeze/en, ,batch/en, ,norm/en, ,layers/en, ,"/w,"/w,"/w, ,assert/en, ,architecture/en, ,in/en, ,[/w,"/w,resnet/en,50/m,"/w,,/w, ,"/w,resnet/en,101/m,"/w,]/w, ,#, ,stage/en, ,1/m, ,x/en, ,=/w, ,kl/en,./w,zeropadding/en,2/m,d/en,(/w,(/w,3/m,,/w, ,3/m,)/w,)/w,(/w,input/en,_,image/en,)/w, ,x/en, ,=/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,64/m,,/w, ,(/w,7/m,,/w, ,7/m,)/w,,/w, ,strides/en,=/w,(/w,2/m,,/w, ,2/m,)/w,,/w, ,name/en,=/w,'/w,conv/en,1/m,'/w,,/w, ,use/en,_,bias/en,=/w,true/en,)/w,(/w,x/en,)/w, ,x/en, ,=/w, ,batchnorm/en,(/w,name/en,=/w,'/w,bn/en,_,conv/en,1/m,'/w,)/w,(/w,x/en,,/w, ,training/en,=/w,train/en,_,bn/en,)/w, ,x/en, ,=/w, ,kl/en,./w,activation/en,(/w,'/w,relu/en,'/w,)/w,(/w,x/en,)/w, ,c/en,1/m, ,=/w, ,x/en, ,=/w, ,kl/en,./w,maxpooling/en,2/m,d/en,(/w,(/w,3/m,,/w, ,3/m,)/w,,/w, ,strides/en,=/w,(/w,2/m,,/w, ,2/m,)/w,,/w, ,padding/en,=/w,"/w,same/en,"/w,)/w,(/w,x/en,)/w, ,#, ,stage/en, ,2/m, ,x/en, ,=/w, ,conv/en,_,block/en,(/w,x/en,,/w, ,3/m,,/w, ,[/w,64/m,,/w, ,64/m,,/w, ,256/m,]/w,,/w, ,stage/en,=/w,2/m,,/w, ,block/en,=/w,'/w,a/en,'/w,,/w, ,strides/en,=/w,(/w,1/m,,/w, ,1/m,)/w,,/w, ,train/en,_,bn/en,=/w,train/en,_,bn/en,)/w, ,x/en, ,=/w, ,identity/en,_,block/en,(/w,x/en,,/w, ,3/m,,/w, ,[/w,64/m,,/w, ,64/m,,/w, ,256/m,]/w,,/w, ,stage/en,=/w,2/m,,/w, ,block/en,=/w,'/w,b/en,'/w,,/w, ,train/en,_,bn/en,=/w,train/en,_,bn/en,)/w, ,c/en,2/m, ,=/w, ,x/en, ,=/w, ,identity/en,_,block/en,(/w,x/en,,/w, ,3/m,,/w, ,[/w,64/m,,/w, ,64/m,,/w, ,256/m,]/w,,/w, ,stage/en,=/w,2/m,,/w, ,block/en,=/w,'/w,c/en,'/w,,/w, ,train/en,_,bn/en,=/w,train/en,_,bn/en,)/w, ,#, ,stage/en, ,3/m, ,x/en, ,=/w, ,conv/en,_,block/en,(/w,x/en,,/w, ,3/m,,/w, ,[/w,128/m,,/w, ,128/m,,/w, ,512/m,]/w,,/w, ,stage/en,=/w,3/m,,/w, ,block/en,=/w,'/w,a/en,'/w,,/w, ,train/en,_,bn/en,=/w,train/en,_,bn/en,)/w, ,x/en, ,=/w, ,identity/en,_,block/en,(/w,x/en,,/w, ,3/m,,/w, ,[/w,128/m,,/w, ,128/m,,/w, ,512/m,]/w,,/w, ,stage/en,=/w,3/m,,/w, ,block/en,=/w,'/w,b/en,'/w,,/w, ,train/en,_,bn/en,=/w,train/en,_,bn/en,)/w, ,x/en, ,=/w, ,identity/en,_,block/en,(/w,x/en,,/w, ,3/m,,/w, ,[/w,128/m,,/w, ,128/m,,/w, ,512/m,]/w,,/w, ,stage/en,=/w,3/m,,/w, ,block/en,=/w,'/w,c/en,'/w,,/w, ,train/en,_,bn/en,=/w,train/en,_,bn/en,)/w, ,c/en,3/m, ,=/w, ,x/en, ,=/w, ,identity/en,_,block/en,(/w,x/en,,/w, ,3/m,,/w, ,[/w,128/m,,/w, ,128/m,,/w, ,512/m,]/w,,/w, ,stage/en,=/w,3/m,,/w, ,block/en,=/w,'/w,d/en,'/w,,/w, ,train/en,_,bn/en,=/w,train/en,_,bn/en,)/w, ,#, ,stage/en, ,4/m, ,x/en, ,=/w, ,conv/en,_,block/en,(/w,x/en,,/w, ,3/m,,/w, ,[/w,256/m,,/w, ,256/m,,/w, ,1024/m,]/w,,/w, ,stage/en,=/w,4/m,,/w, ,block/en,=/w,'/w,a/en,'/w,,/w, ,train/en,_,bn/en,=/w,train/en,_,bn/en,)/w, ,block/en,_,count/en, ,=/w, ,{/w,"/w,resnet/en,50/m,"/w,:/w, ,5/m,,/w, ,"/w,resnet/en,101/m,"/w,:/w, ,22/m,}/w,[/w,architecture/en,]/w, ,for/en, ,i/en, ,in/en, ,range/en,(/w,block/en,_,count/en,)/w,:/w, ,x/en, ,=/w, ,identity/en,_,block/en,(/w,x/en,,/w, ,3/m,,/w, ,[/w,256/m,,/w, ,256/m,,/w, ,1024/m,]/w,,/w, ,stage/en,=/w,4/m,,/w, ,block/en,=/w,chr/en,(/w,98/m, ,+/w, ,i/en,)/w,,/w, ,train/en,_,bn/en,=/w,train/en,_,bn/en,)/w, ,c/en,4/m, ,=/w, ,x/en, ,#, ,stage/en, ,5/m, ,if/en, ,stage/en,5/m,:/w, ,x/en, ,=/w, ,conv/en,_,block/en,(/w,x/en,,/w, ,3/m,,/w, ,[/w,512/m,,/w, ,512/m,,/w, ,2048/m,]/w,,/w, ,stage/en,=/w,5/m,,/w, ,block/en,=/w,'/w,a/en,'/w,,/w, ,train/en,_,bn/en,=/w,train/en,_,bn/en,)/w, ,x/en, ,=/w, ,identity/en,_,block/en,(/w,x/en,,/w, ,3/m,,/w, ,[/w,512/m,,/w, ,512/m,,/w, ,2048/m,]/w,,/w, ,stage/en,=/w,5/m,,/w, ,block/en,=/w,'/w,b/en,'/w,,/w, ,train/en,_,bn/en,=/w,train/en,_,bn/en,)/w, ,c/en,5/m, ,=/w, ,x/en, ,=/w, ,identity/en,_,block/en,(/w,x/en,,/w, ,3/m,,/w, ,[/w,512/m,,/w, ,512/m,,/w, ,2048/m,]/w,,/w, ,stage/en,=/w,5/m,,/w, ,block/en,=/w,'/w,c/en,'/w,,/w, ,train/en,_,bn/en,=/w,train/en,_,bn/en,)/w, ,else/en,:/w, ,c/en,5/m, ,=/w, ,none/en, ,return/en, ,[/w,c/en,1/m,,/w, ,c/en,2/m,,/w, ,c/en,3/m,,/w, ,c/en,4/m,,/w, ,c/en,5/m,]/w,bn/en,层/q,为了/p,可能/v,的/u,扩展/v,进行/v,了/u,封装/vn,，/w,不过/c,暂时/d,没/d,什么/r,扩展/v,：/w,class/en, ,batchnorm/en,(/w,kl/en,./w,batchnormalization/en,)/w,:/w, ,"/w,"/w,"/w,extends/en, ,the/en, ,keras/en, ,batchnormalization/en, ,class/en, ,to/en, ,allow/en, ,a/en, ,central/en, ,place/en, ,to/en, ,make/en, ,changes/en, ,if/en, ,needed/en,./w, ,batch/en, ,normalization/en, ,has/en, ,a/en, ,negative/en, ,effect/en, ,on/en, ,training/en, ,if/en, ,batches/en, ,are/en, ,small/en, ,so/en, ,this/en, ,layer/en, ,is/en, ,often/en, ,frozen/en, ,(/w,via/en, ,setting/en, ,in/en, ,config/en, ,class/en,)/w, ,and/en, ,functions/en, ,as/en, ,linear/en, ,layer/en,./w, ,"/w,"/w,"/w, ,def/en, ,call/en,(/w,self/en,,/w, ,inputs/en,,/w, ,training/en,=/w,none/en,)/w,:/w, ,"/w,"/w,"/w, ,note/en, ,about/en, ,training/en, ,values/en,:/w, ,none/en,:/w, ,train/en, ,bn/en, ,layers/en,./w, ,this/en, ,is/en, ,the/en, ,normal/en, ,mode/en, ,false/en,:/w, ,freeze/en, ,bn/en, ,layers/en,./w, ,good/en, ,when/en, ,batch/en, ,size/en, ,is/en, ,small/en, ,true/en,:/w, ,(/w,don/en,'/w,t/en, ,use/en,)/w,./w, ,set/en, ,layer/en, ,in/en, ,training/en, ,mode/en, ,even/en, ,when/en, ,making/en, ,inferences/en, ,"/w,"/w,"/w, ,return/en, ,super/en,(/w,self/en,./w,_,_,class/en,_,_,,/w, ,self/en,)/w,./w,call/en,(/w,inputs/en,,/w, ,training/en,=/w,training/en,)/w,fpn/en,处理/v,部分/n,接/v,上面/f,build/en,函数/n,代码/n,，/w,剩下/v,部分/n,比较/d,简单/a,，/w,和/c,示意图/n,对比/v,几乎/d,平铺直叙/i,，/w,#, ,top/en,-/w,down/en, ,layers/en, ,#, ,todo/en,:/w, ,add/en, ,assert/en, ,to/en, ,varify/en, ,feature/en, ,map/en, ,sizes/en, ,match/en, ,what/en,'/w,s/en, ,in/en, ,config/en, ,p/en,5/m, ,=/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,config/en,./w,top/en,_,down/en,_,pyramid/en,_,size/en,,/w, ,(/w,1/m,,/w, ,1/m,)/w,,/w, ,name/en,=/w,'/w,fpn/en,_,c/en,5/m,p/en,5/m,'/w,)/w,(/w,c/en,5/m,)/w, ,#, ,256/m, ,p/en,4/m, ,=/w, ,kl/en,./w,add/en,(/w,name/en,=/w,"/w,fpn/en,_,p/en,4/m,add/en,"/w,)/w,(/w,[/w, ,kl/en,./w,upsampling/en,2/m,d/en,(/w,size/en,=/w,(/w,2/m,,/w, ,2/m,)/w,,/w, ,name/en,=/w,"/w,fpn/en,_,p/en,5/m,upsampled/en,"/w,)/w,(/w,p/en,5/m,)/w,,/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,config/en,./w,top/en,_,down/en,_,pyramid/en,_,size/en,,/w, ,(/w,1/m,,/w, ,1/m,)/w,,/w, ,name/en,=/w,'/w,fpn/en,_,c/en,4/m,p/en,4/m,'/w,)/w,(/w,c/en,4/m,)/w,]/w,)/w, ,p/en,3/m, ,=/w, ,kl/en,./w,add/en,(/w,name/en,=/w,"/w,fpn/en,_,p/en,3/m,add/en,"/w,)/w,(/w,[/w, ,kl/en,./w,upsampling/en,2/m,d/en,(/w,size/en,=/w,(/w,2/m,,/w, ,2/m,)/w,,/w, ,name/en,=/w,"/w,fpn/en,_,p/en,4/m,upsampled/en,"/w,)/w,(/w,p/en,4/m,)/w,,/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,config/en,./w,top/en,_,down/en,_,pyramid/en,_,size/en,,/w, ,(/w,1/m,,/w, ,1/m,)/w,,/w, ,name/en,=/w,'/w,fpn/en,_,c/en,3/m,p/en,3/m,'/w,)/w,(/w,c/en,3/m,)/w,]/w,)/w, ,p/en,2/m, ,=/w, ,kl/en,./w,add/en,(/w,name/en,=/w,"/w,fpn/en,_,p/en,2/m,add/en,"/w,)/w,(/w,[/w, ,kl/en,./w,upsampling/en,2/m,d/en,(/w,size/en,=/w,(/w,2/m,,/w, ,2/m,)/w,,/w, ,name/en,=/w,"/w,fpn/en,_,p/en,3/m,upsampled/en,"/w,)/w,(/w,p/en,3/m,)/w,,/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,config/en,./w,top/en,_,down/en,_,pyramid/en,_,size/en,,/w, ,(/w,1/m,,/w, ,1/m,)/w,,/w, ,name/en,=/w,'/w,fpn/en,_,c/en,2/m,p/en,2/m,'/w,)/w,(/w,c/en,2/m,)/w,]/w,)/w, ,#, ,attach/en, ,3/m,x/en,3/m, ,conv/en, ,to/en, ,all/en, ,p/en, ,layers/en, ,to/en, ,get/en, ,the/en, ,final/en, ,feature/en, ,maps/en,./w, ,p/en,2/m, ,=/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,config/en,./w,top/en,_,down/en,_,pyramid/en,_,size/en,,/w, ,(/w,3/m,,/w, ,3/m,)/w,,/w, ,padding/en,=/w,"/w,same/en,"/w,,/w, ,name/en,=/w,"/w,fpn/en,_,p/en,2/m,"/w,)/w,(/w,p/en,2/m,)/w, ,p/en,3/m, ,=/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,config/en,./w,top/en,_,down/en,_,pyramid/en,_,size/en,,/w, ,(/w,3/m,,/w, ,3/m,)/w,,/w, ,padding/en,=/w,"/w,same/en,"/w,,/w, ,name/en,=/w,"/w,fpn/en,_,p/en,3/m,"/w,)/w,(/w,p/en,3/m,)/w, ,p/en,4/m, ,=/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,config/en,./w,top/en,_,down/en,_,pyramid/en,_,size/en,,/w, ,(/w,3/m,,/w, ,3/m,)/w,,/w, ,padding/en,=/w,"/w,same/en,"/w,,/w, ,name/en,=/w,"/w,fpn/en,_,p/en,4/m,"/w,)/w,(/w,p/en,4/m,)/w, ,p/en,5/m, ,=/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,config/en,./w,top/en,_,down/en,_,pyramid/en,_,size/en,,/w, ,(/w,3/m,,/w, ,3/m,)/w,,/w, ,padding/en,=/w,"/w,same/en,"/w,,/w, ,name/en,=/w,"/w,fpn/en,_,p/en,5/m,"/w,)/w,(/w,p/en,5/m,)/w, ,#, ,p/en,6/m, ,is/en, ,used/en, ,for/en, ,the/en, ,5/m,th/en, ,anchor/en, ,scale/en, ,in/en, ,rpn/en,./w, ,generated/en, ,by/en, ,#, ,subsampling/en, ,from/en, ,p/en,5/m, ,with/en, ,stride/en, ,of/en, ,2/m,./w, ,p/en,6/m, ,=/w, ,kl/en,./w,maxpooling/en,2/m,d/en,(/w,pool/en,_,size/en,=/w,(/w,1/m,,/w, ,1/m,)/w,,/w, ,strides/en,=/w,2/m,,/w, ,name/en,=/w,"/w,fpn/en,_,p/en,6/m,"/w,)/w,(/w,p/en,5/m,)/w,接/v,上面/f,build/en,函数/n,代码/n,，/w,最后/f,我们/r,提取/v,的/u,特征/n,集合/v,如下/v,：/w,#, ,note/en, ,that/en, ,p/en,6/m, ,is/en, ,used/en, ,in/en, ,rpn/en,,/w, ,but/en, ,not/en, ,in/en, ,the/en, ,classifier/en, ,heads/en,./w, ,rpn/en,_,feature/en,_,maps/en, ,=/w, ,[/w,p/en,2/m,,/w, ,p/en,3/m,,/w, ,p/en,4/m,,/w, ,p/en,5/m,,/w, ,p/en,6/m,]/w, ,mrcnn/en,_,feature/en,_,maps/en, ,=/w, ,[/w,p/en,2/m,,/w, ,p/en,3/m,,/w, ,p/en,4/m,,/w, ,p/en,5/m,]/w,其中/r,rpn/en,_,feature/en,_,maps/en,对应/v,图中/nrf,的/u,实线/n,输出/v,，/w,送入/v,rpn/en,网络/n,分类/vn,//w,回归/v,得到/v,锚框/nw,的/u,前景/n,//w,背景/n,鉴别/vn,结果/n,；/w,而/c,mrcnn/en,_,feature/en,_,maps/en,则/d,是/v,后面/f,进行/v,roi/en, ,align/en,时/ng,的/u,切割/v,目标/n,。/w,附录/n,、/w,build/en,函数/n,总览/nw,def/en, ,build/en,(/w,self/en,,/w, ,mode/en,,/w, ,config/en,)/w,:/w, ,"/w,"/w,"/w,build/en, ,mask/en, ,r/en,-/w,cnn/en, ,architecture/en,./w, ,input/en,_,shape/en,:/w, ,the/en, ,shape/en, ,of/en, ,the/en, ,input/en, ,image/en,./w, ,mode/en,:/w, ,either/en, ,"/w,training/en,"/w, ,or/en, ,"/w,inference/en,"/w,./w, ,the/en, ,inputs/en, ,and/en, ,outputs/en, ,of/en, ,the/en, ,model/en, ,differ/en, ,accordingly/en,./w, ,"/w,"/w,"/w, ,assert/en, ,mode/en, ,in/en, ,[/w,'/w,training/en,'/w,,/w, ,'/w,inference/en,'/w,]/w, ,#, ,image/en, ,size/en, ,must/en, ,be/en, ,dividable/en, ,by/en, ,2/m, ,multiple/en, ,times/en, ,h/en,,/w, ,w/en, ,=/w, ,config/en,./w,image/en,_,shape/en,[/w,:/w,2/m,]/w, ,#, ,[/w,1024/m, ,1024/m, ,3/m,]/w, ,if/en, ,h/en, ,//w, ,2/m,*/w,*/w,6/m, ,!/w,=/w, ,int/en,(/w,h/en, ,//w, ,2/m,*/w,*/w,6/m,)/w, ,or/en, ,w/en, ,//w, ,2/m,*/w,*/w,6/m, ,!/w,=/w, ,int/en,(/w,w/en, ,//w, ,2/m,*/w,*/w,6/m,)/w,:/w, ,#, ,这里/r,就/d,限定/v,了/u,下/f,采样/v,不/d,会/v,产生/v,坐标/n,误差/n, ,raise/en, ,exception/en,(/w,"/w,image/en, ,size/en, ,must/en, ,be/en, ,dividable/en, ,by/en, ,2/m, ,at/en, ,least/en, ,6/m, ,times/en, ,"/w, ,"/w,to/en, ,avoid/en, ,fractions/en, ,when/en, ,downscaling/en, ,and/en, ,upscaling/en,./w,"/w, ,"/w,for/en, ,example/en,,/w, ,use/en, ,256/m,,/w, ,320/m,,/w, ,384/m,,/w, ,448/m,,/w, ,512/m,,/w, ,./w,./w,./w, ,etc/en,./w, ,"/w,)/w, ,#, ,inputs/en, ,input/en,_,image/en, ,=/w, ,kl/en,./w,input/en,(/w, ,shape/en,=/w,[/w,none/en,,/w, ,none/en,,/w, ,config/en,./w,image/en,_,shape/en,[/w,2/m,]/w,]/w,,/w, ,name/en,=/w,"/w,input/en,_,image/en,"/w,)/w, ,input/en,_,image/en,_,meta/en, ,=/w, ,kl/en,./w,input/en,(/w,shape/en,=/w,[/w,config/en,./w,image/en,_,meta/en,_,size/en,]/w,,/w, ,name/en,=/w,"/w,input/en,_,image/en,_,meta/en,"/w,)/w, ,if/en, ,mode/en, ,=/w,=/w, ,"/w,training/en,"/w,:/w, ,#, ,rpn/en, ,gt/en, ,input/en,_,rpn/en,_,match/en, ,=/w, ,kl/en,./w,input/en,(/w, ,shape/en,=/w,[/w,none/en,,/w, ,1/m,]/w,,/w, ,name/en,=/w,"/w,input/en,_,rpn/en,_,match/en,"/w,,/w, ,dtype/en,=/w,tf/en,./w,int/en,32/m,)/w, ,input/en,_,rpn/en,_,bbox/en, ,=/w, ,kl/en,./w,input/en,(/w, ,shape/en,=/w,[/w,none/en,,/w, ,4/m,]/w,,/w, ,name/en,=/w,"/w,input/en,_,rpn/en,_,bbox/en,"/w,,/w, ,dtype/en,=/w,tf/en,./w,float/en,32/m,)/w, ,#, ,detection/en, ,gt/en, ,(/w,class/en, ,ids/en,,/w, ,bounding/en, ,boxes/en,,/w, ,and/en, ,masks/en,)/w, ,#, ,1/m,./w, ,gt/en, ,class/en, ,ids/en, ,(/w,zero/en, ,padded/en,)/w, ,input/en,_,gt/en,_,class/en,_,ids/en, ,=/w, ,kl/en,./w,input/en,(/w, ,shape/en,=/w,[/w,none/en,]/w,,/w, ,name/en,=/w,"/w,input/en,_,gt/en,_,class/en,_,ids/en,"/w,,/w, ,dtype/en,=/w,tf/en,./w,int/en,32/m,)/w, ,#, ,2/m,./w, ,gt/en, ,boxes/en, ,in/en, ,pixels/en, ,(/w,zero/en, ,padded/en,)/w, ,#, ,[/w,batch/en,,/w, ,max/en,_,gt/en,_,instances/en,,/w, ,(/w,y/en,1/m,,/w, ,x/en,1/m,,/w, ,y/en,2/m,,/w, ,x/en,2/m,)/w,]/w, ,in/en, ,image/en, ,coordinates/en, ,input/en,_,gt/en,_,boxes/en, ,=/w, ,kl/en,./w,input/en,(/w, ,shape/en,=/w,[/w,none/en,,/w, ,4/m,]/w,,/w, ,name/en,=/w,"/w,input/en,_,gt/en,_,boxes/en,"/w,,/w, ,dtype/en,=/w,tf/en,./w,float/en,32/m,)/w, ,#, ,normalize/en, ,coordinates/en, ,gt/en,_,boxes/en, ,=/w, ,kl/en,./w,lambda/en,(/w,lambda/en, ,x/en,:/w, ,norm/en,_,boxes/en,_,graph/en,(/w, ,x/en,,/w, ,k/en,./w,shape/en,(/w,input/en,_,image/en,)/w,[/w,1/m,:/w,3/m,]/w,)/w,)/w,(/w,input/en,_,gt/en,_,boxes/en,)/w, ,#, ,3/m,./w, ,gt/en, ,masks/en, ,(/w,zero/en, ,padded/en,)/w, ,#, ,[/w,batch/en,,/w, ,height/en,,/w, ,width/en,,/w, ,max/en,_,gt/en,_,instances/en,]/w, ,if/en, ,config/en,./w,use/en,_,mini/en,_,mask/en,:/w, ,input/en,_,gt/en,_,masks/en, ,=/w, ,kl/en,./w,input/en,(/w, ,shape/en,=/w,[/w,config/en,./w,mini/en,_,mask/en,_,shape/en,[/w,0/m,]/w,,/w, ,config/en,./w,mini/en,_,mask/en,_,shape/en,[/w,1/m,]/w,,/w, ,none/en,]/w,,/w, ,name/en,=/w,"/w,input/en,_,gt/en,_,masks/en,"/w,,/w, ,dtype/en,=/w,bool/en,)/w, ,else/en,:/w, ,input/en,_,gt/en,_,masks/en, ,=/w, ,kl/en,./w,input/en,(/w, ,shape/en,=/w,[/w,config/en,./w,image/en,_,shape/en,[/w,0/m,]/w,,/w, ,config/en,./w,image/en,_,shape/en,[/w,1/m,]/w,,/w, ,none/en,]/w,,/w, ,name/en,=/w,"/w,input/en,_,gt/en,_,masks/en,"/w,,/w, ,dtype/en,=/w,bool/en,)/w, ,elif/en, ,mode/en, ,=/w,=/w, ,"/w,inference/en,"/w,:/w, ,#, ,anchors/en, ,in/en, ,normalized/en, ,coordinates/en, ,input/en,_,anchors/en, ,=/w, ,kl/en,./w,input/en,(/w,shape/en,=/w,[/w,none/en,,/w, ,4/m,]/w,,/w, ,name/en,=/w,"/w,input/en,_,anchors/en,"/w,)/w, ,#, ,build/en, ,the/en, ,shared/en, ,convolutional/en, ,layers/en,./w, ,#, ,bottom/en,-/w,up/en, ,layers/en, ,#, ,returns/en, ,a/en, ,list/en, ,of/en, ,the/en, ,last/en, ,layers/en, ,of/en, ,each/en, ,stage/en,,/w, ,5/m, ,in/en, ,total/en,./w, ,#, ,don/en,'/w,t/en, ,create/en, ,the/en, ,thead/en, ,(/w,stage/en, ,5/m,)/w,,/w, ,so/en, ,we/en, ,pick/en, ,the/en, ,4/m,th/en, ,item/en, ,in/en, ,the/en, ,list/en,./w, ,if/en, ,callable/en,(/w,config/en,./w,backbone/en,)/w,:/w, ,_,,/w, ,c/en,2/m,,/w, ,c/en,3/m,,/w, ,c/en,4/m,,/w, ,c/en,5/m, ,=/w, ,config/en,./w,backbone/en,(/w,input/en,_,image/en,,/w, ,stage/en,5/m,=/w,true/en,,/w, ,train/en,_,bn/en,=/w,config/en,./w,train/en,_,bn/en,)/w, ,else/en,:/w, ,_,,/w, ,c/en,2/m,,/w, ,c/en,3/m,,/w, ,c/en,4/m,,/w, ,c/en,5/m, ,=/w, ,resnet/en,_,graph/en,(/w,input/en,_,image/en,,/w, ,config/en,./w,backbone/en,,/w, ,stage/en,5/m,=/w,true/en,,/w, ,train/en,_,bn/en,=/w,config/en,./w,train/en,_,bn/en,)/w, ,#, ,top/en,-/w,down/en, ,layers/en, ,#, ,todo/en,:/w, ,add/en, ,assert/en, ,to/en, ,varify/en, ,feature/en, ,map/en, ,sizes/en, ,match/en, ,what/en,'/w,s/en, ,in/en, ,config/en, ,p/en,5/m, ,=/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,config/en,./w,top/en,_,down/en,_,pyramid/en,_,size/en,,/w, ,(/w,1/m,,/w, ,1/m,)/w,,/w, ,name/en,=/w,'/w,fpn/en,_,c/en,5/m,p/en,5/m,'/w,)/w,(/w,c/en,5/m,)/w, ,#, ,256/m, ,p/en,4/m, ,=/w, ,kl/en,./w,add/en,(/w,name/en,=/w,"/w,fpn/en,_,p/en,4/m,add/en,"/w,)/w,(/w,[/w, ,kl/en,./w,upsampling/en,2/m,d/en,(/w,size/en,=/w,(/w,2/m,,/w, ,2/m,)/w,,/w, ,name/en,=/w,"/w,fpn/en,_,p/en,5/m,upsampled/en,"/w,)/w,(/w,p/en,5/m,)/w,,/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,config/en,./w,top/en,_,down/en,_,pyramid/en,_,size/en,,/w, ,(/w,1/m,,/w, ,1/m,)/w,,/w, ,name/en,=/w,'/w,fpn/en,_,c/en,4/m,p/en,4/m,'/w,)/w,(/w,c/en,4/m,)/w,]/w,)/w, ,p/en,3/m, ,=/w, ,kl/en,./w,add/en,(/w,name/en,=/w,"/w,fpn/en,_,p/en,3/m,add/en,"/w,)/w,(/w,[/w, ,kl/en,./w,upsampling/en,2/m,d/en,(/w,size/en,=/w,(/w,2/m,,/w, ,2/m,)/w,,/w, ,name/en,=/w,"/w,fpn/en,_,p/en,4/m,upsampled/en,"/w,)/w,(/w,p/en,4/m,)/w,,/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,config/en,./w,top/en,_,down/en,_,pyramid/en,_,size/en,,/w, ,(/w,1/m,,/w, ,1/m,)/w,,/w, ,name/en,=/w,'/w,fpn/en,_,c/en,3/m,p/en,3/m,'/w,)/w,(/w,c/en,3/m,)/w,]/w,)/w, ,p/en,2/m, ,=/w, ,kl/en,./w,add/en,(/w,name/en,=/w,"/w,fpn/en,_,p/en,2/m,add/en,"/w,)/w,(/w,[/w, ,kl/en,./w,upsampling/en,2/m,d/en,(/w,size/en,=/w,(/w,2/m,,/w, ,2/m,)/w,,/w, ,name/en,=/w,"/w,fpn/en,_,p/en,3/m,upsampled/en,"/w,)/w,(/w,p/en,3/m,)/w,,/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,config/en,./w,top/en,_,down/en,_,pyramid/en,_,size/en,,/w, ,(/w,1/m,,/w, ,1/m,)/w,,/w, ,name/en,=/w,'/w,fpn/en,_,c/en,2/m,p/en,2/m,'/w,)/w,(/w,c/en,2/m,)/w,]/w,)/w, ,#, ,attach/en, ,3/m,x/en,3/m, ,conv/en, ,to/en, ,all/en, ,p/en, ,layers/en, ,to/en, ,get/en, ,the/en, ,final/en, ,feature/en, ,maps/en,./w, ,p/en,2/m, ,=/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,config/en,./w,top/en,_,down/en,_,pyramid/en,_,size/en,,/w, ,(/w,3/m,,/w, ,3/m,)/w,,/w, ,padding/en,=/w,"/w,same/en,"/w,,/w, ,name/en,=/w,"/w,fpn/en,_,p/en,2/m,"/w,)/w,(/w,p/en,2/m,)/w, ,p/en,3/m, ,=/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,config/en,./w,top/en,_,down/en,_,pyramid/en,_,size/en,,/w, ,(/w,3/m,,/w, ,3/m,)/w,,/w, ,padding/en,=/w,"/w,same/en,"/w,,/w, ,name/en,=/w,"/w,fpn/en,_,p/en,3/m,"/w,)/w,(/w,p/en,3/m,)/w, ,p/en,4/m, ,=/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,config/en,./w,top/en,_,down/en,_,pyramid/en,_,size/en,,/w, ,(/w,3/m,,/w, ,3/m,)/w,,/w, ,padding/en,=/w,"/w,same/en,"/w,,/w, ,name/en,=/w,"/w,fpn/en,_,p/en,4/m,"/w,)/w,(/w,p/en,4/m,)/w, ,p/en,5/m, ,=/w, ,kl/en,./w,conv/en,2/m,d/en,(/w,config/en,./w,top/en,_,down/en,_,pyramid/en,_,size/en,,/w, ,(/w,3/m,,/w, ,3/m,)/w,,/w, ,padding/en,=/w,"/w,same/en,"/w,,/w, ,name/en,=/w,"/w,fpn/en,_,p/en,5/m,"/w,)/w,(/w,p/en,5/m,)/w, ,#, ,p/en,6/m, ,is/en, ,used/en, ,for/en, ,the/en, ,5/m,th/en, ,anchor/en, ,scale/en, ,in/en, ,rpn/en,./w, ,generated/en, ,by/en, ,#, ,subsampling/en, ,from/en, ,p/en,5/m, ,with/en, ,stride/en, ,of/en, ,2/m,./w, ,p/en,6/m, ,=/w, ,kl/en,./w,maxpooling/en,2/m,d/en,(/w,pool/en,_,size/en,=/w,(/w,1/m,,/w, ,1/m,)/w,,/w, ,strides/en,=/w,2/m,,/w, ,name/en,=/w,"/w,fpn/en,_,p/en,6/m,"/w,)/w,(/w,p/en,5/m,)/w, ,#, ,note/en, ,that/en, ,p/en,6/m, ,is/en, ,used/en, ,in/en, ,rpn/en,,/w, ,but/en, ,not/en, ,in/en, ,the/en, ,classifier/en, ,heads/en,./w, ,rpn/en,_,feature/en,_,maps/en, ,=/w, ,[/w,p/en,2/m,,/w, ,p/en,3/m,,/w, ,p/en,4/m,,/w, ,p/en,5/m,,/w, ,p/en,6/m,]/w, ,mrcnn/en,_,feature/en,_,maps/en, ,=/w, ,[/w,p/en,2/m,,/w, ,p/en,3/m,,/w, ,p/en,4/m,,/w, ,p/en,5/m,]/w, ,#, ,anchors/en, ,if/en, ,mode/en, ,=/w,=/w, ,"/w,training/en,"/w,:/w, ,anchors/en, ,=/w, ,self/en,./w,get/en,_,anchors/en,(/w,config/en,./w,image/en,_,shape/en,)/w, ,#, ,duplicate/en, ,across/en, ,the/en, ,batch/en, ,dimension/en, ,because/en, ,keras/en, ,requires/en, ,it/en, ,#, ,todo/en,:/w, ,can/en, ,this/en, ,be/en, ,optimized/en, ,to/en, ,avoid/en, ,duplicating/en, ,the/en, ,anchors/en,?/w, ,anchors/en, ,=/w, ,np/en,./w,broadcast/en,_,to/en,(/w,anchors/en,,/w, ,(/w,config/en,./w,batch/en,_,size/en,,/w,)/w, ,+/w, ,anchors/en,./w,shape/en,)/w, ,#, ,a/en, ,hack/en, ,to/en, ,get/en, ,around/en, ,keras/en,'/w,s/en, ,bad/en, ,support/en, ,for/en, ,constants/en, ,anchors/en, ,=/w, ,kl/en,./w,lambda/en,(/w,lambda/en, ,x/en,:/w, ,tf/en,./w,variable/en,(/w,anchors/en,)/w,,/w, ,name/en,=/w,"/w,anchors/en,"/w,)/w,(/w,input/en,_,image/en,)/w, ,else/en,:/w, ,anchors/en, ,=/w, ,input/en,_,anchors/en, ,#, ,rpn/en, ,model/en,,/w, ,返回/v,的/u,是/v,keras/en,的/u,module/en,对象/n,,/w, ,注意/v,keras/en,中/f,的/u,module/en,对象/n,是/v,可/v,call/en,的/u, ,rpn/en, ,=/w, ,build/en,_,rpn/en,_,model/en,(/w,config/en,./w,rpn/en,_,anchor/en,_,stride/en,,/w, ,#, ,1/m, ,3/m, ,256/m, ,len/en,(/w,config/en,./w,rpn/en,_,anchor/en,_,ratios/en,)/w,,/w, ,config/en,./w,top/en,_,down/en,_,pyramid/en,_,size/en,)/w, ,#, ,loop/en, ,through/en, ,pyramid/en, ,layers/en, ,layer/en,_,outputs/en, ,=/w, ,[/w,]/w, ,#, ,list/en, ,of/en, ,lists/en, ,for/en, ,p/en, ,in/en, ,rpn/en,_,feature/en,_,maps/en,:/w, ,layer/en,_,outputs/en,./w,append/en,(/w,rpn/en,(/w,[/w,p/en,]/w,)/w,)/w, ,#, ,保存/v,各/r,pyramid/en,特征/n,经过/p,rpn/en,之后/f,的/u,结果/n, ,#, ,concatenate/en, ,layer/en, ,outputs/en, ,#, ,convert/en, ,from/en, ,list/en, ,of/en, ,lists/en, ,of/en, ,level/en, ,outputs/en, ,to/en, ,list/en, ,of/en, ,lists/en, ,#, ,of/en, ,outputs/en, ,across/en, ,levels/en,./w, ,#, ,e/en,./w,g/en,./w, ,[/w,[/w,a/en,1/m,,/w, ,b/en,1/m,,/w, ,c/en,1/m,]/w,,/w, ,[/w,a/en,2/m,,/w, ,b/en,2/m,,/w, ,c/en,2/m,]/w,]/w, ,=/w,>, ,[/w,[/w,a/en,1/m,,/w, ,a/en,2/m,]/w,,/w, ,[/w,b/en,1/m,,/w, ,b/en,2/m,]/w,,/w, ,[/w,c/en,1/m,,/w, ,c/en,2/m,]/w,]/w, ,output/en,_,names/en, ,=/w, ,[/w,"/w,rpn/en,_,class/en,_,logits/en,"/w,,/w, ,"/w,rpn/en,_,class/en,"/w,,/w, ,"/w,rpn/en,_,bbox/en,"/w,]/w, ,outputs/en, ,=/w, ,list/en,(/w,zip/en,(/w,*/w,layer/en,_,outputs/en,)/w,)/w, ,#, ,[/w,[/w,logits/en,2/m,,/w,……/w,6/m,]/w,,/w, ,[/w,class/en,2/m,,/w,……/w,6/m,]/w,,/w, ,[/w,bbox/en,2/m,,/w,……/w,6/m,]/w,]/w, ,outputs/en, ,=/w, ,[/w,kl/en,./w,concatenate/en,(/w,axis/en,=/w,1/m,,/w, ,name/en,=/w,n/en,)/w,(/w,list/en,(/w,o/en,)/w,)/w, ,for/en, ,o/en,,/w, ,n/en, ,in/en, ,zip/en,(/w,outputs/en,,/w, ,output/en,_,names/en,)/w,]/w, ,#, ,[/w,batch/en,,/w, ,num/en,_,anchors/en,,/w, ,2/m,//w,4/m,]/w, ,#, ,其中/r,num/en,_,anchors/en,指/v,的/u,是/v,全部/m,特征/n,层/q,上/f,的/u,anchors/en,总数/n, ,rpn/en,_,class/en,_,logits/en,,/w, ,rpn/en,_,class/en,,/w, ,rpn/en,_,bbox/en, ,=/w, ,outputs/en, ,#, ,generate/en, ,proposals/en, ,#, ,proposals/en, ,are/en, ,[/w,batch/en,,/w, ,n/en,,/w, ,(/w,y/en,1/m,,/w, ,x/en,1/m,,/w, ,y/en,2/m,,/w, ,x/en,2/m,)/w,]/w, ,in/en, ,normalized/en, ,coordinates/en, ,#, ,and/en, ,zero/en, ,padded/en,./w, ,#, ,post/en,_,nms/en,_,rois/en,_,inference/en, ,=/w, ,1000/m, ,#, ,post/en,_,nms/en,_,rois/en,_,training/en, ,=/w, ,2000/m, ,proposal/en,_,count/en, ,=/w, ,config/en,./w,post/en,_,nms/en,_,rois/en,_,training/en, ,if/en, ,mode/en, ,=/w,=/w, ,"/w,training/en,"/w,\/w, ,else/en, ,config/en,./w,post/en,_,nms/en,_,rois/en,_,inference/en, ,#, ,[/w,images/en,_,per/en,_,gpu/en,,/w, ,num/en,_,rois/en,,/w, ,(/w,y/en,1/m,,/w, ,x/en,1/m,,/w, ,y/en,2/m,,/w, ,x/en,2/m,)/w,]/w, ,#, ,images/en,_,per/en,_,gpu/en,取代/v,了/u,batch/en,，/w,之后/f,说/v,的/u,batch/en,都/d,是/v,images/en,_,per/en,_,gpu/en, ,rpn/en,_,rois/en, ,=/w, ,proposallayer/en,(/w, ,proposal/en,_,count/en,=/w,proposal/en,_,count/en,,/w, ,nms/en,_,threshold/en,=/w,config/en,./w,rpn/en,_,nms/en,_,threshold/en,,/w, ,#, ,0.7/m, ,name/en,=/w,"/w,roi/en,"/w,,/w, ,config/en,=/w,config/en,)/w,(/w,[/w,rpn/en,_,class/en,,/w, ,rpn/en,_,bbox/en,,/w, ,anchors/en,]/w,)/w, ,if/en, ,mode/en, ,=/w,=/w, ,"/w,training/en,"/w,:/w, ,#, ,class/en, ,id/en, ,mask/en, ,to/en, ,mark/en, ,class/en, ,ids/en, ,supported/en, ,by/en, ,the/en, ,dataset/en, ,the/en, ,image/en, ,#, ,came/en, ,from/en,./w, ,active/en,_,class/en,_,ids/en, ,=/w, ,kl/en,./w,lambda/en,(/w, ,lambda/en, ,x/en,:/w, ,parse/en,_,image/en,_,meta/en,_,graph/en,(/w,x/en,)/w,[/w,"/w,active/en,_,class/en,_,ids/en,"/w,]/w, ,)/w,(/w,input/en,_,image/en,_,meta/en,)/w, ,if/en, ,not/en, ,config/en,./w,use/en,_,rpn/en,_,rois/en,:/w, ,#, ,ignore/en, ,predicted/en, ,rois/en, ,and/en, ,use/en, ,rois/en, ,provided/en, ,as/en, ,an/en, ,input/en,./w, ,input/en,_,rois/en, ,=/w, ,kl/en,./w,input/en,(/w,shape/en,=/w,[/w,config/en,./w,post/en,_,nms/en,_,rois/en,_,training/en,,/w, ,4/m,]/w,,/w, ,name/en,=/w,"/w,input/en,_,roi/en,"/w,,/w, ,dtype/en,=/w,np/en,./w,int/en,32/m,)/w, ,#, ,normalize/en, ,coordinates/en, ,target/en,_,rois/en, ,=/w, ,kl/en,./w,lambda/en,(/w,lambda/en, ,x/en,:/w, ,norm/en,_,boxes/en,_,graph/en,(/w, ,x/en,,/w, ,k/en,./w,shape/en,(/w,input/en,_,image/en,)/w,[/w,1/m,:/w,3/m,]/w,)/w,)/w,(/w,input/en,_,rois/en,)/w, ,else/en,:/w, ,target/en,_,rois/en, ,=/w, ,rpn/en,_,rois/en, ,#, ,generate/en, ,detection/en, ,targets/en, ,#, ,subsamples/en, ,proposals/en, ,and/en, ,generates/en, ,target/en, ,outputs/en, ,for/en, ,training/en, ,#, ,note/en, ,that/en, ,proposal/en, ,class/en, ,ids/en,,/w, ,gt/en,_,boxes/en,,/w, ,and/en, ,gt/en,_,masks/en, ,are/en, ,zero/en, ,#, ,padded/en,./w, ,equally/en,,/w, ,returned/en, ,rois/en, ,and/en, ,targets/en, ,are/en, ,zero/en, ,padded/en,./w, ,rois/en,,/w, ,target/en,_,class/en,_,ids/en,,/w, ,target/en,_,bbox/en,,/w, ,target/en,_,mask/en, ,=/w,\/w, ,detectiontargetlayer/en,(/w,config/en,,/w, ,name/en,=/w,"/w,proposal/en,_,targets/en,"/w,)/w,(/w,[/w, ,target/en,_,rois/en,,/w, ,input/en,_,gt/en,_,class/en,_,ids/en,,/w, ,gt/en,_,boxes/en,,/w, ,input/en,_,gt/en,_,masks/en,]/w,)/w, ,#, ,network/en, ,heads/en, ,#, ,todo/en,:/w, ,verify/en, ,that/en, ,this/en, ,handles/en, ,zero/en, ,padded/en, ,rois/en, ,mrcnn/en,_,class/en,_,logits/en,,/w, ,mrcnn/en,_,class/en,,/w, ,mrcnn/en,_,bbox/en, ,=/w,\/w, ,fpn/en,_,classifier/en,_,graph/en,(/w,rois/en,,/w, ,mrcnn/en,_,feature/en,_,maps/en,,/w, ,input/en,_,image/en,_,meta/en,,/w, ,config/en,./w,pool/en,_,size/en,,/w, ,config/en,./w,num/en,_,classes/en,,/w, ,train/en,_,bn/en,=/w,config/en,./w,train/en,_,bn/en,,/w, ,fc/en,_,layers/en,_,size/en,=/w,config/en,./w,fpn/en,_,classif/en,_,fc/en,_,layers/en,_,size/en,)/w, ,mrcnn/en,_,mask/en, ,=/w, ,build/en,_,fpn/en,_,mask/en,_,graph/en,(/w,rois/en,,/w, ,mrcnn/en,_,feature/en,_,maps/en,,/w, ,input/en,_,image/en,_,meta/en,,/w, ,config/en,./w,mask/en,_,pool/en,_,size/en,,/w, ,config/en,./w,num/en,_,classes/en,,/w, ,train/en,_,bn/en,=/w,config/en,./w,train/en,_,bn/en,)/w, ,#, ,todo/en,:/w, ,clean/en, ,up/en, ,(/w,use/en, ,tf/en,./w,identify/en, ,if/en, ,necessary/en,)/w, ,output/en,_,rois/en, ,=/w, ,kl/en,./w,lambda/en,(/w,lambda/en, ,x/en,:/w, ,x/en, ,*/w, ,1/m,,/w, ,name/en,=/w,"/w,output/en,_,rois/en,"/w,)/w,(/w,rois/en,)/w, ,#, ,losses/en, ,rpn/en,_,class/en,_,loss/en, ,=/w, ,kl/en,./w,lambda/en,(/w,lambda/en, ,x/en,:/w, ,rpn/en,_,class/en,_,loss/en,_,graph/en,(/w,*/w,x/en,)/w,,/w, ,name/en,=/w,"/w,rpn/en,_,class/en,_,loss/en,"/w,)/w,(/w, ,[/w,input/en,_,rpn/en,_,match/en,,/w, ,rpn/en,_,class/en,_,logits/en,]/w,)/w, ,rpn/en,_,bbox/en,_,loss/en, ,=/w, ,kl/en,./w,lambda/en,(/w,lambda/en, ,x/en,:/w, ,rpn/en,_,bbox/en,_,loss/en,_,graph/en,(/w,config/en,,/w, ,*/w,x/en,)/w,,/w, ,name/en,=/w,"/w,rpn/en,_,bbox/en,_,loss/en,"/w,)/w,(/w, ,[/w,input/en,_,rpn/en,_,bbox/en,,/w, ,input/en,_,rpn/en,_,match/en,,/w, ,rpn/en,_,bbox/en,]/w,)/w, ,class/en,_,loss/en, ,=/w, ,kl/en,./w,lambda/en,(/w,lambda/en, ,x/en,:/w, ,mrcnn/en,_,class/en,_,loss/en,_,graph/en,(/w,*/w,x/en,)/w,,/w, ,name/en,=/w,"/w,mrcnn/en,_,class/en,_,loss/en,"/w,)/w,(/w, ,[/w,target/en,_,class/en,_,ids/en,,/w, ,mrcnn/en,_,class/en,_,logits/en,,/w, ,active/en,_,class/en,_,ids/en,]/w,)/w, ,bbox/en,_,loss/en, ,=/w, ,kl/en,./w,lambda/en,(/w,lambda/en, ,x/en,:/w, ,mrcnn/en,_,bbox/en,_,loss/en,_,graph/en,(/w,*/w,x/en,)/w,,/w, ,name/en,=/w,"/w,mrcnn/en,_,bbox/en,_,loss/en,"/w,)/w,(/w, ,[/w,target/en,_,bbox/en,,/w, ,target/en,_,class/en,_,ids/en,,/w, ,mrcnn/en,_,bbox/en,]/w,)/w, ,mask/en,_,loss/en, ,=/w, ,kl/en,./w,lambda/en,(/w,lambda/en, ,x/en,:/w, ,mrcnn/en,_,mask/en,_,loss/en,_,graph/en,(/w,*/w,x/en,)/w,,/w, ,name/en,=/w,"/w,mrcnn/en,_,mask/en,_,loss/en,"/w,)/w,(/w, ,[/w,target/en,_,mask/en,,/w, ,target/en,_,class/en,_,ids/en,,/w, ,mrcnn/en,_,mask/en,]/w,)/w, ,#, ,model/en, ,inputs/en, ,=/w, ,[/w,input/en,_,image/en,,/w, ,input/en,_,image/en,_,meta/en,,/w, ,input/en,_,rpn/en,_,match/en,,/w, ,input/en,_,rpn/en,_,bbox/en,,/w, ,input/en,_,gt/en,_,class/en,_,ids/en,,/w, ,input/en,_,gt/en,_,boxes/en,,/w, ,input/en,_,gt/en,_,masks/en,]/w, ,if/en, ,not/en, ,config/en,./w,use/en,_,rpn/en,_,rois/en,:/w, ,inputs/en,./w,append/en,(/w,input/en,_,rois/en,)/w, ,outputs/en, ,=/w, ,[/w,rpn/en,_,class/en,_,logits/en,,/w, ,rpn/en,_,class/en,,/w, ,rpn/en,_,bbox/en,,/w, ,mrcnn/en,_,class/en,_,logits/en,,/w, ,mrcnn/en,_,class/en,,/w, ,mrcnn/en,_,bbox/en,,/w, ,mrcnn/en,_,mask/en,,/w, ,rpn/en,_,rois/en,,/w, ,output/en,_,rois/en,,/w, ,rpn/en,_,class/en,_,loss/en,,/w, ,rpn/en,_,bbox/en,_,loss/en,,/w, ,class/en,_,loss/en,,/w, ,bbox/en,_,loss/en,,/w, ,mask/en,_,loss/en,]/w, ,model/en, ,=/w, ,km/en,./w,model/en,(/w,inputs/en,,/w, ,outputs/en,,/w, ,name/