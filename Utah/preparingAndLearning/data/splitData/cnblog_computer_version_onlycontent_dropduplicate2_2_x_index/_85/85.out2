github/en,地址/n,：/w,mask/en,_,rcnn/en,『/w,计算机/n,视觉/n,』/w,mask/en,-/w,rcnn/en,_,论文/n,学习/v,『/w,计算机/n,视觉/n,』/w,mask/en,-/w,rcnn/en,_,项目/n,文档/n,翻译/v,『/w,计算机/n,视觉/n,』/w,mask/en,-/w,rcnn/en,_,推断/vn,网络/n,其一/r,：/w,总览/nw,『/w,计算机/n,视觉/n,』/w,mask/en,-/w,rcnn/en,_,推断/vn,网络/n,其/r,二/m,：/w,基于/p,renet/en,101/m,的/u,fpn/en,共享/v,网络/n,『/w,计算机/n,视觉/n,』/w,mask/en,-/w,rcnn/en,_,推断/vn,网络/n,其/r,三/m,：/w,rpn/en,锚框/nw,处理/v,和/c,proposal/en,生成/vn,『/w,计算机/n,视觉/n,』/w,mask/en,-/w,rcnn/en,_,推断/vn,网络/n,其/r,四/m,：/w,fpn/en,和/c,roialign/en,的/u,耦合/vn,『/w,计算机/n,视觉/n,』/w,mask/en,-/w,rcnn/en,_,推断/vn,网络/n,其/r,五/m,：/w,目标/n,检测/vn,结果/n,精炼/a,『/w,计算机/n,视觉/n,』/w,mask/en,-/w,rcnn/en,_,推断/vn,网络/n,其/r,六/m,：/w,mask/en,生成/vn,『/w,计算机/n,视觉/n,』/w,mask/en,-/w,rcnn/en,_,推断/vn,网络/n,终篇/nw,：/w,使用/v,detect/en,方法/n,进行/v,推断/vn,『/w,计算机/n,视觉/n,』/w,mask/en,-/w,rcnn/en,_,锚框/nw,生成/vn,『/w,计算机/n,视觉/n,』/w,mask/en,-/w,rcnn/en,_,训练/vn,网络/n,其一/r,：/w,数据集/nw,与/p,dataset/en,类/q,『/w,计算机/n,视觉/n,』/w,mask/en,-/w,rcnn/en,_,训练/vn,网络/n,其/r,二/m,：/w,train/en,网络结构/l,&/w,损失/n,函数/n,『/w,计算机/n,视觉/n,』/w,mask/en,-/w,rcnn/en,_,训练/vn,网络/n,其/r,三/m,：/w,训练/vn,model/en,一/m,、/w,training/en,网络/n,简介/n,流程/n,和/c,inference/en,大部分/m,一致/a,，/w,在/p,下/f,图/n,中/f,我们/r,将/d,之前/f,inference/en,就/d,介绍/v,过/u,的/u,分类/vn,、/w,回归/v,和/c,掩码/nw,生成/vn,流程/n,压缩/v,到/v,一个/m,块/q,中/f,，/w,以便/d,其他/r,部分/n,更为/d,清晰/a,。/w,而/c,两者/r,主要/b,不同/a,之/u,处/n,为/p,：/w,网络/n,输入/v,：/w,输入/v,tensor/en,增加/v,到/v,了/u,7个/m,之/u,多/a,（/w,图/n,上/f,画/v,出/v,的/u,6个/m,以及/c,image/en,_,meta/en,）/w,,/w,大部分/m,是/v,计算/v,loss/en,的/u,标签/n,前/f,置/v,损失/n,函数/n,：/w,添加/vn,了/u,5个/m,损失/n,函数/n,，/w,2个/m,用于/v,rpn/en,计算/v,，/w,2个/m,用于/v,最终/d,分类/vn,回归/v,instance/en,，/w,1个/m,用于/v,掩码/nw,损失/n,计算/v,原始/a,标签/n,处理/v,：/w,推理/vn,网络/n,中/f,，/w,proposeal/en,筛选/v,出来/v,的/u,rpn/en,_,rois/en,直接/ad,用于/v,生成/vn,分类/vn,回归/v,以及/c,掩码/nw,信息/n,，/w,而/c,training/en,中/f,这些/r,候选区/ns,需要/v,和/c,图片/n,标签/n,信息/n,进行/v,运算/vn,，/w,生成/vn,有/v,训练/vn,价值/n,的/u,输出/v,，/w,进行/v,后面/f,的/u,生成/vn,以及/c,损失/n,函数/n,计算/v,首先/d,初始化/v,并/c,载入/v,预训练/nw,参数/n,（/w,下/f,节会/nw,介绍/v,本/r,部分/n,相关/v,操作/v,）/w,，/w,然后/c,经由/p,下面/f,几/m,行/v,代码/n,，/w,即/v,可/v,进行/v,训练/vn,，/w,网络/n,输入/v,build/en,函数/n,在/p,train/en,方法/n,中/f,被/p,调用/v,（/w,model/en,./w,py/en,）/w,，/w,涉及/v,巨/ag,多/a,预/d,处理/v,函数/n,设计/vn,，/w,需要/v,的/u,时候/n,自行/d,进入/v,train/en,方法/n,查看/v,（/w,更/d,确切/a,的/u,说是/v,在/p,data/en,_,generator/en,方法/n,，/w,由/p,train/en,调用/v,）/w,，/w,-/w, ,images/en,:/w, ,[/w,batch/en,,/w, ,h/en,,/w, ,w/en,,/w, ,c/en,]/w,-/w, ,image/en,_,meta/en,:/w, ,[/w,batch/en,,/w, ,(/w,meta/en, ,data/en,)/w,]/w, ,image/en, ,details/en,./w, ,see/en, ,compose/en,_,image/en,_,meta/en,(/w,)/w,-/w, ,rpn/en,_,match/en,:/w, ,[/w,batch/en,,/w, ,n/en,]/w, ,integer/en, ,(/w,1/m,=/w,positive/en, ,anchor/en,,/w, ,-/w,1/m,=/w,negative/en,,/w, ,0/m,=/w,neutral/en,)/w,-/w, ,rpn/en,_,bbox/en,:/w, ,[/w,batch/en,,/w, ,n/en,,/w, ,(/w,dy/en,,/w, ,dx/en,,/w, ,log/en,(/w,dh/en,)/w,,/w, ,log/en,(/w,dw/en,)/w,)/w,]/w, ,anchor/en, ,bbox/en, ,deltas/en,./w,-/w, ,gt/en,_,class/en,_,ids/en,:/w, ,[/w,batch/en,,/w, ,max/en,_,gt/en,_,instances/en,]/w, ,integer/en, ,class/en, ,ids/en,-/w, ,gt/en,_,boxes/en,:/w, ,[/w,batch/en,,/w, ,max/en,_,gt/en,_,instances/en,,/w, ,(/w,y/en,1/m,,/w, ,x/en,1/m,,/w, ,y/en,2/m,,/w, ,x/en,2/m,)/w,]/w,-/w, ,gt/en,_,masks/en,:/w, ,[/w,batch/en,,/w, ,height/en,,/w, ,width/en,,/w, ,max/en,_,gt/en,_,instances/en,]/w,./w, ,the/en, ,height/en, ,and/en, ,widthare/en, ,those/en, ,of/en, ,the/en, ,image/en, ,unless/en, ,use/en,_,mini/en,_,mask/en, ,is/en, ,true/en,,/w, ,in/en, ,whichcase/en, ,they/en, ,are/en, ,defined/en, ,in/en, ,mini/en,_,mask/en,_,shape/en,./w,原始/a,标签/n,处理/v,然后/c,我们/r,在/p,开篇/n,流程/n,图/n,中/f,标注/v,了/u,一个/m,名/q,为/p,"/w,检测/vn,目标/n,处理/v,"/w,的/u,框/q,，/w,对应/v,代码/n,如下/v,：/w,#, ,generate/en, ,detection/en, ,targets/en, ,#, ,subsamples/en, ,proposals/en, ,and/en, ,generates/en, ,target/en, ,outputs/en, ,for/en, ,training/en, ,#, ,note/en, ,that/en, ,proposal/en, ,class/en, ,ids/en,,/w, ,gt/en,_,boxes/en,,/w, ,and/en, ,gt/en,_,masks/en, ,are/en, ,zero/en, ,#, ,padded/en,./w, ,equally/en,,/w, ,returned/en, ,rois/en, ,and/en, ,targets/en, ,are/en, ,zero/en, ,padded/en,./w, ,rois/en,,/w, ,target/en,_,class/en,_,ids/en,,/w, ,target/en,_,bbox/en,,/w, ,target/en,_,mask/en, ,=/w,\/w, ,detectiontargetlayer/en,(/w,config/en,,/w, ,name/en,=/w,"/w,proposal/en,_,targets/en,"/w,)/w,(/w,[/w, ,target/en,_,rois/en,,/w, ,input/en,_,gt/en,_,class/en,_,ids/en,,/w, ,gt/en,_,boxes/en,,/w, ,input/en,_,gt/en,_,masks/en,]/w,)/w,其/r,目的/n,是/v,将/d,原始/a,的/u,图像/n,信息/n,input/en,和/c,proposal/en,们/k,进行/v,计算/v,融合/v,，/w,输出/v,可以/v,用于/v,loss/en,计算/v,的/u,标准/n,的/u,格式/n,，/w,文档/n,很/d,清晰/a,，/w,"/w,"/w,"/w,subsamples/en, ,proposals/en, ,and/en, ,generates/en, ,target/en, ,box/en, ,refinement/en,,/w, ,class/en,_,ids/en,,/w,and/en, ,masks/en, ,for/en, ,each/en,./w,inputs/en,:/w,proposals/en,:/w, ,[/w,batch/en,,/w, ,n/en,,/w, ,(/w,y/en,1/m,,/w, ,x/en,1/m,,/w, ,y/en,2/m,,/w, ,x/en,2/m,)/w,]/w, ,in/en, ,normalized/en, ,coordinates/en,./w, ,mightbe/en, ,zero/en, ,padded/en, ,if/en, ,there/en, ,are/en, ,not/en, ,enough/en, ,proposals/en,./w,gt/en,_,class/en,_,ids/en,:/w,[/w,batch/en,,/w, ,max/en,_,gt/en,_,instances/en,]/w, ,integer/en, ,class/en, ,ids/en,./w,gt/en,_,boxes/en,:/w, ,[/w,batch/en,,/w, ,max/en,_,gt/en,_,instances/en,,/w, ,(/w,y/en,1/m,,/w, ,x/en,1/m,,/w, ,y/en,2/m,,/w, ,x/en,2/m,)/w,]/w, ,in/en, ,normalizedcoordinates/en,./w,gt/en,_,masks/en,:/w, ,[/w,batch/en,,/w, ,height/en,,/w, ,width/en,,/w, ,max/en,_,gt/en,_,instances/en,]/w, ,of/en, ,boolean/en, ,typereturns/en,:/w, ,target/en, ,rois/en, ,and/en, ,corresponding/en, ,class/en, ,ids/en,,/w, ,bounding/en, ,box/en, ,shifts/en,,/w,and/en, ,masks/en,./w,rois/en,:/w, ,[/w,batch/en,,/w, ,train/en,_,rois/en,_,per/en,_,image/en,,/w, ,(/w,y/en,1/m,,/w, ,x/en,1/m,,/w, ,y/en,2/m,,/w, ,x/en,2/m,)/w,]/w, ,in/en, ,normalizedcoordinatestarget/en,_,class/en,_,ids/en,:/w, ,[/w,batch/en,,/w, ,train/en,_,rois/en,_,per/en,_,image/en,]/w,./w, ,integer/en, ,class/en, ,ids/en,./w,target/en,_,deltas/en,:/w, ,[/w,batch/en,,/w, ,train/en,_,rois/en,_,per/en,_,image/en,,/w, ,(/w,dy/en,,/w, ,dx/en,,/w, ,log/en,(/w,dh/en,)/w,,/w, ,log/en,(/w,dw/en,)/w,]/w,target/en,_,mask/en,:/w, ,[/w,batch/en,,/w, ,train/en,_,rois/en,_,per/en,_,image/en,,/w, ,height/en,,/w, ,width/en,]/w,masks/en, ,cropped/en, ,to/en, ,bbox/en, ,boundaries/en, ,and/en, ,resized/en, ,to/en, ,neuralnetwork/en, ,output/en, ,size/en,./w,note/en,:/w, ,returned/en, ,arrays/en, ,might/en, ,be/en, ,zero/en, ,padded/en, ,if/en, ,not/en, ,enough/en, ,target/en, ,rois/en,./w,"/w,"/w,"/w,这个/r,处理/v,之后/f,，/w,结构/n,同/p,inference/en,中/f,的/u,介绍/v,，/w,mrcnn/en,_,class/en,_,logits/en,,/w, ,mrcnn/en,_,class/en,,/w, ,mrcnn/en,_,bbox/en, ,=/w,\/w, ,fpn/en,_,classifier/en,_,graph/en,(/w,rois/en,,/w, ,mrcnn/en,_,feature/en,_,maps/en,,/w, ,input/en,_,image/en,_,meta/en,,/w, ,config/en,./w,pool/en,_,size/en,,/w, ,config/en,./w,num/en,_,classes/en,,/w, ,train/en,_,bn/en,=/w,config/en,./w,train/en,_,bn/en,,/w, ,fc/en,_,layers/en,_,size/en,=/w,config/en,./w,fpn/en,_,classif/en,_,fc/en,_,layers/en,_,size/en,)/w, ,mrcnn/en,_,mask/en, ,=/w, ,build/en,_,fpn/en,_,mask/en,_,graph/en,(/w,rois/en,,/w, ,mrcnn/en,_,feature/en,_,maps/en,,/w, ,input/en,_,image/en,_,meta/en,,/w, ,config/en,./w,mask/en,_,pool/en,_,size/en,,/w, ,config/en,./w,num/en,_,classes/en,,/w, ,train/en,_,bn/en,=/w,config/en,./w,train/en,_,bn/en,)/w,损失/n,函数/n,然后/c,就/d,是/v,损失/n,函数/n,了/u,（/w,浩浩荡荡/i,10/m,来/v,行/v,……/w,）/w,，/w,注意/v,output/en,_,rois/en,这/r,一行/n,，/w,我们/r,之前/f,就/d,提/v,过/u,，/w,keras/en,中/f,接收/v,tf/en,的/u,tensor/en,只能/v,作为/v,class/en,的/u,初始化/v,参数/n,，/w,而/c,不能/v,作为/v,网络/n,数据流/n,，/w,所以/c,这里/r,加/v,了/u,一层/mq,封装/vn,，/w,output/en,_,rois/en, ,=/w, ,kl/en,./w,lambda/en,(/w,lambda/en, ,x/en,:/w, ,x/en, ,*/w, ,1/m,,/w, ,name/en,=/w,"/w,output/en,_,rois/en,"/w,)/w,(/w,rois/en,)/w, ,#, ,losses/en, ,rpn/en,_,class/en,_,loss/en, ,=/w, ,kl/en,./w,lambda/en,(/w,lambda/en, ,x/en,:/w, ,rpn/en,_,class/en,_,loss/en,_,graph/en,(/w,*/w,x/en,)/w,,/w, ,name/en,=/w,"/w,rpn/en,_,class/en,_,loss/en,"/w,)/w,(/w, ,[/w,input/en,_,rpn/en,_,match/en,,/w, ,rpn/en,_,class/en,_,logits/en,]/w,)/w, ,rpn/en,_,bbox/en,_,loss/en, ,=/w, ,kl/en,./w,lambda/en,(/w,lambda/en, ,x/en,:/w, ,rpn/en,_,bbox/en,_,loss/en,_,graph/en,(/w,config/en,,/w, ,*/w,x/en,)/w,,/w, ,name/en,=/w,"/w,rpn/en,_,bbox/en,_,loss/en,"/w,)/w,(/w, ,[/w,input/en,_,rpn/en,_,bbox/en,,/w, ,input/en,_,rpn/en,_,match/en,,/w, ,rpn/en,_,bbox/en,]/w,)/w, ,class/en,_,loss/en, ,=/w, ,kl/en,./w,lambda/en,(/w,lambda/en, ,x/en,:/w, ,mrcnn/en,_,class/en,_,loss/en,_,graph/en,(/w,*/w,x/en,)/w,,/w, ,name/en,=/w,"/w,mrcnn/en,_,class/en,_,loss/en,"/w,)/w,(/w, ,[/w,target/en,_,class/en,_,ids/en,,/w, ,mrcnn/en,_,class/en,_,logits/en,,/w, ,active/en,_,class/en,_,ids/en,]/w,)/w, ,bbox/en,_,loss/en, ,=/w, ,kl/en,./w,lambda/en,(/w,lambda/en, ,x/en,:/w, ,mrcnn/en,_,bbox/en,_,loss/en,_,graph/en,(/w,*/w,x/en,)/w,,/w, ,name/en,=/w,"/w,mrcnn/en,_,bbox/en,_,loss/en,"/w,)/w,(/w, ,[/w,target/en,_,bbox/en,,/w, ,target/en,_,class/en,_,ids/en,,/w, ,mrcnn/en,_,bbox/en,]/w,)/w, ,mask/en,_,loss/en, ,=/w, ,kl/en,./w,lambda/en,(/w,lambda/en, ,x/en,:/w, ,mrcnn/en,_,mask/en,_,loss/en,_,graph/en,(/w,*/w,x/en,)/w,,/w, ,name/en,=/w,"/w,mrcnn/en,_,mask/en,_,loss/en,"/w,)/w,(/w, ,[/w,target/en,_,mask/en,,/w, ,target/en,_,class/en,_,ids/en,,/w, ,mrcnn/en,_,mask/en,]/w,)/w,二/m,、/w,损失/n,函数/n,简介/n,rpn/en,分类/vn,损失/n,我们/r,先/d,看/v,一下/m,rpn/en,真实/a,标签/n,生成/vn,函数/n,中/f,的/u,一段/mq,注释/vn,，/w,#, ,match/en, ,anchors/en, ,to/en, ,gt/en, ,boxes/en,#, ,if/en, ,an/en, ,anchor/en, ,overlaps/en, ,a/en, ,gt/en, ,box/en, ,with/en, ,iou/en, ,>,=/w, ,0.7/m, ,then/en, ,it/en,'/w,s/en, ,positive/en,./w,#, ,if/en, ,an/en, ,anchor/en, ,overlaps/en, ,a/en, ,gt/en, ,box/en, ,with/en, ,iou/en, ,</w, ,0.3/m, ,then/en, ,it/en,'/w,s/en, ,negative/en,./w,#, ,neutral/en, ,anchors/en, ,are/en, ,those/en, ,that/en, ,don/en,'/w,t/en, ,match/en, ,the/en, ,conditions/en, ,above/en,,/w,#, ,and/en, ,they/en, ,don/en,'/w,t/en, ,influence/en, ,the/en, ,loss/en, ,function/en,./w,#, ,however/en,,/w, ,don/en,'/w,t/en, ,keep/en, ,any/en, ,gt/en, ,box/en, ,unmatched/en, ,(/w,rare/en,,/w, ,but/en, ,happens/en,)/w,./w, ,instead/en,,/w,#, ,match/en, ,it/en, ,to/en, ,the/en, ,closest/en, ,anchor/en, ,(/w,even/en, ,if/en, ,its/en, ,max/en, ,iou/en, ,is/en, ,</w, ,0.3/m,)/w,./w,然后/c,看/v,本/r,损失/n,函数/n,，/w,def/en, ,rpn/en,_,class/en,_,loss/en,_,graph/en,(/w,rpn/en,_,match/en,,/w, ,rpn/en,_,class/en,_,logits/en,)/w,:/w, ,"/w,"/w,"/w,rpn/en, ,anchor/en, ,classifier/en, ,loss/en,./w, ,rpn/en,_,match/en,:/w, ,[/w,batch/en,,/w, ,anchors/en,,/w, ,1/m,]/w,./w, ,anchor/en, ,match/en, ,type/en,./w, ,1/m,=/w,positive/en,,/w, ,-/w,1/m,=/w,negative/en,,/w, ,0/m,=/w,neutral/en, ,anchor/en,./w, ,rpn/en,_,class/en,_,logits/en,:/w, ,[/w,batch/en,,/w, ,anchors/en,,/w, ,2/m,]/w,./w, ,rpn/en, ,classifier/en, ,logits/en, ,for/en, ,fg/en,//w,bg/en,./w, ,"/w,"/w,"/w, ,#, ,squeeze/en, ,last/en, ,dim/en, ,to/en, ,simplify/en, ,rpn/en,_,match/en, ,=/w, ,tf/en,./w,squeeze/en,(/w,rpn/en,_,match/en,,/w, ,-/w,1/m,)/w, ,#, ,get/en, ,anchor/en, ,classes/en,./w, ,convert/en, ,the/en, ,-/w,1/m,//w,+/w,1/m, ,match/en, ,to/en, ,0/m,//w,1/m, ,values/en,./w, ,anchor/en,_,class/en, ,=/w, ,k/en,./w,cast/en,(/w,k/en,./w,equal/en,(/w,rpn/en,_,match/en,,/w, ,1/m,)/w,,/w, ,tf/en,./w,int/en,32/m,)/w, ,#, ,positive/en, ,and/en, ,negative/en, ,anchors/en, ,contribute/en, ,to/en, ,the/en, ,loss/en,,/w, ,#, ,but/en, ,neutral/en, ,anchors/en, ,(/w,match/en, ,value/en, ,=/w, ,0/m,)/w, ,don/en,'/w,t/en,./w, ,indices/en, ,=/w, ,tf/en,./w,where/en,(/w,k/en,./w,not/en,_,equal/en,(/w,rpn/en,_,match/en,,/w, ,0/m,)/w,)/w, ,#, ,pick/en, ,rows/en, ,that/en, ,contribute/en, ,to/en, ,the/en, ,loss/en, ,and/en, ,filter/en, ,out/en, ,the/en, ,rest/en,./w, ,rpn/en,_,class/en,_,logits/en, ,=/w, ,tf/en,./w,gather/en,_,nd/en,(/w,rpn/en,_,class/en,_,logits/en,,/w, ,indices/en,)/w, ,anchor/en,_,class/en, ,=/w, ,tf/en,./w,gather/en,_,nd/en,(/w,anchor/en,_,class/en,,/w, ,indices/en,)/w, ,#, ,cross/en, ,entropy/en, ,loss/en, ,loss/en, ,=/w, ,k/en,./w,sparse/en,_,categorical/en,_,crossentropy/en,(/w,target/en,=/w,anchor/en,_,class/en,,/w, ,output/en,=/w,rpn/en,_,class/en,_,logits/en,,/w, ,from/en,_,logits/en,=/w,true/en,)/w, ,loss/en, ,=/w, ,k/en,./w,switch/en,(/w,tf/en,./w,size/en,(/w,loss/en,)/w, ,>, ,0/m,,/w, ,k/en,./w,mean/en,(/w,loss/en,)/w,,/w, ,tf/en,./w,constant/en,(/w,0.0/m,)/w,)/w, ,return/en, ,loss/en,真实/a,标签/n,有/v,{/w,1/m,，/w, ,0/m,，/w, ,-/w,1/m,}/w,三种/mq,，/w,logits/en,结果/n,在/p,0/m,~/w,1/m,分布/v,，/w,而/c,在/p,rpn/en,分类/vn,结果/n,中/f,，/w,真实/a,标签/n,为/p,0/m,的/u,anchors/en,不/d,参与/v,损失/n,函数/n,的/u,构建/v,，/w,所以/c,我们/r,将/d,标签/n,为/p,0/m,的/u,真实/a,标签/n,剔除/v,，/w,然后/c,将/d,-/w,1/m,标签/n,转换/v,为/p,0/m,进行/v,交叉/vn,熵/g,计算/v,。/w,rpn/en,回归/v,损失/n,def/en, ,rpn/en,_,bbox/en,_,loss/en,_,graph/en,(/w,config/en,,/w, ,target/en,_,bbox/en,,/w, ,rpn/en,_,match/en,,/w, ,rpn/en,_,bbox/en,)/w,:/w, ,"/w,"/w,"/w,return/en, ,the/en, ,rpn/en, ,bounding/en, ,box/en, ,loss/en, ,graph/en,./w, ,config/en,:/w, ,the/en, ,model/en, ,config/en, ,object/en,./w, ,target/en,_,bbox/en,:/w, ,[/w,batch/en,,/w, ,max/en, ,positive/en, ,anchors/en,,/w, ,(/w,dy/en,,/w, ,dx/en,,/w, ,log/en,(/w,dh/en,)/w,,/w, ,log/en,(/w,dw/en,)/w,)/w,]/w,./w, ,uses/en, ,0/m, ,padding/en, ,to/en, ,fill/en, ,in/en, ,unsed/en, ,bbox/en, ,deltas/en,./w, ,rpn/en,_,match/en,:/w, ,[/w,batch/en,,/w, ,anchors/en,,/w, ,1/m,]/w,./w, ,anchor/en, ,match/en, ,type/en,./w, ,1/m,=/w,positive/en,,/w, ,-/w,1/m,=/w,negative/en,,/w, ,0/m,=/w,neutral/en, ,anchor/en,./w, ,rpn/en,_,bbox/en,:/w, ,[/w,batch/en,,/w, ,anchors/en,,/w, ,(/w,dy/en,,/w, ,dx/en,,/w, ,log/en,(/w,dh/en,)/w,,/w, ,log/en,(/w,dw/en,)/w,)/w,]/w, ,"/w,"/w,"/w, ,#, ,input/en,_,rpn/en,_,bbox/en,,/w, ,input/en,_,rpn/en,_,match/en,,/w, ,rpn/en,_,bbox/en, ,#, ,positive/en, ,anchors/en, ,contribute/en, ,to/en, ,the/en, ,loss/en,,/w, ,but/en, ,negative/en, ,and/en, ,#, ,neutral/en, ,anchors/en, ,(/w,match/en, ,value/en, ,of/en, ,0/m, ,or/en, ,-/w,1/m,)/w, ,don/en,'/w,t/en,./w, ,rpn/en,_,match/en, ,=/w, ,k/en,./w,squeeze/en,(/w,rpn/en,_,match/en,,/w, ,-/w,1/m,)/w, ,#, ,[/w,batch/en,,/w, ,anchors/en,]/w, ,indices/en, ,=/w, ,tf/en,./w,where/en,(/w,k/en,./w,equal/en,(/w,rpn/en,_,match/en,,/w, ,1/m,)/w,)/w, ,#, ,pick/en, ,bbox/en, ,deltas/en, ,that/en, ,contribute/en, ,to/en, ,the/en, ,loss/en, ,rpn/en,_,bbox/en, ,=/w, ,tf/en,./w,gather/en,_,nd/en,(/w,rpn/en,_,bbox/en,,/w, ,indices/en,)/w, ,#, ,[/w,n/en,,/w, ,4/m,]/w, ,#, ,trim/en, ,target/en, ,bounding/en, ,box/en, ,deltas/en, ,to/en, ,the/en, ,same/en, ,length/en, ,as/en, ,rpn/en,_,bbox/en,./w, ,batch/en,_,counts/en, ,=/w, ,k/en,./w,sum/en,(/w,k/en,./w,cast/en,(/w,k/en,./w,equal/en,(/w,rpn/en,_,match/en,,/w, ,1/m,)/w,,/w, ,tf/en,./w,int/en,32/m,)/w,,/w, ,axis/en,=/w,1/m,)/w, ,#, ,1/m,标签/n,数目/n, ,#, ,target/en,_,bbox/en,:/w, ,[/w,batch/en,,/w, ,max/en, ,positive/en, ,anchors/en,,/w, ,(/w,dy/en,,/w, ,dx/en,,/w, ,log/en,(/w,dh/en,)/w,,/w, ,log/en,(/w,dw/en,)/w,)/w,]/w, ,#, ,rpn/en,_,match/en,:/w, ,[/w,batch/en,]/w, ,target/en,_,bbox/en, ,=/w, ,batch/en,_,pack/en,_,graph/en,(/w,target/en,_,bbox/en,,/w, ,batch/en,_,counts/en,,/w, ,config/en,./w,images/en,_,per/en,_,gpu/en,)/w, ,loss/en, ,=/w, ,smooth/en,_,l/en,1/m,_,loss/en,(/w,target/en,_,bbox/en,,/w, ,rpn/en,_,bbox/en,)/w, ,loss/en, ,=/w, ,k/en,./w,switch/en,(/w,tf/en,./w,size/en,(/w,loss/en,)/w, ,>, ,0/m,,/w, ,k/en,./w,mean/en,(/w,loss/en,)/w,,/w, ,tf/en,./w,constant/en,(/w,0.0/m,)/w,)/w, ,return/en, ,loss/en,仅仅/d,真实/a,标签/n,为/p,1/m,的/u,类/q,参与/v,回归/v,运算/vn,，/w,对于/p,target/en,_,bbox/en,，/w,虽然/c,对/p,每张/r,图片/n,其/r,框数/nw,一致/a,且/c,和/c,rpn/en,_,match/en,的/u,第二/m,维度/n,相等/v,，/w,但是/c,对于/p,图片/n,i/en,只/d,有/v,前面/f,的/u,ni/en,个/q,框/q,有/v,意义/n,（/w,而/c,不/d,是/v,和/c,anchors/en,一一/d,对应/v,的/u,）/w,，/w,后面/f,为/p,0/m,填充/v,，/w,ni/en,值/n,等于/v,对应/v,图片/n,的/u,rpn/en,_,match/en,等于/v,1/m,的/u,数目/n,（/w,推测/v,）/w,target/en,_,bbox/en,中/f,bbox/en,坐标/n,的/u,排列/v,顺序/n,等于/v,rpn/en,_,match/en,中/f,的/u,标识/n,顺序/n,，/w,所以/c,使用/v,rpn/en,_,match/en,索引/n,出/v,rpn/en,_,bbox/en,对应/v,1/m,的/u,位置/n,后/f,直接/ad,和/c,target/en,_,bbox/en,的/u,前/f,ni/en,运算/vn,即可/v,def/en, ,batch/en,_,pack/en,_,graph/en,(/w,x/en,,/w, ,counts/en,,/w, ,num/en,_,rows/en,)/w,:/w, ,"/w,"/w,"/w,picks/en, ,different/en, ,number/en, ,of/en, ,values/en, ,from/en, ,each/en, ,row/en, ,in/en, ,x/en, ,depending/en, ,on/en, ,the/en, ,values/en, ,in/en, ,counts/en,./w, ,x/en,:/w, ,[/w,batch/en,,/w, ,max/en, ,positive/en, ,anchors/en,,/w, ,(/w,dy/en,,/w, ,dx/en,,/w, ,log/en,(/w,dh/en,)/w,,/w, ,log/en,(/w,dw/en,)/w,)/w,]/w, ,counts/en,:/w, ,[/w,batch/en,]/w, ,"/w,"/w,"/w, ,outputs/en, ,=/w, ,[/w,]/w, ,for/en, ,i/en, ,in/en, ,range/en,(/w,num/en,_,rows/en,)/w,:/w, ,outputs/en,./w,append/en,(/w,x/en,[/w,i/en,,/w, ,:/w,counts/en,[/w,i/en,]/w,]/w,)/w, ,return/en, ,tf/en,./w,concat/en,(/w,outputs/en,,/w, ,axis/en,=/w,0/m,)/w,损失/n,函数/n,使用/v,smooth/en,_,l/en,1/m,_,loss/en,（/w,坐标/n,回归/v,都/d,用/p,这个/r,？/w,）/w,def/en, ,smooth/en,_,l/en,1/m,_,loss/en,(/w,y/en,_,true/en,,/w, ,y/en,_,pred/en,)/w,:/w, ,"/w,"/w,"/w,implements/en, ,smooth/en,-/w,l/en,1/m, ,loss/en,./w, ,y/en,_,true/en, ,and/en, ,y/en,_,pred/en, ,are/en, ,typically/en,:/w, ,[/w,n/en,,/w, ,4/m,]/w,,/w, ,but/en, ,could/en, ,be/en, ,any/en, ,shape/en,./w, ,"/w,"/w,"/w, ,diff/en, ,=/w, ,k/en,./w,abs/en,(/w,y/en,_,true/en, ,-/w, ,y/en,_,pred/en,)/w, ,less/en,_,than/en,_,one/en, ,=/w, ,k/en,./w,cast/en,(/w,k/en,./w,less/en,(/w,diff/en,,/w, ,1.0/m,)/w,,/w, ,"/w,float/en,32/m,"/w,)/w, ,loss/en, ,=/w, ,(/w,less/en,_,than/en,_,one/en, ,*/w, ,0.5/m, ,*/w, ,diff/en,*/w,*/w,2/m,)/w, ,+/w, ,(/w,1/m, ,-/w, ,less/en,_,than/en,_,one/en,)/w, ,*/w, ,(/w,diff/en, ,-/w, ,0.5/m,)/w, ,return/en, ,loss/en,附/v,我/r,在/p,数据/n,准备/v,函数/n,build/en,_,rpn/en,_,targets/en,中/f,查询/v,到/v,如下/v,片段/n,，/w,可以/v,佐证/n,上面/f,说法/n,（/w,下面/f,的/u,rpn/en,_,box/en,对应/v,上面/f,的/u,target/en,_,bbox/en,）/w,，/w,即/v,target/en,_,box/en,和/c,anchor/en,并/c,不/d,一一/d,对应/v,，/w,仅/d,根据/p,正/d,样本/n,标签/n,数目/n,进行/v,填充/v,，/w,代码/n,片段/n,1/m,（/w,两者/r,注册/v,长度/n,都/d,不/d,一样/u,）/w,：/w,#, ,rpn/en, ,match/en,:/w, ,1/m, ,=/w, ,positive/en, ,anchor/en,,/w, ,-/w,1/m, ,=/w, ,negative/en, ,anchor/en,,/w, ,0/m, ,=/w, ,neutral/en, ,rpn/en,_,match/en, ,=/w, ,np/en,./w,zeros/en,(/w,[/w,anchors/en,./w,shape/en,[/w,0/m,]/w,]/w,,/w, ,dtype/en,=/w,np/en,./w,int/en,32/m,)/w, ,#, ,rpn/en, ,bounding/en, ,boxes/en,:/w, ,[/w,max/en, ,anchors/en, ,per/en, ,image/en,,/w, ,(/w,dy/en,,/w, ,dx/en,,/w, ,log/en,(/w,dh/en,)/w,,/w, ,log/en,(/w,dw/en,)/w,)/w,]/w, ,rpn/en,_,bbox/en, ,=/w, ,np/en,./w,zeros/en,(/w,(/w,config/en,./w,rpn/en,_,train/en,_,anchors/en,_,per/en,_,image/en,,/w, ,4/m,)/w,)/w,代码/n,片段/n,2/m,：/w,#, ,for/en, ,positive/en, ,anchors/en,,/w, ,compute/en, ,shift/en, ,and/en, ,scale/en, ,needed/en, ,to/en, ,transform/en, ,them/en, ,#, ,to/en, ,match/en, ,the/en, ,corresponding/en, ,gt/en, ,boxes/en,./w, ,ids/en, ,=/w, ,np/en,./w,where/en,(/w,rpn/en,_,match/en, ,=/w,=/w, ,1/m,)/w,[/w,0/m,]/w, ,ix/en, ,=/w, ,0/m, ,#, ,index/en, ,into/en, ,rpn/en,_,bbox/en, ,#, ,todo/en,:/w, ,use/en, ,box/en,_,refinement/en,(/w,)/w, ,rather/en, ,than/en, ,duplicating/en, ,the/en, ,code/en, ,here/en, ,for/en, ,i/en,,/w, ,a/en, ,in/en, ,zip/en,(/w,ids/en,,/w, ,anchors/en,[/w,ids/en,]/w,)/w,:/w, ,#, ,closest/en, ,gt/en, ,box/en, ,(/w,it/en, ,might/en, ,have/en, ,iou/en, ,</w, ,0.7/m,)/w, ,gt/en, ,=/w, ,gt/en,_,boxes/en,[/w,anchor/en,_,iou/en,_,argmax/en,[/w,i/en,]/w,]/w, ,#, ,convert/en, ,coordinates/en, ,to/en, ,center/en, ,plus/en, ,width/en,//w,height/en,./w, ,#, ,gt/en, ,box/en, ,gt/en,_,h/en, ,=/w, ,gt/en,[/w,2/m,]/w, ,-/w, ,gt/en,[/w,0/m,]/w, ,gt/en,_,w/en, ,=/w, ,gt/en,[/w,3/m,]/w, ,-/w, ,gt/en,[/w,1/m,]/w, ,gt/en,_,center/en,_,y/en, ,=/w, ,gt/en,[/w,0/m,]/w, ,+/w, ,0.5/m, ,*/w, ,gt/en,_,h/en, ,gt/en,_,center/en,_,x/en, ,=/w, ,gt/en,[/w,1/m,]/w, ,+/w, ,0.5/m, ,*/w, ,gt/en,_,w/en, ,#, ,anchor/en, ,a/en,_,h/en, ,=/w, ,a/en,[/w,2/m,]/w, ,-/w, ,a/en,[/w,0/m,]/w, ,a/en,_,w/en, ,=/w, ,a/en,[/w,3/m,]/w, ,-/w, ,a/en,[/w,1/m,]/w, ,a/en,_,center/en,_,y/en, ,=/w, ,a/en,[/w,0/m,]/w, ,+/w, ,0.5/m, ,*/w, ,a/en,_,h/en, ,a/en,_,center/en,_,x/en, ,=/w, ,a/en,[/w,1/m,]/w, ,+/w, ,0.5/m, ,*/w, ,a/en,_,w/en, ,#, ,compute/en, ,the/en, ,bbox/en, ,refinement/en, ,that/en, ,the/en, ,rpn/en, ,should/en, ,predict/en,./w, ,rpn/en,_,bbox/en,[/w,ix/en,]/w, ,=/w, ,[/w, ,(/w,gt/en,_,center/en,_,y/en, ,-/w, ,a/en,_,center/en,_,y/en,)/w, ,//w, ,a/en,_,h/en,,/w, ,(/w,gt/en,_,center/en,_,x/en, ,-/w, ,a/en,_,center/en,_,x/en,)/w, ,//w, ,a/en,_,w/en,,/w, ,np/en,./w,log/en,(/w,gt/en,_,h/en, ,//w, ,a/en,_,h/en,)/w,,/w, ,np/en,./w,log/en,(/w,gt/en,_,w/en, ,//w, ,a/en,_,w/en,)/w,,/w, ,]/w, ,#, ,normalize/en, ,rpn/en,_,bbox/en,[/w,ix/en,]/w, ,//w,=/w, ,config/en,./w,rpn/en,_,bbox/en,_,std/en,_,dev/en, ,ix/en, ,+/w,=/w, ,1/m, ,return/en, ,rpn/en,_,match/en,,/w, ,rpn/en,_,bboxmrcnn/en,分类/vn,损失/n,函数/n,如果/c,分类/vn,得分/n,最高/a,class/en,不/d,对应/v,于/p,本/r,数据集/nw,，/w,则/d,不/d,贡献/n,loss/en,值/n,。/w,def/en, ,mrcnn/en,_,class/en,_,loss/en,_,graph/en,(/w,target/en,_,class/en,_,ids/en,,/w, ,pred/en,_,class/en,_,logits/en,,/w, ,active/en,_,class/en,_,ids/en,)/w,:/w, ,"/w,"/w,"/w,loss/en, ,for/en, ,the/en, ,classifier/en, ,head/en, ,of/en, ,mask/en, ,rcnn/en,./w, ,target/en,_,class/en,_,ids/en,:/w, ,[/w,batch/en,,/w, ,num/en,_,rois/en,]/w,./w, ,integer/en, ,class/en, ,ids/en,./w, ,uses/en, ,zero/en, ,padding/en, ,to/en, ,fill/en, ,in/en, ,the/en, ,array/en,./w, ,pred/en,_,class/en,_,logits/en,:/w, ,[/w,batch/en,,/w, ,num/en,_,rois/en,,/w, ,num/en,_,classes/en,]/w, ,active/en,_,class/en,_,ids/en,:/w, ,[/w,batch/en,,/w, ,num/en,_,classes/en,]/w,./w, ,has/en, ,a/en, ,value/en, ,of/en, ,1/m, ,for/en, ,classes/en, ,that/en, ,are/en, ,in/en, ,the/en, ,dataset/en, ,of/en, ,the/en, ,image/en,,/w, ,and/en, ,0/m, ,for/en, ,classes/en, ,that/en, ,are/en, ,not/en, ,in/en, ,the/en, ,dataset/en,./w, ,"/w,"/w,"/w, ,#, ,during/en, ,model/en, ,building/en,,/w, ,keras/en, ,calls/en, ,this/en, ,function/en, ,with/en, ,#, ,target/en,_,class/en,_,ids/en, ,of/en, ,type/en, ,float/en,32/m,./w, ,unclear/en, ,why/en,./w, ,cast/en, ,it/en, ,#, ,to/en, ,int/en, ,to/en, ,get/en, ,around/en, ,it/en,./w, ,target/en,_,class/en,_,ids/en, ,=/w, ,tf/en,./w,cast/en,(/w,target/en,_,class/en,_,ids/en,,/w, ,'/w,int/en,64/m,'/w,)/w, ,#, ,find/en, ,predictions/en, ,of/en, ,classes/en, ,that/en, ,are/en, ,not/en, ,in/en, ,the/en, ,dataset/en,./w, ,pred/en,_,class/en,_,ids/en, ,=/w, ,tf/en,./w,argmax/en,(/w,pred/en,_,class/en,_,logits/en,,/w, ,axis/en,=/w,2/m,)/w, ,#, ,todo/en,:/w, ,update/en, ,this/en, ,line/en, ,to/en, ,work/en, ,with/en, ,batch/en, ,>, ,1/m,./w, ,right/en, ,now/en, ,it/en, ,assumes/en, ,all/en, ,#, ,images/en, ,in/en, ,a/en, ,batch/en, ,have/en, ,the/en, ,same/en, ,active/en,_,class/en,_,ids/en, ,pred/en,_,active/en, ,=/w, ,tf/en,./w,gather/en,(/w,active/en,_,class/en,_,ids/en,[/w,0/m,]/w,,/w, ,pred/en,_,class/en,_,ids/en,)/w, ,#, ,loss/en, ,loss/en, ,=/w, ,tf/en,./w,nn/en,./w,sparse/en,_,softmax/en,_,cross/en,_,entropy/en,_,with/en,_,logits/en,(/w, ,labels/en,=/w,target/en,_,class/en,_,ids/en,,/w, ,logits/en,=/w,pred/en,_,class/en,_,logits/en,)/w, ,#, ,[/w,batch/en,,/w, ,num/en,_,rois/en,]/w, ,#, ,erase/en, ,losses/en, ,of/en, ,predictions/en, ,of/en, ,classes/en, ,that/en, ,are/en, ,not/en, ,in/en, ,the/en, ,active/en, ,#, ,classes/en, ,of/en, ,the/en, ,image/en,./w, ,loss/en, ,=/w, ,loss/en, ,*/w, ,pred/en,_,active/en, ,#, ,[/w,batch/en,,/w, ,num/en,_,rois/en,]/w,~/w,{/w,0/m,,/w, ,1/m,}/w, ,*/w, ,[/w,batch/en,,/w, ,num/en,_,rois/en,]/w, ,#, ,computer/en, ,loss/en, ,mean/en,./w, ,use/en, ,only/en, ,predictions/en, ,that/en, ,contribute/en, ,#, ,to/en, ,the/en, ,loss/en, ,to/en, ,get/en, ,a/en, ,correct/en, ,mean/en,./w, ,loss/en, ,=/w, ,tf/en,./w,reduce/en,_,sum/en,(/w,loss/en,)/w, ,//w, ,tf/en,./w,reduce/en,_,sum/en,(/w,pred/en,_,active/en,)/w, ,return/en, ,loss/en,涉及/v,到/v,active/en,_,class/en,_,ids/en,相关/v,如下/v,，/w,即将/d,该/r,图片/n,隶属/v,数据/n,集中/v,所有/b,的/u,class/en,标记/n,为/p,1/m,，/w,不/d,隶属/v,本/r,数据/n,集合/v,的/u,class/en,标记/n,为/p,0/m,，/w,计算/v,loss/en,贡献/n,时/ng,交叉/vn,熵会/nw,对/p,每个/r,框/q,进行/v,输出/v,一个/m,值/n,，/w,如果/c,这个/r,框/q,最/d,大/a,的/u,得分/n,class/en,并/c,不/d,属于/v,其/r,数据集/nw,，/w,则/d,不/d,计/v,本框/nw,loss/en,：/w,active/en,_,class/en,_,ids/en, ,=/w, ,kl/en,./w,lambda/en,(/w, ,lambda/en, ,x/en,:/w, ,parse/en,_,image/en,_,meta/en,_,graph/en,(/w,x/en,)/w,[/w,"/w,active/en,_,class/en,_,ids/en,"/w,]/w, ,)/w,(/w,input/en,_,image/en,_,meta/en,)/w, ,#, ,#, ,active/en, ,classes/en, ,#, ,#, ,different/en, ,datasets/en, ,have/en, ,different/en, ,classes/en,,/w, ,so/en, ,track/en, ,the/en, ,#, ,#, ,classes/en, ,supported/en, ,in/en, ,the/en, ,dataset/en, ,of/en, ,this/en, ,image/en,./w, ,#, ,active/en,_,class/en,_,ids/en, ,=/w, ,np/en,./w,zeros/en,(/w,[/w,dataset/en,./w,num/en,_,classes/en,]/w,,/w, ,dtype/en,=/w,np/en,./w,int/en,32/m,)/w, ,#, ,source/en,_,class/en,_,ids/