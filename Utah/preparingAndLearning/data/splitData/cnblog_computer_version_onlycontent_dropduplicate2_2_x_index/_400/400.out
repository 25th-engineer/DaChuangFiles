原文/n,：/w,http/en,:/w,//w,//w,www/en,./w,cnblogs/en,./w,com/en,//w,polly/en,333/m,//w,p/en,//w,5130375/m,./w,html/en,三种/mq,匹配/vn,算法/n,比较/d,bm/en,算法/n,：/w,该/r,算法/n,代码/n,：/w,view/en, ,plaincopy/en, ,to/en, ,clipboardprint/en,?/w,cvstereobmstate/en, ,*/w,bmstate/en, ,=/w, ,cvcreatestereobmstate/en,(/w,)/w,;/w,int/en, ,sadwindowsize/en,=/w,15/m,;/w,bmstate/en,-/w,>,sadwindowsize/en, ,=/w, ,sadwindowsize/en, ,>, ,0/m, ,?/w, ,sadwindowsize/en, ,:/w, ,9/m,;/w,bmstate/en,-/w,>,mindisparity/en, ,=/w, ,0/m,;/w,bmstate/en,-/w,>,numberofdisparities/en, ,=/w, ,32/m,;/w,bmstate/en,-/w,>,texturethreshold/en, ,=/w, ,10/m,;/w,bmstate/en,-/w,>,uniquenessratio/en, ,=/w, ,15/m,;/w,bmstate/en,-/w,>,specklewindowsize/en, ,=/w, ,100/m,;/w,bmstate/en,-/w,>,specklerange/en, ,=/w, ,32/m,;/w,bmstate/en,-/w,>,disp/en,12/m,maxdiff/en, ,=/w, ,1/m,;/w,cvfindstereocorrespondencebm/en,(/w, ,left/en,,/w, ,right/en,,/w, ,left/en,_,disp/en,_,,/w,bmstate/en,)/w,;/w,cvnormalize/en,(/w, ,left/en,_,disp/en,_,,/w, ,left/en,_,vdisp/en,,/w, ,0/m,,/w, ,256/m,,/w, ,cv/en,_,minmax/en, ,)/w,;/w,其中/r,mindisparity/en,是/v,控制/v,匹配/vn,搜索/vn,的/u,第一/m,个/q,参数/n,，/w,代表/n,了/u,匹配/vn,搜苏/nw,从/p,哪里/r,开始/v,，/w,numberofdisparities/en,表示/v,最/d,大/a,搜索/vn,视差/n,数/m,uniquenessratio/en,表示/v,匹配/vn,功能/n,函数/n,，/w,这/r,三个/m,参数/n,比较/d,重要/a,，/w,可以/v,根据/p,实验/vn,给予/v,参数/n,值/n,。/w,该/r,方法/n,速度/n,最/d,快/a,，/w,一副/mq,320/m,*/w,240/m,的/u,灰度/n,图/n,匹配/vn,时间/n,为/p,31/m,ms/en,，/w,视差图/nw,如下/v,。/w,这/r,图/n,是/v,解释/v,bm/en,（/w,bidirectional/en, ,matching/en,)/w,算法/n,的/u,很/d,好/a,的/u,例子/n,。/w,进行/v,双向/d,匹配/vn,，/w,首先/d,通过/p,匹配/vn,代价/n,在/p,右图/n,中/f,计算/v,得出/v,匹配/vn,点/q,。/w,然后/c,相同/a,的/u,原理/n,及/c,计算/v,在/p,左图/n,中/f,的/u,匹配/vn,点/q,。/w,比较/d,找到/v,的/u,左/f,匹配/vn,点/q,和/c,源/ng,匹配/vn,点/q,是否/v,一致/a,，/w,如果/c,你/r,是/v,，/w,则/d,匹配/vn,成功/a,。/w,第二/m,种/q,方法/n,是/v,sgbm/en,方法/n,这/r,是/v,opencv/en,的/u,一种/mq,新/a,算法/n,：/w,view/en, ,plaincopy/en, ,to/en, ,clipboardprint/en,?/w,cv/en,:/w,:/w,stereosgbm/en, ,sgbm/en,;/w,sgbm/en,./w,prefiltercap/en, ,=/w, ,63/m,;/w,int/en, ,sadwindowsize/en,=/w,11/m,;/w,int/en, ,cn/en, ,=/w, ,1/m,;/w,sgbm/en,./w,sadwindowsize/en, ,=/w, ,sadwindowsize/en, ,>, ,0/m, ,?/w, ,sadwindowsize/en, ,:/w, ,3/m,;/w,sgbm/en,./w,p/en,1/m, ,=/w, ,4/m,*/w,cn/en,*/w,sgbm/en,./w,sadwindowsize/en,*/w,sgbm/en,./w,sadwindowsize/en,;/w,sgbm/en,./w,p/en,2/m, ,=/w, ,32/m,*/w,cn/en,*/w,sgbm/en,./w,sadwindowsize/en,*/w,sgbm/en,./w,sadwindowsize/en,;/w,sgbm/en,./w,mindisparity/en, ,=/w, ,0/m,;/w,sgbm/en,./w,numberofdisparities/en, ,=/w, ,32/m,;/w,sgbm/en,./w,uniquenessratio/en, ,=/w, ,10/m,;/w,sgbm/en,./w,specklewindowsize/en, ,=/w, ,100/m,;/w,sgbm/en,./w,specklerange/en, ,=/w, ,32/m,;/w,sgbm/en,./w,disp/en,12/m,maxdiff/en, ,=/w, ,1/m,;/w,sgbm/en,(/w,left/en, ,,/w, ,right/en, ,,/w, ,left/en,_,disp/en,_,)/w,;/w,sgbm/en,(/w,right/en,,/w, ,left/en, , ,,/w, ,right/en,_,disp/en,_,)/w,;/w,各/r,参数/n,设置/v,如/v,bm/en,方法/n,，/w,速度/n,比较/d,快/a,，/w,320/m,*/w,240/m,的/u,灰度/n,图/n,匹配/vn,时间/n,为/p,78/m,ms/en,，/w,视差/n,效果/n,如下/v,图/n,。/w,第三/nw,种/q,为/p,gc/en,方法/n,：/w,view/en, ,plaincopy/en, ,to/en, ,clipboardprint/en,?/w,cvstereogcstate/en,*/w, ,state/en, ,=/w, ,cvcreatestereogcstate/en,(/w, ,16/m,,/w, ,2/m, ,)/w,;/w,left/en,_,disp/en,_, , ,=/w,cvcreatemat/en,(/w, ,left/en,-/w,>,height/en,,/w,left/en,-/w,>,width/en,,/w, ,cv/en,_,32/m,f/en, ,)/w,;/w,right/en,_,disp/en,_, ,=/w,cvcreatemat/en,(/w, ,right/en,-/w,>,height/en,,/w,right/en,-/w,>,width/en,,/w,cv/en,_,32/m,f/en, ,)/w,;/w,cvfindstereocorrespondencegc/en,(/w, ,left/en,,/w, ,right/en,,/w, ,left/en,_,disp/en,_,,/w, ,right/en,_,disp/en,_,,/w, ,state/en,,/w, ,0/m, ,)/w,;/w,cvreleasestereogcstate/en,(/w, ,&/w,state/en, ,)/w,;/w,该/r,方法/n,速度/n,超慢/nw,，/w,但/c,效果/n,超/v,好/a,。/w,各/r,方法/n,理论/n,可以/v,参考/v,文献/n,。/w,函数/n,解释/v,参数/n,注释/vn,（/w,1/m,）/w,stereobmstate/en,//w,//w, ,预/d,处理/v,滤波/v,参数/n,prefiltertype/en,：/w,预/d,处理/v,滤波器/n,的/u,类型/n,，/w,主要/b,是/v,用于/v,降低/v,亮度/n,失真/vn,（/w,photometric/en, ,distortions/en,）/w,、/w,消除/v,噪声/n,和/c,增强/v,纹理/n,等/u,,/w, ,有/v,两种/mq,可/v,选/v,类型/n,：/w,cv/en,_,stereo/en,_,bm/en,_,normalized/en,_,response/en,（/w,归/v,一化/nw,响应/v,）/w, ,或者/c, ,cv/en,_,stereo/en,_,bm/en,_,xsobel/en,（/w,水平/n,方向/n,sobel/en,算子/n,，/w,默认/v,类型/n,）/w,,/w, ,该/r,参数/n,为/p, ,int/en, ,型/k,；/w,prefiltersize/en,：/w,预/d,处理/v,滤波器/n,窗口/s,大小/n,，/w,容许/v,范围/n,是/v,[/w,5/m,,/w,255/m,]/w,，/w,一般/a,应该/v,在/p, ,5/m,x/en,5/m,./w,./w,21/m,x/en,21/m, ,之间/f,，/w,参数/n,必须/d,为/p,奇数/n,值/n,,/w, ,int/en, ,型/k,prefiltercap/en,：/w,预/d,处理/v,滤波器/n,的/u,截断/v,值/n,，/w,预/d,处理/v,的/u,输出/v,值/n,仅/d,保留/v,[/w,-/w,prefiltercap/en,,/w, ,prefiltercap/en,]/w,范围/n,内/f,的/u,值/n,，/w,参数/n,范围/n,：/w,1/m, ,-/w, ,31/m,（/w,文档/n,中/f,是/v,31/m,，/w,但/c,代码/n,中/f,是/v, ,63/m,）/w,,/w, ,int/en,//w,//w, ,sad/en, ,参数/n,sadwindowsize/en,：/w,sad/en,窗口/s,大小/n,，/w,容许/v,范围/n,是/v,[/w,5/m,,/w,255/m,]/w,，/w,一般/a,应该/v,在/p, ,5/m,x/en,5/m, ,至/p, ,21/m,x/en,21/m, ,之间/f,，/w,参数/n,必须/d,是/v,奇数/n,，/w,int/en, ,型/k,mindisparity/en,：/w,最/d,小/a,视差/n,，/w,默认值/nw,为/p, ,0/m,,/w, ,可以/v,是/v,负值/n,，/w,int/en, ,型/k,numberofdisparities/en,：/w,视差/n,窗口/s,，/w,即/v,最/d,大/a,视差值/nw,与/p,最/d,小视/v,差值/n,之/u,差/a,,/w, ,窗口/s,大小/n,必须/d,是/v, ,16/m, ,的/u,整/m,数/m,倍/q,，/w,int/en, ,型/k,//w,//w, ,后处理/v,参数/n,texturethreshold/en,：/w,低/a,纹理/n,区域/n,的/u,判断/v,阈值/n,。/w,如果/c,当前/t,sad/en,窗口/s,内/f,所有/b,邻居/n,像/v,素点/nr,的/u,x/en,导数/n,绝对/d,值之/nw,和/c,小于/v,指定/v,阈值/n,，/w,则/d,该/r,窗口/s,对应/v,的/u,像素/n,点/q,的/u,视差值/nw,为/p, ,0/m,（/w,that/en, ,is/en,,/w, ,if/en, ,the/en, ,sum/en, ,of/en, ,absolute/en, ,values/en, ,of/en, ,x/en,-/w,derivatives/en, ,computed/en, ,over/en, ,sadwindowsize/en, ,by/en, ,sadwindowsize/en, ,pixel/en, ,neighborhood/en, ,is/en, ,smaller/en, ,than/en, ,the/en, ,parameter/en,,/w, ,no/en, ,disparity/en, ,is/en, ,computed/en, ,at/en, ,the/en, ,pixel/en,）/w,，/w,该/r,参数/n,不/d,能/v,为/p,负值/n,，/w,int/en, ,型/k,uniquenessratio/en,：/w,视差/n,唯一性/n,百分比/n,，/w, ,视差/n,窗口/s,范围/n,内/f,最/d,低/a,代价/n,是/v,次/q,低/a,代价/n,的/u,(/w,1/m, ,+/w, ,uniquenessratio/en,//w,100/m,)/w,倍/q,时/ng,，/w,最/d,低/a,代价/n,对应/v,的/u,视差值/nw,才/d,是/v,该/r,像素/n,点/q,的/u,视差/n,，/w,否则/c,该/r,像素/n,点/q,的/u,视差/n,为/p, ,0/m, ,（/w,the/en, ,minimum/en, ,margin/en, ,in/en, ,percents/en, ,between/en, ,the/en, ,best/en, ,(/w,minimum/en,)/w, ,cost/en, ,function/en, ,value/en, ,and/en, ,the/en, ,second/en, ,best/en, ,value/en, ,to/en, ,accept/en, ,the/en, ,computed/en, ,disparity/en,,/w, ,that/en, ,is/en,,/w, ,accept/en, ,the/en, ,computed/en, ,disparity/en, ,d/en,^, ,only/en, ,if/en, ,sad/en,(/w,d/en,)/w, ,>,=/w, ,sad/en,(/w,d/en,^,)/w, ,x/en, ,(/w,1/m, ,+/w, ,uniquenessratio/en,//w,100/m,./w,)/w, ,for/en, ,any/en, ,d/en, ,!/w,=/w, ,d/en,*/w,+/w,//w,-/w,1/m, ,within/en, ,the/en, ,search/en, ,range/en, ,）/w,，/w,该/r,参数/n,不/d,能/v,为/p,负值/n,，/w,一般/a,5/m,-/w,15/m,左右/m,的/u,值/n,比较/d,合适/a,，/w,int/en, ,型/k,specklewindowsize/en,：/w,检查/vn,视差/n,连通/v,区域/n,变化度/nw,的/u,窗口/s,大小/n,,/w, ,值/n,为/p, ,0/m, ,时/ng,取消/v, ,speckle/en, ,检查/vn,，/w,int/en, ,型/k,specklerange/en,：/w,视差/n,变化/vn,阈值/n,，/w,当/p,窗口/s,内/f,视差/n,变化/vn,大于/v,阈值/n,时/ng,，/w,该/r,窗口/s,内/f,的/u,视差/n,清零/nz,，/w,int/en, ,型/k,//w,//w, ,opencv/en,2.1/m, ,新增/v,的/u,状态/n,参数/n,roi/en,1/m,,/w, ,roi/en,2/m,：/w,左右/m,视图/n,的/u,有效/a,像素/n,区域/n,，/w,一般/a,由/p,双目/n,校正/v,阶段/n,的/u, ,cvstereorectify/en, ,函数/n,传递/v,，/w,也/d,可以/v,自行/d,设定/v,。/w,一旦/d,在/p,状态/n,参数/n,中/f,设定/v,了/u, ,roi/en,1/m, ,和/c, ,roi/en,2/m,，/w,opencv/en, ,会/v,通过/p,cvgetvaliddisparityroi/en, ,函数/n,计算/v,出/v,视差图/nw,的/u,有效/a,区域/n,，/w,在/p,有效/a,区域/n,外/f,的/u,视差值/nw,将/d,被/p,清零/nz,。/w,disp/en,12/m,maxdiff/en,：/w,左/f,视差图/nw,（/w,直接/ad,计算/v,得出/v,）/w,和/c,右/f,视差图/nw,（/w,通过/p,cvvalidatedisparity/en,计算/v,得出/v,）/w,之间/f,的/u,最/d,大/a,容许/v,差异/n,。/w,超过/v,该/r,阈值/n,的/u,视差值/nw,将/d,被/p,清零/nz,。/w,该/r,参数/n,默/vd,认为/v, ,-/w,1/m,，/w,即/v,不/d,执行/v,左右/m,视差/n,检查/vn,。/w,int/en, ,型/k,。/w,注意/v,在/p,程序/n,调试/v,阶段/n,最/d,好/a,保持/v,该/r,值/n,为/p, ,-/w,1/m,，/w,以便/d,查看/v,不同/a,视差/n,窗口/s,生成/vn,的/u,视差/n,效果/n,。/w,具体/a,请/v,参见/v,《/w,使用/v,opengl/en,动态/n,显示/v,双目/n,视觉/n,三维/nz,重构/v,效果/n,示例/n,》/w,一文/mq,中/f,的/u,讨论/v,。/w,在/p,上述/b,参数/n,中/f,，/w,对/p,视差/n,生成/vn,效果/n,影响/vn,较/d,大/a,的/u,主要/b,参数/n,是/v, ,sadwindowsize/en,、/w,numberofdisparities/en, ,和/c, ,uniquenessratio/en, ,三个/m,，/w,一般/a,只/d,需/v,对/p,这/r,三个/m,参数/n,进行/v,调整/vn,，/w,其余/r,参数/n,按/p,默认/v,设置/v,即可/v,。/w,在/p,opencv/en,2.1/m,中/f,，/w,bm/en,算法/n,有/v,c/en,和/c,c/en,+/w,+/w, ,两种/mq,实现/v,模块/n,。/w,（/w,2/m,）/w,stereosgbmstatesgbm/en,算法/n,的/u,状态/n,参数/n,大部分/m,与/p,bm/en,算法/n,的/u,一致/a,，/w,下面/f,只/d,解释/v,不同/a,的/u,部分/n,：/w,sadwindowsize/en,：/w,sad/en,窗口/s,大小/n,，/w,容许/v,范围/n,是/v,[/w,1/m,,/w,11/m,]/w,，/w,一般/a,应该/v,在/p, ,3/m,x/en,3/m, ,至/p, ,11/m,x/en,11/m, ,之间/f,，/w,参数/n,必须/d,是/v,奇数/n,，/w,int/en, ,型/k,p/en,1/m,,/w, ,p/en,2/m,：/w,控制/v,视差/n,变化/vn,平滑性/nw,的/u,参数/n,。/w,p/en,1/m,、/w,p/en,2/m,的/u,值/n,越/d,大/a,，/w,视差/n,越/d,平滑/an,。/w,p/en,1/m,是/v,相邻/v,像素/n,点/q,视差/n,增/v,//w,减/v, ,1/m, ,时/ng,的/u,惩罚/vn,系数/n,；/w,p/en,2/m,是/v,相邻/v,像素/n,点/q,视差/n,变化值/nw,大于/nrf,1时/t,的/u,惩罚/vn,系数/n,。/w,p/en,2/m,必须/d,大于/v,p/en,1/m,。/w,opencv/en,2.1/m,提供/v,的/u,例程/nw, ,stereo/en,_,match/en,./w,cpp/en, ,给/p,出/v,了/u, ,p/en,1/m, ,和/c, ,p/en,2/m, ,比较/d,合适/a,的/u,数值/n,。/w,fulldp/en,：/w,布尔值/nr,，/w,当/p,设置/v,为/p, ,true/en, ,时/ng,，/w,运行/vn,双/m,通道/n,动态/n,编程/vn,算法/n,（/w,full/en,-/w,scale/en, ,2/m,-/w,pass/en, ,dynamic/en, ,programming/en, ,algorithm/en,）/w,，/w,会/v,占用/v,o/en,(/w,w/en,*/w,h/en,*/w,numdisparities/en,)/w,个/q,字节/n,，/w,对于/p,高/a,分辨率/n,图像/n,将/d,占用/v,较/d,大/a,的/u,内存/n,空间/n,。/w,一般/a,设置/v,为/p, ,false/en,。/w,注意/v,opencv/en,2.1/m,的/u,sgbm/en,算法/n,是/v,用/p,c/en,+/w,+/w, ,语言/n,编写/v,的/u,，/w,没有/v,c/en,实现/v,模块/n,。/w,与/p,h/en,./w, ,hirschmuller/en,提出/v,的/u,原/b,算法/n,相比/v,，/w,主要/b,有/v,如下/v,变化/vn,：/w,算法/n,默认/v,运行/vn,单/d,通道/n,dp/en,算法/n,，/w,只用/v,了/u,5个/m,方向/n,，/w,而/c,fulldp/en,使/v,能/v,时/ng,则/d,使用/v,8个/m,方向/n,（/w,可能/v,需要/v,占用/v,大量/m,内存/n,）/w,。/w,算法/n,在/p,计算/v,匹配/vn,代价/n,函数/n,时/ng,，/w,采用/v,块/q,匹配/vn,方法/n,而/c,非/h,像素/n,匹配/vn,（/w,不过/c,sadwindowsize/en,=/w,1时/t,就/d,等于/v,像素/n,匹配/vn,了/u,）/w,。/w,匹配/vn,代价/n,的/u,计算/v,采用/v,bt/en,算法/n,（/w,"/w,depth/en, ,discontinuities/en, ,by/en, ,pixel/en,-/w,to/en,-/w,pixel/en, ,stereo/en,"/w, ,by/en, ,s/en,./w, ,birchfield/en, ,and/en, ,c/en,./w, ,tomasi/en,）/w,，/w,并/c,没有/v,实现/v,基于/p,互熵/nw,信息/n,的/u,匹配/vn,代价/n,计算/v,。/w,增加/v,了/u,一些/m,bm/en,算法/n,中/f,的/u,预/d,处理/v,和/c,后处理/v,程序/n,。/w,（/w,3/m,）/w,stereogcstategc/en,算法/n,的/u,状态/n,参数/n,只/d,有/v,两个/m,：/w,numberofdisparities/en, ,和/c, ,maxiters/en, ,，/w,并且/c,只能/v,通过/p, ,cvcreatestereogcstate/en, ,在/p,创建/v,算法/n,状态/n,结构体/nw,时/ng,一次性/d,确定/v,，/w,不能/v,在/p,循环/vn,中/f,更新/v,状态/n,信息/n,。/w,gc/en,算法/n,并/c,不/d,是/v,一种/mq,实时/n,算法/n,，/w,但/c,可以/v,得到/v,物体/n,轮廓/n,清晰/a,准确/a,的/u,视差图/nw,，/w,适用/v,于/p,静态/n,环境/n,物体/n,的/u,深度/n,重构/v,。/w,注意/v,gc/en,算法/n,只能/v,在/p,c/en,语言/n,模式/n,下/f,运行/vn,，/w,并且/c,不/d,能/v,对/p,视差图/nw,进行/v,预先/d,的/u,边界/n,延拓/nw,，/w,左右/m,视图/n,和/c,左右/m,视差/n,矩阵/n,的/u,大小/n,必须/d,一致/a,。/w,原理/n,解释/v,目前/t,立体/b,匹配/vn,算法/n,是/v,计算机/n,视觉/n,中/f,的/u,一个/m,难点/n,和/c,热点/n,，/w,算法/n,很/d,多/a,，/w,但是/c,一般/a,的/u,步骤/n,是/v,：/w,a/en,、/w,匹配/vn,代价/n,计算/v,匹配/vn,代价/n,计算/v,是/v,整个/b,立体/b,匹配/vn,算法/n,的/u,基础/n,，/w,实际/n,是/v,对/p,不同/a,视差/n,下/f,进行/v,灰度/n,相似性/n,测量/vn,。/w,常见/a,的/u,方法/n,有/v,灰度/n,差/a,的/u,平方/q,sd/en,（/w,squared/en, ,intensity/en, ,differences/en,）/w,，/w,灰度/n,差/a,的/u,绝对值/n,ad/en,（/w,absolute/en, ,intensity/en, ,differences/en,）/w,等/u,。/w,另外/c,，/w,在/p,求/v,原始/a,匹配/vn,代价/n,时/ng,可以/v,设定/v,一个/m,上限/n,值/n,，/w,来/v,减弱/v,叠加/vn,过程/n,中/f,的/u,误/v,匹配/vn,的/u,影响/vn,。/w,以/p,ad/en,法求/nw,匹配/vn,代价/n,为/p,例/n,，/w,可用/v,下式/nw,进行/v,计算/v,，/w,其中/r,t/en,为/p,设定/v,的/u,阈值/n,。/w,这/r,就是/d,在/p,参数/n,设置/v,中/f,阈值/n,的/u,作用/n,，/w,在/p,视差图/nw,中/f,经常/d,有/v,黑色/n,区域/n,，/w,就/d,是/v,和/c,阈值/n,的/u,设置/v,关/v,。/w,b/en,、/w, ,匹配/vn,代价/n,叠加/vn,一般来说/l,，/w,全局/n,算法/n,基于/p,原始/a,匹配/vn,代价/n,进行/v,后续/vn,算法/n,计算/v,。/w,而/c,区域/n,算/v,法则/n,需要/v,通过/p,窗口/s,叠加/vn,来/v,增强/v,匹配/vn,代价/n,的/u,可靠性/n,，/w,根据/p,原始/a,匹配/vn,代价/n,不同/a,，/w,可/v,分为/v,：/w,此/r,图/n,是/v,核心/n,算法/n,的/u,解释/v,，/w,就/d,是/v,计算/v,区域/n,内/f,像素/n,差值/n,，/w,可以/v,为/p,单个/b,像素/n,也/d,可以/v,为/p,一定/d,区域/n,内/f,，/w,主要/b,看/v,sad/en,的/u,窗口/s,大小/n,的/u,设置/v,，/w,同时/c,sad/en,设置/v,决定/v,误/v,匹配/vn,的/u,多少/r,和/c,运算/vn,效率/n,问题/n,，/w,所以/c,大小/n,设置/v,一定/d,要/v,很/d,慎重/a,。/w,c/en,、/w, ,视差/n,获取/v,对于/p,区域/n,算法/n,来说/u,，/w,在/p,完成/v,匹配/vn,代价/n,的/u,叠加/vn,以后/f,，/w,视差/n,的/u,获取/v,就/d,很/d,容易/a,了/u,，/w,只/d,需/v,在/p,一定/d,范围/n,内/f,选取/v,叠加/vn,匹配/vn,代价/n,最/d,优/ag,的/u,点/q,（/w,sad/en,和/c,ssd/en,取/v,最小值/nz,，/w,ncc/en,取/v,最大值/nz,）/w,作为/v,对应/v,匹配/vn,点/q,，/w,如/v,胜者/n,为/p,王算法/nr,wta/en,（/w,winner/en,-/w,take/en,-/w,all/en,）/w,。/w,而/c,全局/n,算/v,法则/n,直接/ad,对/p,原始/a,匹配/vn,代价/n,进行/v,处理/v,，/w,一般/a,会/v,先/d,给/p,出/v,一个/m,能量/n,评价/v,函数/n,，/w,然后/c,通过/p,不同/a,的/u,优化/v,算法/n,来/v,求得/v,能量/n,的/u,最小值/nz,，/w,同时/c,每个/r,点/q,的/u,视差值/nw,也/d,就/d,计算/v,出来/v,了/u,。/w,d/en,、/w,视差/n,细化/v,（/w,亚像/nw,素级/nr,）/w,大多数/m,立体/b,匹配/vn,算法/n,计算/v,出来/v,的/u,视差/n,都/d,是/v,一些/m,离散/vn,的/u,特定/b,整/m,数值/n,，/w,可/v,满足/v,一般/a,应用/vn,的/u,精度/n,要求/v,。/w,但/c,在/p,一些/m,精度/n,要求/v,比较/d,高/a,的/u,场合/n,，/w,如/v,精确/a,的/u,三维/nz,重构/v,中/f,，/w,就/d,需要/v,在/p,初始/b,视差/n,获取/v,后/f,采用/v,一些/m,措施/n,对视/vn,差/a,进行/v,细化/v,，/w,如/v,匹配/vn,代价/n,的/u,曲线/n,拟合/nz,、/w,图像/n,滤波/v,、/w,图像/n,分割/v,等/u,。/w,亚/j,像素/n,级/q,的/u,处理/v,就是/d,涉及/v,到/v,bmstate/en,参数/n,设置/v,后/f,后续/vn,参数/n,的/u,设置/v,了/u,。/w,有关/vn,立体/b,匹配/vn,的/u,介绍/v,和/c,常见/a,匹配/vn,算法/n,的/u,比较/d,，/w,推荐/v,大家/r,看看/v,stefano/en, ,mattoccia/en, ,的/u,讲义/n, ,stereo/en, ,vision/en,:/w, ,algorithms/en, ,and/en, ,applications/en,，/w,190页/mq,的/u,ppt/en,，/w,讲解/v,得/u,非常/d,形象/n,详尽/a,。/w,1/m,．/w, ,opencv/en,2.1/m,和/c,opencv/en,2.0/m,在/p,做/v,stereo/en, ,vision/en,方面/n,有/v,什么/r,区别/n,了/u,？/w,2.1版/mq,增强/v,了/u,stereo/en, ,vision/en,方面/n,的/u,功能/n,：/w,(/w,1/m,)/w, ,新增/v,了/u, ,sgbm/en, ,立体/b,匹配/vn,算法/n,（/w,源自/v,heiko/en, ,hirschmuller/en,的/u,《/w,stereo/en, ,processing/en, ,by/en, ,semi/en,-/w,global/en, ,matching/en, ,and/en, ,mutual/en, ,information/en,》/w,）/w,，/w,可以/v,获得/v,比/p, ,bm/en, ,算法/n,物体/n,轮廓/n,更/d,清晰/a,的/u,视差图/nw,（/w,但/c,低/a,纹理/n,区域/n,容易/a,出现/v,横/v,//w,斜纹路/ns,，/w,在/p, ,gcstate/en,-/w,>,fulldp/en, ,选项/v,使/v,能/v,时/ng,可/v,消减/nz,这种/r,异常/a,纹路/n,，/w,但/c,对应/v,区域/n,视差/n,变为/v,0/m,，/w,且/c,运行/vn,速度/n,会/v,有所/v,下降/v,）/w,，/w,速度/n,比/p, ,bm/en, ,稍慢/nz,，/w, ,352/m,*/w,288/m,的/u,帧/q,处理/v,速度/n,大约/d,是/v, ,5/m, ,帧/q,//w,秒/q,；/w,(/w,2/m,)/w, ,视差/n,效果/n,：/w,bm/en, ,</w, ,sgbm/en, ,</w, ,gc/en,；/w,处理/v,速度/n,：/w,bm/en, ,>, ,sgbm/en, ,>, ,gc/en, ,；/w,(/w,3/m,)/w, ,bm/en, ,算法/n,比/p,2.0版/mq,性能/n,有所/v,提升/v,，/w,其/r,状态/n,参数/n,新增/v,了/u,对/p,左右/m,视图/n,感/vg,兴趣/n,区域/n, ,roi/en, ,的/u,支持/v,（/w,roi/en,1/m, ,和/c, ,roi/en,2/m,，/w,由/p,stereorectify/en,函数/n,产生/v,）/w,；/w,(/w,4/m,)/w, ,bm/en, ,算法/n,和/c, ,gc/en, ,算法/n,的/u,核心/n,代码/n,改动/v,不/d,大/a,，/w,主要/b,是/v,面向/v,多线程/nz,运算/vn,方面/n,的/u,（/w,由/p, ,openmp/en, ,转/v,向/p, ,intel/en, ,tbb/en,）/w,；/w,(/w,5/m,)/w, ,cvfindstereocorrespondencebm/en, ,函数/n,的/u,disparity/en,参数/n,的/u,数据/n,格式/n,新增/v,了/u, ,cv/en,_,32/m,f/en, ,的/u,支持/v,，/w,这种/r,格式/n,的/u,数据/n,给/p,出/v,实际/n,视差/n,，/w,而/c, ,2.0/m, ,版/n,只/d,支持/v, ,cv/en,_,16/m,s/en,，/w,需要/v,除/p,以/p, ,16.0/m, ,才/d,能/v,得到/v,实际/n,的/u,视差/n,数值/n,。/w,2/m,．/w, ,用于/v,立体/b,匹配/vn,的/u,图像/n,可以/v,是/v,彩色/b,的/u,吗/y,？/w,在/p,opencv/en,2.1/m,中/f,，/w,bm/en,和/c,gc/en,算法/n,只能/v,对/p,8位/mq,灰度/n,图像/n,计算/v,视差/n,，/w,sgbm/en,算/v,法则/n,可以/v,处理/v,24位/mq,（/w,8/m,bits/en,*/w,3/m,）/w,彩色/b,图像/n,。/w,所以/c,在/p,读/v,入/v,图像/n,时/ng,，/w,应该/v,根据/p,采用/v,的/u,算法/n,来/v,处理/v,图像/n,：/w,int/en, ,color/en,_,mode/en, ,=/w, ,alg/en, ,=/w,=/w, ,stereo/en,_,sgbm/en, ,?/w, ,1/m, ,:/w, ,0/m,;/w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w, ,载入/v,图像/n,cvgrabframe/en,(/w, ,lfcam/en, ,)/w,;/w,cvgrabframe/en,(/w, ,ricam/en, ,)/w,;/w,frame/en,1/m, ,=/w, ,cvretrieveframe/en,(/w, ,lfcam/en, ,)/w,;/w,frame/en,2/m, ,=/w, ,cvretrieveframe/en,(/w, ,ricam/en, ,)/w,;/w,if/en,(/w,frame/en,1/m,./w,empty/en,(/w,)/w,)/w, ,break/en,;/w,resize/en,(/w,frame/en,1/m,,/w, ,img/en,1/m,,/w, ,img/en,_,size/en,,/w, ,0/m,,/w, ,0/m,)/w,;/w,resize/en,(/w,frame/en,2/m,,/w, ,img/en,2/m,,/w, ,img/en,_,size/en,,/w, ,0/m,,/w, ,0/m,)/w,;/w,//w,//w, ,选择/v,彩色/b,或/c,灰度/n,格式/n,作为/v,双目/n,匹配/vn,的/u,处理/v,图像/n,if/en, ,(/w,!/w,color/en,_,mode/en, ,&/w,&/w, ,cn/en,>,1/m,)/w,{/w,cvtcolor/en,(/w,img/en,1/m,,/w, ,img/en,1/m,gray/en,,/w, ,cv/en,_,bgr/en,2/m,gray/en,)/w,;/w,cvtcolor/en,(/w,img/en,2/m,,/w, ,img/en,2/m,gray/en,,/w, ,cv/en,_,bgr/en,2/m,gray/en,)/w,;/w,img/en,1/m,p/en, ,=/w, ,img/en,1/m,gray/en,;/w,img/en,2/m,p/en, ,=/w, ,img/en,2/m,gray/en,;/w,}/w,else/en,{/w,img/en,1/m,p/en, ,=/w, ,img/en,1/m,;/w,img/en,2/m,p/en, ,=/w, ,img/en,2/m,;/w,}/w,3/m,．/w, ,怎样/r,获取/v,与/p,原/b,图像/n,有效/a,像素/n,区域/n,相同/a,的/u,视差图/nw,？/w,在/p,opencv/en,2.0/m,及/c,以前/f,的/u,版本/n,中/f,，/w,所/u,获取/v,的/u,视差图/nw,总是/d,在/p,左侧/f,和/c,右侧/f,有/v,明显/a,的/u,黑色/n,区域/n,，/w,这些/r,区域/n,没有/v,有效/a,的/u,视差/n,数据/n,。/w,视差图/nw,有效/a,像素/n,区域/n,与/p,视差/n,窗口/s,（/w,ndisp/en,，/w,一般/a,取/v,正值/v,且/c,能/v,被/p,16/m,整/m,除/p,）/w,和/c,最/d,小视/v,差值/n,（/w,mindisp/en,，/w,一般/a,取/v,0/m,或/c,负值/n,）/w,相关/v,，/w,视差/n,窗口/s,越/d,大/a,，/w,视差图/nw,左侧/f,的/u,黑色/n,区域/n,越/d,大/a,，/w,最/d,小视/v,差值/n,越/d,小/a,，/w,视差图/nw,右侧/f,的/u,黑色/n,区域/n,越/d,大/a,。/w,其/r,原因/n,是/v,为了/p,保证/v,参考/v,图像/n,（/w,一般/a,是/v,左视图/nw,）/w,的/u,像素/n,点/q,能/v,在/p,目标/n,图像/n,（/w,右视图/nw,）/w,中/f,按照/p,设定/v,的/u,视差/n,匹配/vn,窗口/s,匹配/vn,对应点/nz,，/w,opencv/en, ,只/d,从/p,参考/v,图像/n,的/u,第/m, ,(/w,ndisp/en, ,-/w, ,1/m, ,+/w, ,mindisp/en,)/w, ,列/v,开始/v,向/p,右/f,计算/v,视差/n,，/w,第/m, ,0/m, ,列/v,到/v,第/m, ,(/w,ndisp/en, ,-/w, ,1/m, ,+/w, ,mindisp/en,)/w, ,列/v,的/u,区域/n,视差/n,统一/vn,设置/v,为/p, ,(/w,mindisp/en, ,-/w, ,1/m,)/w, ,*/w,16/m,；/w,视差/n,计算/v,到/v,第/m, ,width/en, ,+/w, ,mindisp/en, ,列/v,时/ng,停止/v,，/w,余下/v,的/u,右侧/f,区域/n,视差值/nw,也/d,统一/vn,设置/v,为/p, ,(/w,mindisp/en, ,-/w, ,1/m,)/w, ,*/w,16/m,。/w,static/en, ,const/en, ,int/en, ,disparity/en,_,shift/en, ,=/w, ,4/m,;/w, ,…/w, ,int/en, ,ndisp/en, ,=/w, ,state/en,-/w,>,numberofdisparities/en,;/w, ,int/en, ,mindisp/en, ,=/w, ,state/en,-/w,>,mindisparity/en,;/w, ,int/en, ,lofs/en, ,=/w, ,max/en,(/w,ndisp/en, ,-/w, ,1/m, ,+/w, ,mindisp/en,,/w, ,0/m,)/w,;/w, ,int/en, ,rofs/en, ,=/w, ,-/w,min/en,(/w,ndisp/en, ,-/w, ,1/m, ,+/w, ,mindisp/en,,/w, ,0/m,)/w,;/w, ,int/en, ,width/en, ,=/w, ,left/en,-/w,>,cols/en,,/w, ,height/en, ,=/w, ,left/en,-/w,>,rows/en,;/w, ,int/en, ,width/en,1/m, ,=/w, ,width/en, ,-/w, ,rofs/en, ,-/w, ,ndisp/en, ,+/w, ,1/m,;/w, ,short/en, ,filtered/en, ,=/w, ,(/w,short/en,)/w,(/w,(/w,mindisp/en, ,-/w, ,1/m,)/w, ,</w,</w, ,disparity/en,_,shift/en,)/w,;/w, ,initialize/en, ,the/en, ,left/en, ,and/en, ,right/en, ,borders/en, ,of/en, ,the/en, ,disparity/en, ,map/en, ,for/en,(/w, ,y/en, ,=/w, ,0/m,;/w, ,y/en, ,</w, ,height/en,;/w, ,y/en,+/w,+/w, ,)/w, ,{/w, ,for/en,(/w, ,x/en, ,=/w, ,0/m,;/w, ,x/en, ,</w, ,lofs/en,;/w, ,x/en,+/w,+/w, ,)/w, ,dptr/en,[/w,y/en,*/w,dstep/en, ,+/w, ,x/en,]/w, ,=/w, ,filtered/en,;/w, ,for/en,(/w, ,x/en, ,=/w, ,lofs/en, ,+/w, ,width/en,1/m,;/w, ,x/en, ,</w, ,width/en,;/w, ,x/en,+/w,+/w, ,)/w, ,dptr/en,[/w,y/en,*/w,dstep/en, ,+/w, ,x/en,]/w, ,=/w, ,filtered/en,;/w, ,}/w, ,dptr/en, ,+/w,=/w, ,lofs/en,;/w, ,for/en,(/w, ,x/en, ,=/w, ,0/m,;/w, ,x/en, ,</w, ,width/en,1/m,;/w, ,x/en,+/w,+/w,,/w, ,dptr/en,+/w,+/w, ,)/w,这样/r,的/u,设置/v,很/d,明显/a,是/v,不/d,符合/v,实际/n,应用/vn,的/u,需求/n,的/u,，/w,它/r,相当/d,于/p,把/p,摄像头/n,的/u,视场/nw,范围/n,缩窄/nw,了/u,。/w,因此/c,，/w,opencv/en,2.1/m, ,做/v,了/u,明显/a,的/u,改进/v,，/w,不再/d,要求/v,左右/m,视图/n,和/c,视差图/nw,的/u,大小/n,（/w,size/en,）/w,一致/a,，/w,允许/v,对/p,视差图/nw,进行/v,左右/m,边界/n,延拓/nw,，/w,这样/r,，/w,虽然/c,计算/v,视差/n,时/ng,还是/c,按/p,上面/f,的/u,代码/n,思路/n,来/v,处理/v,左右/m,边界/n,，/w,但是/c,视差图/nw,的/u,边界/n,得到/v,延拓/nw,后/f,，/w,有效/a,视差/n,的/u,范围/n,就/d,能够/v,与/p,对应/v,视图/n,完全/ad,对应/v,。/w,具体/a,的/u,实现/v,代码/n,范例/n,如下/v,：/w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w, ,//w,//w, ,对/p,左右/m,视图/n,的/u,左边/f,进行/v,边界/n,延拓/nw,，/w,以/p,获取/v,与/p,原始/a,视图/n,相同/a,大小/n,的/u,有效/a,视差/n,区域/n, ,copymakeborder/en,(/w,img/en,1/m,r/en,,/w, ,img/en,1/m,b/en,,/w, ,0/m,,/w, ,0/m,,/w, ,m/en,_,nmaxdisp/en,,/w, ,0/m,,/w, ,ipl/en,_,border/en,_,replicate/en,)/w,;/w, ,copymakeborder/en,(/w,img/en,2/m,r/en,,/w, ,img/en,2/m,b/en,,/w, ,0/m,,/w, ,0/m,,/w, ,m/en,_,nmaxdisp/en,,/w, ,0/m,,/w, ,ipl/en,_,border/en,_,replicate/en,)/w,;/w, ,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w,//w, ,//w,//w, ,计算/v,视差/n, ,if/en,(/w, ,alg/en, ,=/w,=/w, ,stereo/en,_,bm/en, ,)/w, ,{/w, ,bm/en,(/w,img/en,1/m,b/en,,/w, ,img/en,2/m,b/en,,/w, ,dispb/en,)/w,;/w, ,//w,//w, ,截取/v,与/p,原始/a,画面/n,对应/v,的/u,视差/n,区域/n,（/w,舍/v,去/v,加宽/vn,的/u,部分/n,）/w, ,displf/en, ,=/w, ,dispb/en,./w,colrange/en,(/w,m/en,_,nmaxdisp/en,,/w, ,img/en,1/m,b/en,./w,cols/en,)/w,;/w, ,}/w, ,else/en, ,if/en,(/w,alg/en, ,=/w,=/w, ,stereo/en,_,sgbm/en,)/w, ,{/w, ,sgbm/en,(/w,img/en,1/m,b/en,,/w, ,img/en,2/m,b/en,,/w, ,dispb/en,)/w,;/w, ,displf/en, ,=/w, ,dispb/en,./w,colrange/en,(/w,m/en,_,nmaxdisp/en,,/w, ,img/en,1/m,b/en,./w,cols/en,)/w,;/w, ,}/w,4/m,．/w, ,cvfindstereocorrespondencebm/en,的/u,输出/v,结果/n,好像/v,不/d,是/v,以/p,像素/n,点/q,为/p,单位/n,的/u,视差/n,？/w,“/w,@/w,scyscyao/en,：/w,在/p,opencv/en,2.0/m,中/f,，/w,bm/en,函数/n,得出/v,的/u,结果/n,是/v,以/p,16位/mq,符号/n,数/m,的/u,形式/n,的/u,存储/vn,的/u,，/w,出于/v,精度/n,需要/v,，/w,所有/b,的/u,视差/n,在/p,输出/v,时/ng,都/d,扩大/v,了/u,16倍/mq,(/w,2/m,^,4/m,)/w,。/w,其/r,具体/a,代码/n,表示/v,如下/v,：/w,dptr/en,[/w,y/en,*/w,dstep/en,]/w, ,=/w, ,(/w,short/en,)/w,(/w,(/w,(/w,ndisp/en, ,-/w, ,mind/en, ,-/w, ,1/m, ,+/w, ,mindisp/en,)/w,*/w,256/m, ,+/w, ,(/w,d/en, ,!/w,=/w, ,0/m, ,?/w, ,(/w,p/en,-/w,n/en,)/w,*/w,128/m,//w,d/en, ,:/w, ,0/m,)/w, ,+/w, ,15/m,)/w, ,>,>, ,4/m,)/w,;/w,可以/v,看到/v,，/w,原始/a,视差/n,在/p,左移/nw,8位/mq,(/w,256/m,)/w,并且/c,加上/v,一个/m,修正值/nw,之后/f,又/d,右/f,移/v,了/u,4位/mq,，/w,最终/d,的/u,结果/n,就/d,是/v,左移/nw,4位/mq,。/w,因此/c,，/w,在/p,实际/n,求/v,距离/n,时/ng,，/w,cvreprojectto/en,3/m,d/en,出来/v,的/u,x/en,//w,w/en,,/w,y/en,//w,w/en,,/w,z/en,//w,w/en,都/d,要/v,乘/v,以/p,16/m, ,(/w,也/d,就/d,是/v,w/en,除/p,以/p,16/m,)/w,，/w,才/d,能/v,得到/v,正确/a,的/u,三维/nz,坐标/n,信息/n,。/w,”/w,在/p,opencv/en,2.1/m,中/f,，/w,bm/en,算法/n,可以/v,用/p, ,cv/en,_,16/m,s/en, ,或者/c, ,cv/en,_,32/m,f/en, ,的/u,方式/n,输出/v,视差/n,数据/n,，/w,使用/v,32位/mq,float/en,格式/n,可以/v,得到/v,真实/a,的/u,视差值/nw,，/w,而/c,cv/en,_,16/m,s/en, ,格式/n,得到/v,的/u,视差/n,矩阵/n,则/d,需要/v, ,除以/v,16/m, ,才/d,能/v,得到/v,正确/a,的/u,视差/n,。/w,另外/c,，/w,opencv/en,2.1/m,另外/c,两种/mq,立体/b,匹配/vn,算法/n, ,sgbm/en, ,和/c, ,gc/en, ,只/d,支持/v, ,cv/en,_,16/m,s/en, ,格式/n,的/u, ,disparity/en, ,矩阵/n,。/w,5/m,．/w, ,如何/r,设置/v,bm/en,、/w,sgbm/en,和/c,gc/en,算法/n,的/u,状态/n,参数/n,？/w,6/m,．/w, ,如何/r,实现/v,视差图/nw,的/u,伪/j,彩色/b,显示/v,？/w,首先/d,要/v,将/d,16位/mq,符号/n,整形/v,的/u,视差/n,矩阵/n,转换/v,为/p,8位/mq,无/v,符号/n,整形/v,矩阵/n,，/w,然后/c,按照/p,一定/d,的/u,变换/v,关系/n,进行/v,伪/j,彩色/b,处理/v,。/w,我的/nt,实现/v,代码/n,如下/v,：/w,//w,//w, ,转换/v,为/p, ,cv/en,_,8/m,u/en, ,格式/n,，/w,彩色/b,显示/v, ,displfcv/en, ,=/w, ,displf/en,,/w, ,dispricv/en, ,=/w, ,dispri/en,,/w, ,disp/en,8/m,cv/en, ,=/w, ,disp/en,8/m,;/w, ,if/en, ,(/w,alg/en, ,=/w,=/w, ,stereo/en,_,gc/en,)/w, ,{/w, ,cvnormalize/en,(/w, ,&/w,displfcv/en,,/w, ,&/w,disp/en,8/m,cv/en,,/w, ,0/m,,/w, ,256/m,,/w, ,cv/en,_,minmax/en, ,)/w,;/w, ,}/w, ,else/en, ,{/w, ,displf/en,./w,convertto/en,(/w,disp/en,8/m,,/w, ,cv/en,_,8/m,u/en,,/w, ,255/m,//w,(/w,m/en,_,nmaxdisp/en,*/w,16/m,./w,)/w,)/w,;/w, ,}/w, ,f/en,_,gray/en,2/m,color/en,(/w,&/w,disp/en,8/m,cv/en,,/w, ,vdisprgb/en,)/w,;/w,灰度/n,图/n,转/v,伪/j,彩色/b,图/n,的/u,代码/n,，/w,主要/b,功能/n,是/v,使/v,灰度/n,图/n,中/f, ,亮度/n,越/d,高/a,的/u,像素/n,点/q,，/w,在/p,伪/j,彩色/b,图/n,中/f,对应/v,的/u,点越/nw,趋向于/n, ,红色/n,；/w,亮度/n,越/d,低/a,，/w,则/d,对应/v,的/u,伪/j,彩色/b,越/d,趋向于/n, ,蓝色/n,；/w,总体/n,上/f,按照/p,灰度/n,值/n,高低/n,，/w,由/p,红渐/nw,变/v,至/p,蓝/a,，/w,中间/f,色/ng,为/p,绿色/n,。/w,其/r,对应/v,关系/n,如下/v,图/n,所/u,示/vg,：/w,void/en, ,f/en,_,gray/en,2/m,color/en,(/w,cvmat/en,*/w, ,gray/en,_,mat/en,,/w, ,cvmat/en,*/w, ,color/en,_,mat/en,)/w, ,{/w, ,if/en,(/w,color/en,_,mat/en,)/w, ,cvzero/en,(/w,color/en,_,mat/en,)/w,;/w, ,int/en, ,stype/en, ,=/w, ,cv/en,_,mat/en,_,type/en,(/w,gray/en,_,mat/en,-/w,>,type/en,)/w,,/w, ,dtype/en, ,=/w, ,cv/en,_,mat/en,_,type/en,(/w,color/en,_,mat/en,-/w,>,type/en,)/w,;/w, ,int/en, ,rows/en, ,=/w, ,gray/en,_,mat/en,-/w,>,rows/en,,/w, ,cols/en, ,=/w, ,gray/en,_,mat/en,-/w,>,cols/en,;/w, ,//w,//w, ,判断/v,输入/v,的/u,灰度/n,图/n,和/c,输出/v,的/u,伪/j,彩色/b,图/n,是否/v,大小/n,相同/a,、/w,格式/n,是否/v,符合/v,要求/v, ,if/en, ,(/w,cv/en,_,are/en,_,sizes/en,_,eq/en,(/w,gray/en,_,mat/en,,/w, ,color/en,_,mat/en,)/w, ,&/w,&/w, ,stype/en, ,=/w,=/w, ,cv/en,_,8/m,uc/en,1/m, ,&/w,&/w, ,dtype/en, ,=/w,=/w, ,cv/en,_,8/m,uc/en,3/m,)/w, ,{/w, ,cvmat/en,*/w, ,red/en, ,=/w, ,cvcreatemat/en,(/w,gray/en,_,mat/en,-/w,>,rows/en,,/w, ,gray/en,_,mat/en,-/w,>,cols/en,,/w, ,cv/en,_,8/m,u/en,)/w,;/w, ,cvmat/en,*/w, ,green/en, ,=/w, ,cvcreatemat/en,(/w,gray/en,_,mat/en,-/w,>,rows/en,,/w, ,gray/en,_,mat/en,-/w,>,cols/en,,/w, ,cv/en,_,8/m,u/en,)/w,;/w, ,cvmat/en,*/w, ,blue/en, ,=/w, ,cvcreatemat/en,(/w,gray/en,_,mat/en,-/w,>,rows/en,,/w, ,gray/en,_,mat/en,-/w,>,cols/en,,/w, ,cv/en,_,8/m,u/en,)/w,;/w, ,cvmat/en,*/w, ,mask/en, ,=/w, ,cvcreatemat/en,(/w,gray/en,_,mat/en,-/w,>,rows/en,,/w, ,gray/en,_,mat/en,-/w,>,cols/en,,/w, ,cv/en,_,8/m,u/en,)/w,;/w, ,//w,//w, ,计算/v,各/r,彩色/b,通道/n,的/u,像/v,素值/nr, ,cvsubrs/en,(/w,gray/en,_,mat/en,,/w, ,cvscalar/en,(/w,255/m,)/w,,/w, ,blue/en,)/w,;/w, ,//w,//w, ,blue/en,(/w,i/en,)/w, ,=/w, ,255/m, ,-/w, ,gray/en,(/w,i/en,)/w, ,cvcopy/en,(/w,gray/en,_,mat/en,,/w, ,red/en,)/w,;/w, ,//w,//w, ,red/en,(/w,i/en,)/w, ,=/w, ,gray/en,(/w,i/en,)/w, ,cvcopy/en,(/w,gray/en,_,mat/en,,/w, ,green/en,)/w,;/w, ,//w,//w, ,green/en,(/w,i/en,)/w, ,=/w, ,gray/en,(/w,i/en,)/w,,/w,if/en, ,gray/en,(/w,i/en,)/w, ,</w, ,128/m, ,cvcmps/en,(/w,green/en,,/w, ,128/m,,/w, ,mask/en,,/w, ,cv/en,_,cmp/en,_,ge/en, ,)/w,;/w, ,//w,//w, ,green/en,(/w,i/en,)/w, ,=/w, ,255/m, ,-/w, ,gray/en,(/w,i/en,)/w,,/w, ,if/en, ,gray/en,(/w,i/en,)/w, ,>,=/w, ,128/m, ,cvsubrs/en,(/w,green/en,,/w, ,cvscalar/en,(/w,255/m,)/w,,/w, ,green/en,,/w, ,mask/en,)/w,;/w, ,cvconvertscale/en,(/w,green/en,,/w, ,green/en,,/w, ,2.0/m,,/w, ,0.0/m,)/w,;/w, ,//w,//w, ,合成/v,伪/j,彩色/b,图/n, ,cvmerge/en,(/w,blue/en,,/w, ,green/en,,/w, ,red/en,,/w, ,null/en,,/w, ,color/en,_,mat/en,)/w,;/w, ,cvreleasemat/en,(/w, ,&/w,red/en, ,)/w,;/w, ,cvreleasemat/en,(/w, ,&/w,green/en, ,)/w,;/w, ,cvreleasemat/en,(/w, ,&/w,blue/en, ,)/w,;/w, ,cvreleasemat/en,(/w, ,&/w,mask/en, ,)/w,;/w, ,}/w, ,}/w,7/m,．/w, ,如何/r,将/d,视差/n,数据/n,保存/v,为/p, ,txt/en, ,数据/n,文件/n,以便/d,在/p, ,matlab/en, ,中/f,读取/v,分析/vn,？/w,由于/c,opencv/en,本身/r,只/d,支持/v, ,xml/en,、/w,yml/en, ,的/u,数据/n,文件/n,读/v,写/v,功能/n,，/w,并且/c,其/r,xml/en,文件/n,与/p,构建/v,网页/n,数据/n,所/u,用/p,的/u,xml/en,文件/n,格式/n,不/d,一致/a,，/w,在/p,matlab/en,中/f,无法/v,读取/v,。/w,我们/r,可以/v,通过/p,以下/f,方式/n,将/d,视差/n,数据/n,保存/v,为/p,txt/en,文件/n,，/w,再/d,导入/v,到/v,matlab/en,中/f,。/w,void/en, ,savedisp/en,(/w,const/en, ,char/en,*/w, ,filename/en,,/w, ,const/en, ,mat/en,&/w, ,mat/en,)/w, ,{/w, ,file/en,*/w, ,fp/en, ,=/w, ,fopen/en,(/w,filename/en,,/w, ,"/w,wt/en,"/w,)/w,;/w, ,fprintf/en,(/w,fp/en,,/w, ,"/w,%/w,02/m,d/en,//w,n/en,"/w,,/w, ,mat/en,./w,rows/en,)/w,;/w, ,fprintf/en,(/w,fp/en,,/w, ,"/w,%/w,02/m,d/en,//w,n/en,"/w,,/w, ,mat/en,./w,cols/en,)/w,;/w, ,for/en,(/w,int/en, ,y/en, ,=/w, ,0/m,;/w, ,y/en, ,</w, ,mat/en,./w,rows/en,;/w, ,y/en,+/w,+/w,)/w, ,{/w, ,for/en,(/w,int/en, ,x/en, ,=/w, ,0/m,;/w, ,x/en, ,</w, ,mat/en,./w,cols/en,;/w, ,x/en,+/w,+/w,)/w, ,{/w, ,short/en, ,disp/en, ,=/w, ,mat/en,./w,at/en,</w,short/en,>,(/w,y/en,,/w, ,x/en,)/w,;/w, ,//w,//w, ,这里/r,视差/n,矩阵/n,是/v,cv/en,_,16/m,s/en, ,格式/n,的/u,，/w,故/c,用/p, ,short/en, ,类型/n,读/v,取/v, ,fprintf/en,(/w,fp/en,,/w, ,"/w,%/w,d/en,//w,n/en,"/w,,/w, ,disp/en,)/w,;/w, ,//w,//w, ,若/c,视差/n,矩阵/n,是/v, ,cv/en,_,32/m,f/en, ,格式/n,，/w,则/d,用/p, ,float/en, ,类型/n,读/v,取/v, ,}/w, ,}/w, ,fclose/en,(/w,fp/en,)/w,;/w, ,}/w,相应/v,的/u,matlab/en,代码/n,为/p,：/w,function/en, ,img/en, ,=/w, ,txt/en,2/m,img/en,(/w,filename/en,)/w, ,data/en, ,=/w, ,importdata/en,(/w,filename/en,)/w,;/w, ,r/en, ,=/w, ,data/en,(/w,1/m,)/w,;/w, ,%/w, ,行数/n, ,c/en, ,=/w, ,data/en,(/w,2/m,)/w,;/w, ,%/w, ,列/v,数/m, ,disp/en, ,=/w, ,data/en,(/w,3/m,:/w,end/en,)/w,;/w, ,%/w, ,视差/n, ,vmin/en, ,=/w, ,min/en,(/w,disp/en,)/w,;/w, ,vmax/en, ,=/w, ,max/en,(/w,disp/en,)/w,;/w, ,disp/en, ,=/w, ,reshape/en,(/w,disp/en,,/w, ,[/w,c/en,,/w,r/en,]/w,)/w,'/w,;/w, ,%/w, ,将/d,列/v,向/p,量/n,形式/n,的/u, ,disp/en, ,重构/v,为/p, ,矩阵/n,形式/n, ,%/w, ,opencv/en, ,是/v,行/v,扫描/v,存储/vn,图像/n,，/w,matlab/en, ,是/v,列/v,扫描/v,存储/vn,图像/n, ,%/w, ,故/c,对/p, ,disp/en, ,的/u,重新/d,排列/v,是/v,首先/d,变成/v, ,c/en, ,行/v, ,r/en, ,列/v,的/u,矩阵/n,，/w,然后/c,再/d,转置/nw,回/v, ,r/en, ,行/v, ,c/en, ,列/v, ,img/en, ,=/w, ,uint/en,8/m,(/w, ,255/m, ,*/w, ,(/w, ,disp/en, ,-/w, ,vmin/en, ,)/w, ,//w, ,(/w, ,vmax/en, ,-/w, ,vmin/en, ,)/w, ,)/w,;/w, ,mesh/en,(/w,disp/en,)/w,;/w, ,set/en,(/w,gca/en,,/w,'/w,ydir/en,'/w,,/w,'/w,reverse/en,'/w,)/w,;/w, ,%/w, ,通过/p, ,mesh/en, ,方式/n,绘图/vn,时/ng,，/w,需/v,倒置/v, ,y/en, ,轴/q,方向/n, ,axis/en, ,tight/en,;/w, ,%/w, ,使/v,坐标轴/n,显示/v,范围/n,与/p,数据/n,范围/n,相/d,贴合/nz,，/w,去除/v,空白/n,显示区/ns,显示/v,效果/n,如下/v,：/w,sgbm/en,算法/n,原理/n,emi/en,-/w,global/en, ,matching/en,（/w,缩写/n,sgm/en,）/w,是/v,一种/mq,用于/v,计算/v,双目/n,视觉/n,中/f,disparity/en,的/u,半/m,全局/n,匹配/vn,算法/n,。/w,在/p,opencv/en,中/f,的/u,实现/v,为/p,semi/en,-/w,global/en, ,block/en, ,matching/en,（/w,sgbm/en,）/w,。/w,sgbm/en,的/u,思路/n,是/v,：/w,通过/p,选取/v,每个/r,像素/n,点/q,的/u,disparity/en,，/w,组成/v,一个/m,disparity/en, ,map/en,，/w,设置/v,一个/m,和/c,disparity/en, ,map/en,相关/v,的/u,全局/n,能量/n,函数/n,，/w,使/v,这个/r,能量/n,函数/n,最小化/nw,，/w,以/p,达到/v,求解/v,每个/r,像素/n,最/d,优/ag,disparity/en,的/u,目的/n,。/w,能量/n,函数/n,形式/n,如下/v,：/w,d/en,指/v,disparity/en, ,map/en,。/w,e/en,(/w,d/en,)/w,是/v,该/r,disparity/en, ,map/en,对应/v,的/u,能量/n,函数/n,。/w,p/en,,/w, ,q/en,代表/n,图像/n,中/f,的/u,某个/r,像素/n,np/en, ,指/v,像素/n,p/en,的/u,相邻/v,像素/n,点/q,（/w,一般/a,认为/v,8/m,连通/v,）/w,c/en,(/w,p/en,,/w, ,dp/en,)/w,指/v,当前/t,像素/n,点/q,disparity/en,为/p,dp/en,时/ng,，/w,该/r,像素/n,点/q,的/u,costp/en,1/m, ,是/v,一个/m,惩罚/vn,系数/n,，/w,它/r,适用/v,于/p,像素/n,p/en,相邻/v,像素/n,中/f,dsparity/en,值/n,与/p,p/en,的/u,dsparity/en,值/n,相差/v,1/m,的/u,那些/r,像素/n,。/w,p/en,2/m, ,是/v,一个/m,惩罚/vn,系数/n,，/w,它/r,适用/v,于/p,像素/n,p/en,相邻/v,像素/n,中/f,dsparity/en,值/n,与/p,p/en,的/u,dsparity/en,值/n,相差/v,大于/v,1/m,的/u,那些/r,像素/n,。/w,i/en,[/w,./w,]/w,函数/n,返回/v,1/m,如果/c,函数/n,中/f,的/u,参数/n,为/p,真/d,，/w,否则/c,返回/v,0/m,利用/v,上述/b,函数/n,在/p,一个/m,二维/nr,图像/n,中/f,寻找/v,最/d,优解/nw,是/v,一个/m,np/en,-/w,complete/en,问题/n,，/w,耗时/v,过于/d,巨大/a,，/w,因此/c,该/r,问题/n,被/p,近似/a,分解/v,为/p,多/a,个/q,一维/nw,问题/n,，/w,即/v,线性/n,问题/n,。/w,而且/c,每个/r,一维/nw,问题/n,都/d,可以/v,用/p,动态/n,规划/n,来/v,解决/v,。/w,因为/c,1个/m,像/v,素有/v,8个/m,相邻/v,像素/n,，/w,因此/c,一般/a,分解/v,为/p,8个/m,一维/nw,问题/n,。/w,考虑/v,从/p,左/f,到/v,右/f,这/r,一/m,方向/n,，/w,如/v,下/f,图/n,所/u,示/vg,：/w,则/d,每个/r,像素/n,的/u,disparity/en,只/d,和/c,其/r,左边/f,的/u,像素/n,相关/v,，/w,有/v,如下/v,公式/n,：/w,r/en,指/v,某个/r,指向/vn,当前/t,像素/n,p/en,的/u,方向/n,，/w,在/p,此/r,可以/v,理解/v,为/p,像素/n,p/en,左边/f,的/u,相邻/v,像素/n,。/w,lr/en,(/w,p/en,,/w, ,d/en,)/w, ,表示/v,沿着/p,当前/t,方向/n,（/w,即/v,从/p,左/f,向/p,右/f,）/w,，/w,当/p,目前/t,像素/n,p/en,的/u,disparity/en,取值/v,为/p,d/en,时/ng,，/w,其/r,最小/a,cost/en,值/n,。/w,这个/r,最小值/nz,是/v,从/p,4种/mq,可能/v,的/u,候选值/nw,中/f,选取/v,的/u,最小值/nz,：/w,1/m,./w,前/f,一个/m,像素/n,（/w,左/f,相邻/v,像素/n,）/w,disparity/en,取值/v,为/p,d/en,时/ng,，/w,其/r,最/d,小/a,的/u,cost/en,值/n,。/w,2/m,./w,前/f,一个/m,像素/n,（/w,左/f,相邻/v,像素/n,）/w,disparity/en,取值/v,为/p,d/en,-/w,1时/t,，/w,其/r,最/d,小/a,的/u,cost/en,值/n,+/w,惩罚/vn,系数/n,p/en,1/m,。/w,3/m,./w,前/f,一个/m,像素/n,（/w,左/f,相邻/v,像素/n,）/w,disparity/en,取值/v,为/p,d/en,+/w,1时/t,，/w,其/r,最/d,小/a,的/u,cost/en,值/n,+/w,惩罚/vn,系数/n,p/en,1/m,。/w,4/m,./w,前/f,一个/m,像素/n,（/w,左/f,相邻/v,像素/n,）/w,disparity/en,取值/v,为/p,其他/r,时/ng,，/w,其/r,最/d,小/a,的/u,cost/en,值/n,+/w,惩罚/vn,系数/n,p/en,2/m,。/w,另外/c,，/w,当前/t,像素/n,p/en,的/u,cost/en,值/n,还/d,需要/v,减去/v,前/f,一个/m,像素/n,取/v,不同/a,disparity/en,值/n,时/ng,最/d,小/a,的/u,cost/en,。/w,这/r,是因为/c,lr/en,(/w,p/en,,/w, ,d/en,)/w,是/v,会/v,随着/p,当前/t,像素/n,的/u,右/f,移/v,不/d,停/v,增长/v,的/u,，/w,为了/p,防止/v,数值/n,溢/v,出/v,，/w,所以/c,要/v,让/v,它/r,维持/v,在/p,一个/m,较/d,小/a,的/u,数值/n,。/w,c/en,(/w,p/en,,/w, ,d/en,)/w,的/u,计算/v,很/d,简单/a,，/w,由/p,如下/v,两个/m,公式/n,计算/v,：/w,即/v,，/w,当前/t,像素/n,p/en,和/c,移动/vn,d/en,之后/f,的/u,像素/n,q/en,之间/f,，/w,经过/p,半/m,个/q,像素/n,插值/nw,后/f,，/w,寻找/v,两个/m,像素/n,点/q,灰度/n,或者/c,rgb/en,差值/n,的/u,最小值/nz,，/w,作为/v,c/en,(/w,p/en,,/w, ,d/en,)/w,的/u,值/n,。/w,具体来说/nw,：/w,设/v,像素/n,p/en,的/u,灰度/n,//w,rgb/en,值/n,为/p,i/en,(/w,p/en,)/w,，/w,先/d,从/p,i/en,(/w,p/en,)/w,，/w,(/w,i/en,(/w,p/en,)/w,+/w,i/en,(/w,p/en,-/w,1/m,)/w,)/w,//w,2/m,,/w,(/w,i/en,(/w,p/en,)/w,+/w,i/en,(/w,p/en,+/w,1/m,)/w,)/w,//w,2/m,三个/m,值/n,中/f,选择/v,出/v,和/c,i/en,(/w,q/en,)/w,差值/n,最/d,小/a,的/u,,/w,即/v,d/en,(/w,p/en,,/w,p/en,-/w,d/en,)/w,。/w,然后/c,再/d,从/p,i/en,(/w,q/en,)/w,，/w,(/w,i/en,(/w,q/en,)/w,+/w,i/en,(/w,q/en,-/w,1/m,)/w,)/w,//w,2/m,,/w,(/w,i/en,(/w,q/en,)/w,+/w,i/en,(/w,q/en,+/w,1/m,)/w,)/w,//w,2/m,三个/m,值/n,中/f,选择/v,出/v,和/c,i/en,(/w,p/en,)/w,差值/n,最/d,小/a,的/u,,/w,即/v,d/en,(/w,p/en,-/w,d/en,,/w,p/en,)/w,。/w,最后/f,从/p,两个/m,值/n,中/f,选取/v,最小值/nz,，/w,就是/d,c/en,(/w,p/en,,/w, ,d/en,)/w,上面/f,是/v,从/p,一个/m,方向/n,（/w,从/p,左/f,至/p,右/f,）/w,计算/v,出/v,的/u,像素/n,在/p,取值/v,为/p,某/r,一/m,disparity/en,值/n,时/ng,的/u,最小/a,cost/en,值/n,。/w,但是/c,一个/m,像/v,素有/v,8个/m,邻域/nw,，/w,所以/c,一共/d,要/v,从/p,8个/m,方向/n,计算/v,（