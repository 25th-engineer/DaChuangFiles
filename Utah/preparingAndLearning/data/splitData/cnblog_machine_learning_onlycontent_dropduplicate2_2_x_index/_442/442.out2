在用/b,pmml/en,实现/v,机器/n,学习/v,模型/n,的/u,跨/v,平台/n,上/f,线/n,中/f,，/w,我们/r,讨论/v,了/u,使用/v,pmml/en,文件/n,来/v,实现/v,跨/v,平台/n,模型/n,上线/n,的/u,方法/n,，/w,这个/r,方法/n,当然/d,也/d,适用/v,于/p,tensorflow/en,生成/vn,的/u,模型/n,，/w,但是/c,由于/c,tensorflow/en,模型/n,往往/d,较/d,大/a,，/w,使用/v,无法/v,优化/v,的/u,pmml/en,文件/n,大多数/m,时候/n,很/d,笨拙/a,，/w,因此/c,本文/r,我们/r,专门/d,讨论/v,下/f,tensorflow/en,机器/n,学习/v,模型/n,的/u,跨/v,平台/n,上/f,线/n,的/u,方法/n,。/w,1/m,./w, ,tensorflow/en,模型/n,的/u,跨/v,平台/n,上/f,线/n,的/u,备选/nz,方案/n,tensorflow/en,模型/n,的/u,跨/v,平台/n,上/f,线/n,的/u,备选/nz,方案/n,一般/a,有/v,三种/mq,：/w,即/v,pmml/en,方式/n,，/w,tensorflow/en, ,serving/en,方式/n,，/w,以及/c,跨/v,语言/n,api/en,方式/n,。/w,pmml/en,方式/n,的/u,主要/b,思路/n,在/p,上/f,一篇/mq,以及/c,讲/v,过/u,。/w,这里/r,唯一/b,的/u,区别/n,是/v,转化/v,生成/vn,pmml/en,文件/n,需要/v,用/p,一个/m,java/en,库/n,jpmml/en,-/w,tensorflow/en,来/v,完成/v,，/w,生成/vn,pmml/en,文件/n,后/f,，/w,跨/v,语言/n,加载/v,模型/n,和/c,其他/r,pmml/en,模型/n,文件/n,基本/a,类似/v,。/w,tensorflow/en, ,serving/en,是/v,tensorflow/en, ,官方/n,推荐/v,的/u,模型/n,上线/n,预测/v,方式/n,，/w,它/r,需要/v,一个/m,专门/d,的/u,tensorflow/en,服务器/n,，/w,用/p,来/v,提供/v,预测/v,的/u,api/en,服务/vn,。/w,如果/c,你/r,的/u,模型/n,和/c,对应/v,的/u,应用/vn,是/v,比较/d,大/a,规模/n,的/u,，/w,那么/r,使用/v,tensorflow/en, ,serving/en,是/v,比较/d,好/a,的/u,使用/v,方式/n,。/w,但是/c,它/r,也/d,有/v,一个/m,缺点/n,，/w,就/d,是/v,比较/d,笨重/a,，/w,如果/c,你/r,要/v,使用/v,tensorflow/en, ,serving/en,，/w,那么/r,需要/v,自己/r,搭建/v,serving/en,集群/nz,并/c,维护/v,这个/r,集群/nz,。/w,所以/c,为了/p,一个/m,小/a,的/u,应用/vn,去/v,做/v,这个/r,工作/vn,，/w,有时候/d,会/v,觉得/v,麻烦/an,。/w,跨/v,语言/n,api/en,方式/n,是/v,本文/r,要/v,讨论/v,的/u,方式/n,，/w,它/r,会/v,用/p,tensorflow/en,自己/r,的/u,python/en, ,api/en,生成/vn,模型/n,文件/n,，/w,然后/c,用/p,tensorflow/en,的/u,客户/n,端库/nr,比如/v,java/en,或/c,c/en,+/w,+/w,库来/nrf,做/v,模型/n,的/u,在线/vn,预测/v,。/w,下面/f,我们/r,会/v,给/p,一个/m,生成/vn,生成/vn,模型/n,文件/n,并/c,用/p,tensorflow/en, ,java/en, ,api/en,来/v,做/v,在线/vn,预测/v,的/u,例子/n,。/w,2/m,./w, ,训练/vn,模型/n,并/c,生成/vn,模型/n,文件/n,我们/r,这里/r,给/p,一个/m,简单/a,的/u,逻辑/n,回归/v,并/c,生成/vn,逻辑/n,回归/v,tensorflow/en,模型/n,文件/n,的/u,例子/n,。/w,完整/a,代码/n,参见/v,我/r,的/u,github/en,:/w,https/en,:/w,//w,//w,github/en,./w,com/en,//w,ljpzzz/en,//w,machinelearning/en,//w,blob/en,//w,master/en,//w,model/en,-/w,in/en,-/w,product/en,//w,tensorflow/en,-/w,java/en,首先/d,，/w,我们/r,生成/vn,了/u,一个/m,6/m,特征/n,，/w,3/m,分类/vn,输出/v,的/u,4000个/m,样本/n,数据/n,。/w,import/en, ,numpy/en, ,as/en, ,np/en, ,import/en, ,matplotlib/en,./w,pyplot/en, ,as/en, ,plt/en, ,%/w,matplotlib/en, ,inline/en, ,from/en, ,sklearn/en,./w,datasets/en,./w,samples/en,_,generator/en, ,import/en, ,make/en,_,classification/en, ,import/en, ,tensorflow/en, ,as/en, ,tf/en, ,x/en,1/m,,/w, ,y/en,1/m, ,=/w, ,make/en,_,classification/en,(/w,n/en,_,samples/en,=/w,4000/m,,/w, ,n/en,_,features/en,=/w,6/m,,/w, ,n/en,_,redundant/en,=/w,0/m,,/w, ,n/en,_,clusters/en,_,per/en,_,class/en,=/w,1/m,,/w, ,n/en,_,classes/en,=/w,3/m,)/w,接着/c,我们/r,构建/v,tensorflow/en,的/u,数据流/n,图/n,，/w,这里/r,要/v,注意/v,里面/f,的/u,两个/m,名字/n,，/w,第一/m,个/q,是/v,输入/v,x/en,的/u,名字/n,input/en,,/w,第二/m,个/q,是/v,输出/v,prediction/en,_,labels/en,的/u,名字/n,output/en,，/w,这里/r,的/u,这/r,两个/m,名字/n,可以/v,自己/r,取/v,，/w,但是/c,后面/f,会/v,用/p,到/v,，/w,所以/c,要/v,保持/v,一致/a,。/w,learning/en,_,rate/en, ,=/w, ,0.01/m, ,training/en,_,epochs/en, ,=/w, ,600/m, ,batch/en,_,size/en, ,=/w, ,100/m, ,x/en, ,=/w, ,tf/en,./w,placeholder/en,(/w,tf/en,./w,float/en,32/m,,/w, ,[/w,none/en,,/w, ,6/m,]/w,,/w,name/en,=/w,'/w,input/en,'/w,)/w, ,#, ,6/m, ,features/en, ,y/en, ,=/w, ,tf/en,./w,placeholder/en,(/w,tf/en,./w,float/en,32/m,,/w, ,[/w,none/en,,/w, ,3/m,]/w,)/w, ,#, ,3/m, ,classes/en, ,w/en, ,=/w, ,tf/en,./w,variable/en,(/w,tf/en,./w,zeros/en,(/w,[/w,6/m,,/w, ,3/m,]/w,)/w,)/w, ,b/en, ,=/w, ,tf/en,./w,variable/en,(/w,tf/en,./w,zeros/en,(/w,[/w,3/m,]/w,)/w,)/w, ,#, ,softmax/en,回归/v, ,pred/en, ,=/w, ,tf/en,./w,nn/en,./w,softmax/en,(/w,tf/en,./w,matmul/en,(/w,x/en,,/w, ,w/en,)/w, ,+/w, ,b/en,,/w, ,name/en,=/w,"/w,softmax/en,"/w,)/w, ,cost/en, ,=/w, ,tf/en,./w,reduce/en,_,mean/en,(/w,-/w,tf/en,./w,reduce/en,_,sum/en,(/w,y/en,*/w,tf/en,./w,log/en,(/w,pred/en,)/w,,/w, ,reduction/en,_,indices/en,=/w,1/m,)/w,)/w, ,optimizer/en, ,=/w, ,tf/en,./w,train/en,./w,gradientdescentoptimizer/en,(/w,learning/en,_,rate/en,)/w,./w,minimize/en,(/w,cost/en,)/w, ,prediction/en,_,labels/en, ,=/w, ,tf/en,./w,argmax/en,(/w,pred/en,,/w, ,axis/en,=/w,1/m,,/w, ,name/en,=/w,"/w,output/en,"/w,)/w, ,init/en, ,=/w, ,tf/en,./w,global/en,_,variables/en,_,initializer/en,(/w,)/w,接着/c,就/d,是/v,训练/vn,模型/n,了/u,，/w,代码/n,比较/d,简单/a,，/w,毕竟/d,只/d,是/v,一个/m,演示/vn,：/w,sess/en, ,=/w, ,tf/en,./w,session/en,(/w,)/w, ,sess/en,./w,run/en,(/w,init/en,)/w, ,y/en,2/m, ,=/w, ,tf/en,./w,one/en,_,hot/en,(/w,y/en,1/m,,/w, ,3/m,)/w, ,y/en,2/m, ,=/w, ,sess/en,./w,run/en,(/w,y/en,2/m,)/w, ,for/en, ,epoch/en, ,in/en, ,range/en,(/w,training/en,_,epochs/en,)/w,:/w, ,_,,/w, ,c/en, ,=/w, ,sess/en,./w,run/en,(/w,[/w,optimizer/en,,/w, ,cost/en,]/w,,/w, ,feed/en,_,dict/en,=/w,{/w,x/en,:/w, ,x/en,1/m,,/w, ,y/en,:/w, ,y/en,2/m,}/w,)/w, ,if/en, ,(/w,epoch/en,+/w,1/m,)/w, ,%/w, ,10/m, ,=/w,=/w, ,0/m,:/w, ,print/en, ,(/w,"/w,epoch/en,:/w,"/w,,/w, ,'/w,%/w,04/m,d/en,'/w, ,%/w, ,(/w,epoch/en,+/w,1/m,)/w,,/w, ,"/w,cost/en,=/w,"/w,,/w, ,"/w,{/w,:/w,./w,9/m,f/en,}/w,"/w,./w,format/en,(/w,c/en,)/w,)/w, ,print/en, ,(/w,"/w,优化/v,完毕/v,!/w,"/w,)/w, ,correct/en,_,prediction/en, ,=/w, ,tf/en,./w,equal/en,(/w,tf/en,./w,argmax/en,(/w,pred/en,,/w, ,1/m,)/w,,/w, ,tf/en,./w,argmax/en,(/w,y/en,2/m,,/w, ,1/m,)/w,)/w, ,accuracy/en, ,=/w, ,tf/en,./w,reduce/en,_,mean/en,(/w,tf/en,./w,cast/en,(/w,correct/en,_,prediction/en,,/w, ,tf/en,./w,float/en,32/m,)/w,)/w, ,acc/en, ,=/w, ,sess/en,./w,run/en,(/w,accuracy/en,,/w, ,feed/en,_,dict/en,=/w,{/w,x/en,:/w, ,x/en,1/m,,/w, ,y/en,:/w, ,y/en,2/m,}/w,)/w, ,print/en, ,(/w,acc/en,)/w,打印/v,输出/v,我/r,这里/r,就/d,不/d,写/v,了/u,，/w,大家/r,可以/v,自己/r,去/v,试/v,一/m,试/v,。/w,接着/c,就/d,是/v,关键/n,的/u,一步/mq,，/w,存/v,模型/n,文件/n,了/u,，/w,注意/v,要/v,用/p,convert/en,_,variables/en,_,to/en,_,constants/en,这个/r,api/en,来/v,保存/v,模型/n,，/w,否则/c,模型/n,参数/n,不/d,会/v,随着/p,模型/n,图/n,一起/s,存/v,下来/v,。/w,graph/en, ,=/w, ,tf/en,./w,graph/en,_,util/en,./w,convert/en,_,variables/en,_,to/en,_,constants/en,(/w,sess/en,,/w, ,sess/en,./w,graph/en,_,def/en,,/w, ,[/w,"/w,output/en,"/w,]/w,)/w, ,tf/en,./w,train/en,./w,write/en,_,graph/en,(/w,graph/en,,/w, ,'/w,./w,'/w,,/w, ,'/w,rf/en,./w,pb/en,'/w,,/w, ,as/en,_,text/en,=/w,false/en,)/w,至此/d,，/w,我们/r,的/u,模型/n,文件/n,rf/en,./w,pb/en,已经/d,被/p,保存/v,下来/v,了/u,，/w,下面/f,就/d,是/v,要/v,跨/v,平台/n,上/f,线/n,了/u,。/w,3/m,./w, ,模型/n,文件/n,在/p,java/en,平台/n,上/f,线/n,这里/r,我们/r,以/p,java/en,平台/n,的/u,模型/n,上线/n,为/p,例/n,，/w,c/en,+/w,+/w,的/u,api/en,上/f,线/n,我/r,没有/v,用/p,过/u,，/w,这里/r,就/d,不/d,写/v,了/u,。/w,我们/r,需要/v,引入/v,tensorflow/en,的/u,java/en,库/n,到/v,我们/r,工程/n,的/u,maven/en,或者/c,gradle/en,文件/n,。/w,这里/r,给/p,出/v,maven/en,的/u,依赖/v,如下/v,，/w,版本/n,可以/v,根据/p,实际/n,情况/n,选择/v,一个/m,较/d,新/a,的/u,版本/n,。/w,</w,dependency/en,>, ,</w,groupid/en,>,org/en,./w,tensorflow/en,</w,//w,groupid/en,>, ,</w,artifactid/en,>,tensorflow/en,</w,//w,artifactid/en,>, ,</w,version/en,>,1/m,./w,7/m,./w,0/m,</w,//w,version/en,>, ,</w,//w,dependency/en,>,接着/c,就/d,是/v,代码/n,了/u,，/w,这个/r,代码/n,会/v,比/p,jpmml/en,的/u,要/v,简单/a,，/w,我/r,给/p,出/v,了/u,4个/m,测试/vn,样本/n,的/u,预测/v,例子/n,如下/v,，/w,一定/d,要/v,注意/v,的/u,是/v,里面/f,的/u,input/en,和/c,output/en,要/v,和/c,训练/vn,模型/n,的/u,时候/n,对应/v,的/u,节点/n,名字/n,一致/a,。/w,import/en, ,org/en,./w,tensorflow/en,./w,*/w,;/w, ,import/en, ,org/en,./w,tensorflow/en,./w,graph/en,;/w, ,import/en, ,java/en,./w,io/en,./w,ioexception/en,;/w, ,import/en, ,java/en,./w,nio/en,./w,file/en,./w,files/en,;/w, ,import/en, ,java/en,./w,nio/en,./w,file/en,./w,paths/en,;/w, ,//w,*/w,*/w, ,*/w, ,created/en, ,by/en, ,刘建平/nr,pinard/en, ,on/en, ,2018/m,//w,7/m,//w,1/m,./w, ,*/w,//w, ,public/en, ,class/en, ,tfjavademo/en, ,{/w, ,public/en, ,static/en, ,void/en, ,main/en,(/w,string/en, ,args/en,[/w,]/w,)/w,{/w, ,byte/en,[/w,]/w, ,graphdef/en, ,=/w, ,loadtensorflowmodel/en,(/w,"/w,d/en,:/w,//w,rf/en,./w,pb/en,"/w,)/w,;/w, ,float/en, ,inputs/en,[/w,]/w,[/w,]/w, ,=/w, ,new/en, ,float/en,[/w,4/m,]/w,[/w,6/m,]/w,;/w, ,for/en,(/w,int/en, ,i/en, ,=/w, ,0/m,;/w, ,i/en,</w, ,4/m,;/w, ,i/en,+/w,+/w,)/w,{/w, ,for/en,(/w,int/en, ,j/en, ,=/w,0/m,;/w, ,j/en,</w, ,6/m,;/w,j/en,+/w,+/w,)/w,{/w, ,if/en,(/w,i/en,</w,2/m,)/w, ,{/w, ,inputs/en,[/w,i/en,]/w,[/w,j/en,]/w, ,=/w, ,2/m, ,*/w, ,i/en, ,-/w, ,5/m, ,*/w, ,j/en, ,-/w, ,6/m,;/w, ,}/w, ,else/e