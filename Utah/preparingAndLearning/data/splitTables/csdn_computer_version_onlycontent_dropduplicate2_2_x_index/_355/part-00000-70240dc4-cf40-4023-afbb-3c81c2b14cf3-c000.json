{"content2":"计算机视觉—卡尔曼滤波\nbrycezou@163.com\n整篇文章参考微信公众号【电子搬砖师】，有兴趣的读者可以关注一下，感谢作者！\n最近发现，只有理论推导而没有贴实用代码的博客阅读量都比较少，由此可见，技术博客也是快餐文化的一种。本人后面的博客尽量也贴一些典型代码，来满足更读者的胃口。卡尔曼滤波算法相关的代码后续补上\\^_\\^\n0、卡尔曼滤波的核心内容\n假设测量值和估计值都不是100%可信的，通过如下两步主要操作来估计真实值\n根据前一时刻的最优估计\nx(k−1|k−1)\nx(k-1|k-1) 得到当前时刻的普通估计\nx(k|k−1)\nx(k|k-1)\n根据当前时刻的普通估计\nx(k|k−1)\nx(k|k-1) 和当前时刻的观测\nz(k)\nz(k)，得到当前时刻的最优估计\nx(k|k)\nx(k|k)\n1、问题描述\n假设我们要测量房间的温度，用温度计进行了10分钟的测量，每隔1分钟测量一次，这10次的测量结果如下。我们还明白一个事实：由于测量设备（温度计）自身存在误差，测量过程也会引入干扰，因此，工程上通常不能直接使用测量设备的数据，而是先要对数据进行处理。那么问题来了，该如何进行处理？\n25.3 26.5 24.0 35.0（温度计受到干扰） 22.9 25.6 23.5（开启暖气） 28.8 30.2 29.5\n2、方案一：均值滤波\n均值滤波可简单描述为：连续采样 N 次，求均值后输出一次，再连续采样 N 次，求均值后输出一次，如此反复。对温度测量过程进行均值滤波，取 N=5，结果为：\nT1=(25.3+26.5+24.0+35.0+22.9)/5=26.7 T2=(25.6+23.5+28.8+30.2+29.5)/5=27.5\n均值滤波确实减缓了数据的跳变，但其更新频率太低，而且真实的变化过程（开启暖气）容易被淹没。\n3、方案二：一阶滞后滤波\n为了提高更新频率，同时避免淹没真实的变化过程，可以采用一阶滞后滤波算法，\n本次滤波结果=α∗本次采样值+(1−α)∗上次滤波结果\n本次滤波结果=\\alpha*本次采样值+(1-\\alpha)*上次滤波结果\n公式中的\nα\n\\alpha 表示对本次采样值的信任程度。设\nα=0.6\n\\alpha=0.6，由于第1分钟时没有上次滤波结果，可以根据经验初始化为26.0，则结果为：\n0.6*25.3+0.4*26.0=25.6 0.6*26.5+0.4*25.6=26.1 0.6*24.0+0.4*26.1=24.8 0.6*35.0+0.4*24.8=30.9 0.6*22.9+0.4*30.9=26.1 0.6*25.6+0.4*26.1=25.8 0.6*23.5+0.4*25.8=24.4 0.6*28.8+0.4*24.4=27.0 0.6*30.2+0.4*27.0=28.9 0.6*29.5+0.4*25.6=29.3\n一阶滞后滤波算法既减缓了温度的跳变，又提高了更新频率。但是它仍然没能排除掉干扰，而且在房间开启暖气后温度变化有点滞后。\n4、方案三：卡尔曼滤波\n一阶滞后滤波算法的权重\nα\n\\alpha 在计算过程中是保持不变的，而卡尔曼滤波算法的核心在于，可以根据测量值的变化实时更新权重。使用卡尔曼滤波需要知道的几个初始条件：\n原始值：用于启动迭代，通常取传感器前 N 组测量数据的均值。本例中，原始温度取26.0度。\n原始值误差：原始值通常是根据经验得到的，存在误差。本例中，假定原始温度误差是2度。\n测量系统误差：假定温度计的测量误差为是3度。\n下一次的最大偏差：由于房间温度相对恒定，即使开启暖气下一次最多也只能变化5度。\n使用卡尔曼滤波算法进行迭代：首先，用26.0作为原始温度，由于认为房间温度恒定，因此下一分钟的估计温度也是26.0度。其次，下一分钟的测量温度是25.3度。此时，我们有两个可以参考的温度值，26.0度和25.3度，究竟该如何权衡？定义测量值的信任比例为\nkg=原始值误差2+下一次的最大偏差2原始值误差2+下一次的最大偏差2+测量系统误差2‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾⎷\nkg=\\sqrt{\\frac{原始值误差^2+下一次的最大偏差^2}{原始值误差^2+下一次的最大偏差^2+测量系统误差^2}}\n代入本例中可得，测量值25.3的信任比例为\nkg=22+5222+52+32‾‾‾‾‾‾‾‾‾‾‾‾‾√=0.874\nkg=\\sqrt{\\frac{2^2+5^2}{2^2+5^2+3^2}}=0.874\n因此，第一分钟的最优温度估计为\nT1=26.0*(1-0.874)+25.3*0.874=25.4\n这个25.4度将会成为下一轮迭代的原始值。此外，由于卡尔曼滤波的结果更加接近真实世界的数值，因此下一轮迭代的原始值误差也会被更新\n下一轮原始值误差=(1−kg)∗(本轮原始值误差2+下一次的最大偏差2)‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾√\n下一轮原始值误差=\\sqrt{(1-kg)*(本轮原始值误差^2+下一次的最大偏差^2)}\n代入本例中可得\n原始值误差=(1−0.874)∗(22+52)‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾√=1.9\n原始值误差=\\sqrt{(1-0.874)*(2^2+5^2)}=1.9\n下面进行第二轮迭代。首先，计算测量值26.5的信任比例\nkg=1.92+521.92+52+32‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾√=0.872\nkg=\\sqrt{\\frac{1.9^2+5^2}{1.9^2+5^2+3^2}}=0.872\n其次，计算第二分钟的最优温度估计\nT2=25.4*(1-0.872)+26.5*0.872=26.4\n最后，更新下一轮迭代的原始值误差\n原始值误差=(1−0.872)∗(1.92+52)‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾√=1.9\n原始值误差=\\sqrt{(1-0.872)*(1.9^2+5^2)}=1.9\n之后进行第三轮迭代\n⋯\n\\cdots\n卡尔曼滤波经过多次迭代后会逐渐缩小原始值误差，输出结果也更加接近真实值。如果将本例中的下一次最大偏差从5度改为2度，那么传感器测量值的信任比例将会变小，滤波器输出的温度值跳动也会变小，对干扰的抑制作用会更加明显，但对于真实环境的响应也会变得更加滞后。\n5、单变量形式推导\n参考：http://www.tina-vision.net/docs/memos/2003-003.pdf\n设温度的估计值服从正态分布\nf(x)=12πσ2估‾‾‾‾‾√exp⎛⎝⎜⎜−(x−μ估)22σ2估⎞⎠⎟⎟\nf(x)=\\frac{1}{\\sqrt{2\\pi\\sigma_估^2}}\\exp\\left(-\\frac{(x-\\mu_估)^2}{2\\sigma_估^2}\\right)\n设温度的测量值也服从正态分布\ng(x)=12πσ2测‾‾‾‾‾√exp⎛⎝⎜⎜−(x−μ测)22σ2测⎞⎠⎟⎟\ng(x)=\\frac{1}{\\sqrt{2\\pi\\sigma_测^2}}\\exp\\left(-\\frac{(x-\\mu_测)^2}{2\\sigma_测^2}\\right)\n融合两个正态分布，可得\nh(x)=f(x)g(x)=12πσ测σ估exp⎛⎝⎜⎜−(x−μ测)22σ2测−(x−μ估)22σ2估⎞⎠⎟⎟\nh(x)=f(x)g(x)=\\frac{1}{2\\pi\\sigma_测\\sigma_估}\\exp\\left(-\\frac{(x-\\mu_测)^2}{2\\sigma_测^2}-\\frac{(x-\\mu_估)^2}{2\\sigma_估^2}\\right)\n令指数部分\nβ=(x−μ测)22σ2测+(x−μ估)22σ2估=(σ2测+σ2估)x2−2(μ测σ2估+μ估σ2测)x+μ2测σ2估+μ2估σ2测2σ2测σ2估\n\\beta=\\frac{(x-\\mu_测)^2}{2\\sigma_测^2}+\\frac{(x-\\mu_估)^2}{2\\sigma_估^2}= \\frac{(\\sigma_测^2+\\sigma_估^2)x^2-2(\\mu_测\\sigma_估^2+\\mu_估\\sigma_测^2)x+\\mu_测^2\\sigma_估^2+\\mu_估^2\\sigma_测^2}{2\\sigma_测^2\\sigma_估^2}\\\\\n化简可得\nβ=(x−μ测σ2估+μ估σ2测σ2测+σ2估)22σ2测σ2估σ2测+σ2估+(μ测−μ估)22(σ2测+σ2估)\n\\beta=\\frac{\\left(x-\\frac{\\mu_测\\sigma_估^2+\\mu_估\\sigma_测^2}{\\sigma_测^2+\\sigma_估^2}\\right)^2}{2\\frac{\\sigma_测^2\\sigma_估^2}{\\sigma_测^2+\\sigma_估^2}}+\\frac{(\\mu_测-\\mu_估)^2}{2(\\sigma_测^2+\\sigma_估^2)}\n于是，两个正态分布的乘积也服从正态分布\nμ新=μ测σ2估+μ估σ2测σ2测+σ2估=kg∗μ测+(1−kg)∗μ估σ新=σ2测σ2估σ2测+σ2估‾‾‾‾‾‾‾‾‾⎷=(1−kg)∗σ2估‾‾‾‾‾‾‾‾‾‾‾‾‾√\n\\mu_新=\\frac{\\mu_测\\sigma_估^2+\\mu_估\\sigma_测^2}{\\sigma_测^2+\\sigma_估^2}=kg*\\mu_测+(1-kg)*\\mu_估\\\\ \\sigma_新=\\sqrt{\\frac{\\sigma_测^2\\sigma_估^2}{\\sigma_测^2+\\sigma_估^2}}=\\sqrt{(1-kg)*\\sigma_估^2}\n其中，\nkg\nkg 就是前文提到的信任比例，即卡尔曼增益\nkg=σ2估σ2测+σ2估\nkg=\\frac{\\sigma_估^2}{\\sigma_测^2+\\sigma_估^2}\n6、矩阵形式推导\n卡尔曼滤波其实就5个公式\nX(k|k−1)=AX(k−1|k−1)+BU(k−1)P(k|k−1)=AP(k−1|k−1)AT+QKg(k)=P(k|k−1)HT[HP(k|k−1)HT+R]−1X(k|k)=X(k|k−1)+Kg(k)[Z(k)−HX(k|k−1)]P(k|k)=[I−Kg(k)H]P(k|k−1)\n\\begin{eqnarray*} & & X(k|k-1)=AX(k-1|k-1)+BU(k-1)\\\\ & & P(k|k-1)=AP(k-1|k-1)A^T+Q\\\\ & & Kg(k)=P(k|k-1)H^T[HP(k|k-1)H^T+R]^{-1}\\\\ & & X(k|k)=X(k|k-1)+Kg(k)[Z(k)-HX(k|k-1)]\\\\ & & P(k|k)=[I-Kg(k)H]P(k|k-1) \\end{eqnarray*}\n其中，\nX(k−1|k−1)\nX(k-1|k-1) 是上一时刻的最优估计；\nX(k|k−1)\nX(k|k-1) 是当前时刻的基本估计，由上一时刻的最优估计得来；\nA\nA 是状态转移矩阵；\nB\nB 是控制量矩阵；\nU(k−1)\nU(k-1) 是上一时刻的控制量。\n6.1 第二个公式\n设真实世界中，\nk\nk 时刻的状态为\nX(k)=AX(k−1)+BU(k−1)+W(k−1)\nX(k)=AX(k-1)+BU(k-1)+W(k-1)\n则\nk\nk 时刻的真实值\nX(k)\nX(k) 和基本估计\nX(k|k−1)\nX(k|k-1) 之间的误差为\ne(k|k−1)===X(k)−X(k|k−1)AX(k−1)+BU(k−1)+W(k−1)−[AX(k−1|k−1)+BU(k−1)]AX(k−1)−AX(k−1|k−1)+W(k−1)\n\\begin{eqnarray*} e(k|k-1) & = & X(k)-X(k|k-1)\\\\ & = & AX(k-1)+BU(k-1)+W(k-1)-[AX(k-1|k-1)+BU(k-1)]\\\\ & = & AX(k-1)-AX(k-1|k-1)+W(k-1) \\end{eqnarray*}\n该误差的方差为\nD[e(k|k−1)]======D[X(k)−X(k|k−1)]D[AX(k−1)−AX(k−1|k−1)+W(k−1)]D[AX(k−1)−AX(k−1|k−1)]+D[W(k−1)]+2cov(AX(k−1)−AX(k−1|k−1),W(k−1))D[AX(k−1)−AX(k−1|k−1)]+D[W(k−1)][AX(k−1)−AX(k−1|k−1)][AX(k−1)−AX(k−1|k−1)]T+W(k−1)W(k−1)TA[X(k−1)−X(k−1|k−1)][X(k−1)−X(k−1|k−1)]TAT+W(k−1)W(k−1)T\n\\begin{eqnarray*} D[e(k|k-1)] & = & D[X(k)-X(k|k-1)]\\\\ & = & D[AX(k-1)-AX(k-1|k-1)+W(k-1)]\\\\ & = & D[AX(k-1)-AX(k-1|k-1)]+D[W(k-1)]+2cov(AX(k-1)-AX(k-1|k-1),W(k-1))\\\\ & = & D[AX(k-1)-AX(k-1|k-1)]+D[W(k-1)]\\\\ & = & [AX(k-1)-AX(k-1|k-1)][AX(k-1)-AX(k-1|k-1)]^T+W(k-1)W(k-1)^T\\\\ & = & A[X(k-1)-X(k-1|k-1)][X(k-1)-X(k-1|k-1)]^TA^T+W(k-1)W(k-1)^T \\end{eqnarray*}\n在数学形式上有\nD[e(k−1|k−1)]=D[X(k−1)−X(k−1|k−1)]=[X(k−1)−X(k−1|k−1)][X(k−1)−X(k−1|k−1)]T\nD[e(k-1|k-1)]=D[X(k-1)-X(k-1|k-1)]=[X(k-1)-X(k-1|k-1)][X(k-1)-X(k-1|k-1)]^T\n因而\nD[e(k|k−1)]=AD[e(k−1|k−1)]AT+W(k−1)W(k−1)T\nD[e(k|k-1)]=AD[e(k-1|k-1)]A^T+W(k-1)W(k-1)^T\n令\nP(k|k−1)=D[e(k|k−1)]Q(k−1)=W(k−1)W(k−1)T\n\\begin{eqnarray*} & & P(k|k-1)=D[e(k|k-1)]\\\\ & & Q(k-1)=W(k-1)W(k-1)^T\\\\ \\end{eqnarray*}\n则\nP(k|k−1)=AP(k−1|k−1)AT+Q(k−1)\nP(k|k-1)=AP(k-1|k-1)A^T+Q(k-1)\n其中，\nP(k−1|k−1)\nP(k-1|k-1) 为\nk−1\nk-1 时刻的真实值\nX(k−1)\nX(k-1) 和最优估计\nX(k−1|k−1)\nX(k-1|k-1) 之间的\n误差的方差\n，卡尔曼滤波的本质就是减小误差的方差。\n6.2 第四个公式\n设当前时刻传感器的测量数据为\nZ(k)\nZ(k)，将其定义为\nZ(k)=HX(k)+V(k)\nZ(k)=HX(k)+V(k)\n需要说明的是，有时\nX(k)\nX(k) 中的部分数据是无法用传感器直接测量的，但这些数据又可以通过其它测量值推算出来，\nH\nH 矩阵就用来表示\nX(k)\nX(k) 中数据的可测量情况。\nV(k)\nV(k) 表示传感器的测量误差。至此，第四个公式便很容易理解：\n当前时刻的残差，乘以当前时刻的卡尔曼增益，再加上当前时刻的基本估计，便得到当前时刻的最优估计\n。最优估计其实是传感器测量值和基本估计的加权平均。\n6.3 第三个公式\n上文中提到，\nP(k|k−1)\nP(k|k-1) 是\nk\nk 时刻的真实值\nX(k)\nX(k) 和基本估计\nX(k|k−1)\nX(k|k-1) 之间的误差的方差。那么，\nP(k|k)\nP(k|k) 就是\nk\nk 时刻的真实值\nX(k)\nX(k) 和最优估计\nX(k|k)\nX(k|k) 之间的误差的方差，\nP(k|k)==============D[X(k)−X(k|k)]D{X(k)−X(k|k−1)−Kg(k)[Z(k)−HX(k|k−1)]}D{X(k)−X(k|k−1)−Kg(k)Z(k)+Kg(k)HX(k|k−1)}D{X(k)−X(k|k−1)−Kg(k)[HX(k)+V(k)]+Kg(k)HX(k|k−1)}D{X(k)−X(k|k−1)−Kg(k)HX(k)−Kg(k)V(k)+Kg(k)HX(k|k−1)}D{[I−Kg(k)H][X(k)−X(k|k−1)]−Kg(k)V(k)}D{[I−Kg(k)H][X(k)−X(k|k−1)]}+D{Kg(k)V(k)}+2cov(first,second)D{[I−Kg(k)H][X(k)−X(k|k−1)]}+D{Kg(k)V(k)}[I−Kg(k)H][X(k)−X(k|k−1)][X(k)−X(k|k−1)]T[I−Kg(k)H]T+Kg(k)V(k)V(k)TKg(k)T[I−Kg(k)H]P(k|k−1)[I−Kg(k)H]T+Kg(k)R(k)Kg(k)T[P(k|k−1)−Kg(k)HP(k|k−1)][I−Kg(k)H]T+Kg(k)R(k)Kg(k)TP(k|k−1)−P(k|k−1)HTKg(k)T−Kg(k)HP(k|k−1)+Kg(k)HP(k|k−1)HTKg(k)T+Kg(k)R(k)Kg(k)TP(k|k−1)−P(k|k−1)THTKg(k)T−Kg(k)HP(k|k−1)+Kg(k)[HP(k|k−1)HT+R(k)]Kg(k)TP(k|k−1)−[Kg(k)HP(k|k−1)]T−Kg(k)HP(k|k−1)+Kg(k)[HP(k|k−1)HT+R(k)]Kg(k)T\n\\begin{eqnarray*} P(k|k) & = & D[X(k)-X(k|k)]\\\\ & = & D\\{X(k)-X(k|k-1)-Kg(k)[Z(k)-HX(k|k-1)]\\}\\\\ & = & D\\{X(k)-X(k|k-1)-Kg(k)Z(k)+Kg(k)HX(k|k-1)\\}\\\\ & = & D\\{X(k)-X(k|k-1)-Kg(k)[HX(k)+V(k)]+Kg(k)HX(k|k-1)\\}\\\\ & = & D\\{X(k)-X(k|k-1)-Kg(k)HX(k)-Kg(k)V(k)+Kg(k)HX(k|k-1)\\}\\\\ & = & D\\{[I-Kg(k)H][X(k)-X(k|k-1)]-Kg(k)V(k)\\}\\\\ & = & D\\{[I-Kg(k)H][X(k)-X(k|k-1)]\\}+D\\{Kg(k)V(k)\\}+2cov(first,second)\\\\ & = & D\\{[I-Kg(k)H][X(k)-X(k|k-1)]\\}+D\\{Kg(k)V(k)\\}\\\\ & = & [I-Kg(k)H][X(k)-X(k|k-1)][X(k)-X(k|k-1)]^T[I-Kg(k)H]^T+Kg(k)V(k)V(k)^TKg(k)^T\\\\ & = & [I-Kg(k)H]P(k|k-1)[I-Kg(k)H]^T+Kg(k)R(k)Kg(k)^T\\\\ & = & [P(k|k-1)-Kg(k)HP(k|k-1)][I-Kg(k)H]^T+Kg(k)R(k)Kg(k)^T\\\\ & = & P(k|k-1)-P(k|k-1)H^TKg(k)^T-Kg(k)HP(k|k-1)+Kg(k)HP(k|k-1)H^TKg(k)^T+Kg(k)R(k)Kg(k)^T\\\\ & = & P(k|k-1)-P(k|k-1)^TH^TKg(k)^T-Kg(k)HP(k|k-1)+Kg(k)[HP(k|k-1)H^T+R(k)]Kg(k)^T\\\\ & = & P(k|k-1)-[Kg(k)HP(k|k-1)]^T-Kg(k)HP(k|k-1)+Kg(k)[HP(k|k-1)H^T+R(k)]Kg(k)^T\\\\ \\end{eqnarray*}\n其中\nR(k)=V(k)V(k)T\nR(k)=V(k)V(k)^T\n卡尔曼滤波本质上是一个不断减小（最优估计和真实值之间的）误差的方差的过程。\nP(k|k)\nP(k|k) 是误差的方差矩阵，其对角线元素就是各个状态变量的误差的方差，最小化各个方差就等价于最小化方差的和，也即最小化方差矩阵的迹\n∂tr{P(k|k)}∂Kg(k)======∂tr{P(k|k−1)}∂Kg(k)−∂tr{[Kg(k)HP(k|k−1)]T}∂Kg(k)−∂tr{Kg(k)HP(k|k−1)}∂Kg(k)+∂tr{Kg(k)[HP(k|k−1)HT+R(k)]Kg(k)T}∂Kg(k)0−[HP(k|k−1)T]T−[HP(k|k−1)]T+∂tr{Kg(k)[HP(k|k−1)HT+R(k)]Kg(k)T}∂Kg(k)−2P(k|k−1)HT+Kg(k)[HP(k|k−1)HT+R(k)]+Kg(k)[HP(k|k−1)HT+R(k)]T−2P(k|k−1)HT+Kg(k)[HP(k|k−1)HT+R(k)]+Kg(k)[HP(k|k−1)HT]T+Kg(k)R(k)T−2P(k|k−1)HT+Kg(k)[HP(k|k−1)HT+R(k)]+Kg(k)[HP(k|k−1)HT]+Kg(k)R(k)−2P(k|k−1)HT+2Kg(k)[HP(k|k−1)HT+R(k)]\n\\begin{eqnarray*} \\frac{\\partial tr\\{P(k|k)\\}}{\\partial Kg(k)} & = & \\frac{\\partial tr\\{P(k|k-1)\\}}{\\partial Kg(k)}- \\frac{\\partial tr\\{[Kg(k)HP(k|k-1)]^T\\}}{\\partial Kg(k)}- \\frac{\\partial tr\\{Kg(k)HP(k|k-1)\\}}{\\partial Kg(k)}+ \\frac{\\partial tr\\{Kg(k)[HP(k|k-1)H^T+R(k)]Kg(k)^T\\}}{\\partial Kg(k)}\\\\ & = & 0- [HP(k|k-1)^T]^T- [HP(k|k-1)]^T+ \\frac{\\partial tr\\{Kg(k)[HP(k|k-1)H^T+R(k)]Kg(k)^T\\}}{\\partial Kg(k)}\\\\ & = & -2P(k|k-1)H^T+Kg(k)[HP(k|k-1)H^T+R(k)]+Kg(k)[HP(k|k-1)H^T+R(k)]^T\\\\ & = & -2P(k|k-1)H^T+Kg(k)[HP(k|k-1)H^T+R(k)]+Kg(k)[HP(k|k-1)H^T]^T+Kg(k)R(k)^T\\\\ & = & -2P(k|k-1)H^T+Kg(k)[HP(k|k-1)H^T+R(k)]+Kg(k)[HP(k|k-1)H^T]+Kg(k)R(k)\\\\ & = & -2P(k|k-1)H^T+2Kg(k)[HP(k|k-1)H^T+R(k)]\\\\ \\end{eqnarray*}\n令\n∂tr{P(k|k)}∂Kg(k)=0\n\\frac{\\partial tr\\{P(k|k)\\}}{\\partial Kg(k)}=0\n可得\nKg(k)=P(k|k−1)HT[HP(k|k−1)HT+R(k)]−1\nKg(k)=P(k|k-1)H^T[HP(k|k-1)H^T+R(k)]^{-1}\n6.4 第五个公式\nP(k|k)=====D[X(k)−X(k|k)]⋯P(k|k−1)−P(k|k−1)THTKg(k)T−Kg(k)HP(k|k−1)+Kg(k)[HP(k|k−1)HT+R(k)]Kg(k)TP(k|k−1)−P(k|k−1)THTKg(k)T−Kg(k)HP(k|k−1)+P(k|k−1)HT[HP(k|k−1)HT+R(k)]−1[HP(k|k−1)HT+R(k)]Kg(k)T[I−Kg(k)H]P(k|k−1)\n\\begin{eqnarray*} P(k|k) & = & D[X(k)-X(k|k)]\\\\ & = & \\cdots\\\\ & = & P(k|k-1)-P(k|k-1)^TH^TKg(k)^T-Kg(k)HP(k|k-1)+Kg(k)[HP(k|k-1)H^T+R(k)]Kg(k)^T\\\\ & = & P(k|k-1)-P(k|k-1)^TH^TKg(k)^T-Kg(k)HP(k|k-1)+P(k|k-1)H^T[HP(k|k-1)H^T+R(k)]^{-1}[HP(k|k-1)H^T+R(k)]Kg(k)^T\\\\ & = & [I-Kg(k)H]P(k|k-1) \\end{eqnarray*}"}
